<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <title>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π JSON Comparator</title>
    <!-- AJV JSON Schema Validator - Latest Version with Additional Formats -->
    <!-- üéØ AJV v8.17.1: Core JSON Schema validation with Draft 4, 6, 7, 2019-09, 2020-12 support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.17.1/ajv.min.js" onerror="loadAjvFallback()"></script>
    <!-- üìß AJV Formats: email, date, time, uri, uuid, regex and other format validators -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv-formats/2.1.1/ajv-formats.min.js" onerror="console.warn('AJV Formats failed to load')"></script>
    <!-- üîß AJV Keywords: Additional validation keywords like instanceof, range, etc. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv-keywords/5.1.0/ajv-keywords.min.js" onerror="console.warn('AJV Keywords failed to load')"></script>
    
    <!-- üìä Chart.js for Analytics and Visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js" onerror="console.warn('Chart.js failed to load')"></script>
    <script>
        // Enhanced AJV Loading System with Multiple Fallbacks
        let ajvLoadAttempts = 0;
        const maxAjvAttempts = 4;

        // Multiple CDN sources for better reliability
        const ajvCdnSources = [
            'https://unpkg.com/ajv@8.17.1/dist/ajv.bundle.js',
            'https://cdn.jsdelivr.net/npm/ajv@8.17.1/dist/ajv.min.js',
            'https://cdn.skypack.dev/ajv@8.17.1',
            'https://esm.sh/ajv@8.17.1'
        ];

        function loadAjvFallback() {
            console.log(`üîÑ Loading AJV fallback (attempt ${ajvLoadAttempts + 1}/${maxAjvAttempts})...`);
            
            if (ajvLoadAttempts >= maxAjvAttempts) {
                console.error('üî¥ All AJV CDN sources failed. Loading emergency fallback...');
                loadEmergencyAjvFallback();
                return;
            }

            const currentSource = ajvCdnSources[ajvLoadAttempts];
            ajvLoadAttempts++;

            const ajvScript = document.createElement('script');
            ajvScript.src = currentSource;
            ajvScript.onload = function() {
                console.log(`‚úÖ AJV loaded successfully from: ${currentSource}`);
                loadAjvExtensions();
            };
            ajvScript.onerror = function() {
                console.warn(`‚ùå Failed to load AJV from: ${currentSource}`);
                setTimeout(() => loadAjvFallback(), 1500); // Retry with delay
            };
            
            document.head.appendChild(ajvScript);
        }

        function loadAjvExtensions() {
            // Load formats
            const formatsScript = document.createElement('script');
            formatsScript.src = 'https://unpkg.com/ajv-formats@2.1.1/dist/ajv-formats.min.js';
            formatsScript.onload = () => console.log('‚úÖ AJV Formats loaded');
            formatsScript.onerror = () => console.warn('‚ö†Ô∏è AJV Formats failed (non-critical)');
            document.head.appendChild(formatsScript);

            // Load keywords
            const keywordsScript = document.createElement('script');
            keywordsScript.src = 'https://unpkg.com/ajv-keywords@5.1.0/dist/ajv-keywords.min.js';
            keywordsScript.onload = () => {
                console.log('‚úÖ AJV Keywords loaded');
                window.AjvExtensionsLoaded = true;
            };
            keywordsScript.onerror = () => console.warn('‚ö†Ô∏è AJV Keywords failed (non-critical)');
            document.head.appendChild(keywordsScript);
        }

        function loadEmergencyAjvFallback() {
            console.log('üö® Loading emergency local AJV implementation...');
            
            // Minimal AJV implementation for basic validation
            window.Ajv = function(options = {}) {
                return {
                    compile: function(schema) {
                        return function validate(data) {
                            try {
                                // Basic JSON validation - just try to parse and check basic structure
                                if (typeof data === 'string') {
                                    JSON.parse(data);
                                }
                                
                                // Basic type checking
                                if (schema.type) {
                                    const actualType = Array.isArray(data) ? 'array' : typeof data;
                                    if (actualType !== schema.type) {
                                        validate.errors = [{
                                            keyword: 'type',
                                            message: `should be ${schema.type}`,
                                            schemaPath: '#/type',
                                            data: data
                                        }];
                                        return false;
                                    }
                                }
                                
                                // Basic required fields check
                                if (schema.required && typeof data === 'object' && !Array.isArray(data)) {
                                    for (const field of schema.required) {
                                        if (!(field in data)) {
                                            validate.errors = [{
                                                keyword: 'required',
                                                message: `should have required property '${field}'`,
                                                schemaPath: '#/required',
                                                missingProperty: field
                                            }];
                                            return false;
                                        }
                                    }
                                }
                                
                                validate.errors = null;
                                return true;
                            } catch (error) {
                                validate.errors = [{
                                    keyword: 'format',
                                    message: error.message,
                                    schemaPath: '#/',
                                    data: data
                                }];
                                return false;
                            }
                        };
                    },
                    addFormat: function() { /* stub */ },
                    addKeyword: function() { /* stub */ }
                };
            };
            
            window.Ajv.version = '8.17.1-emergency';
            console.log('üÜò Emergency AJV implementation loaded (basic validation only)');
            window.AjvEmergencyMode = true;
            
            // Show user notification
            setTimeout(() => {
                if (typeof showToast === 'function') {
                    showToast('‚ö†Ô∏è –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –±–∞–∑–æ–≤–∏–π —Ä–µ–∂–∏–º –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Å—Ö–µ–º–∏', 'warning', 5000);
                }
                showAjvErrorDialog();
            }, 1000);
        }

        function showAjvErrorDialog() {
            if (document.getElementById('ajvErrorDialog')) return; // Already shown

            const dialog = document.createElement('div');
            dialog.id = 'ajvErrorDialog';
            dialog.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;
                padding: 15px; max-width: 400px; font-family: Arial, sans-serif;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: #856404;
            `;
            
            dialog.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <span style="font-size: 1.2em;">‚ö†Ô∏è</span>
                    <div style="flex: 1;">
                        <strong>–ü—Ä–æ–±–ª–µ–º–∞ –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é —Å—Ö–µ–º–∏</strong>
                        <p style="margin: 8px 0; font-size: 0.9em;">
                            –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ AJV –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É. –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:
                        </p>
                        <ul style="font-size: 0.85em; margin: 8px 0; padding-left: 18px;">
                            <li>–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è CDN –≤–∞—à–∏–º –∞–Ω—Ç–∏–≤—ñ—Ä—É—Å–æ–º/–±—Ä–∞–Ω–¥–º–∞—É–µ—Ä–æ–º</li>
                            <li>–ü—Ä–æ–±–ª–µ–º–∏ –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑'—î–¥–Ω–∞–Ω–Ω—è–º</li>
                            <li>–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è –º–µ—Ä–µ–∂—ñ</li>
                        </ul>
                        <div style="margin-top: 10px;">
                            <button onclick="retryAjvLoad()" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                üîÑ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
                            </button>
                            <button onclick="closeAjvDialog()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                ‚úñ –ó–∞–∫—Ä–∏—Ç–∏
                            </button>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.8em; color: #6c757d;">
                            üí° –ë–∞–∑–æ–≤–∏–π —Ä–µ–∂–∏–º –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –∞–∫—Ç–∏–≤–Ω–∏–π
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }

        function retryAjvLoad() {
            closeAjvDialog();
            ajvLoadAttempts = 0;
            window.AjvLoadError = false;
            window.AjvEmergencyMode = false;
            loadAjvFallback();
        }

        function closeAjvDialog() {
            const dialog = document.getElementById('ajvErrorDialog');
            if (dialog) dialog.remove();
        }
        
        // Enhanced AJV availability check with emergency mode support
        function isAjvAvailable() {
            const ajvExists = (
                typeof Ajv !== 'undefined' ||
                typeof window.Ajv !== 'undefined' ||
                typeof window.ajv !== 'undefined' ||
                (window.Ajv && window.Ajv.default)
            );
            
            const available = ajvExists && !window.AjvLoadError;
            
            // Check for emergency mode
            if (window.AjvEmergencyMode) {
                console.log('üÜò AJV Status: Emergency mode active (basic validation only)');
                return true; // Emergency mode counts as available
            }
            
            // Check additional packages (not critical for operation)
            const formatsAvailable = typeof addFormats !== 'undefined' || typeof window.addFormats !== 'undefined';
            const keywordsAvailable = typeof addKeywords !== 'undefined' || typeof window.addKeywords !== 'undefined';
            
            if (!available) {
                console.warn('‚ùå AJV Library Status:', {
                    'typeof Ajv': typeof Ajv,
                    'typeof window.Ajv': typeof window.Ajv,
                    'typeof window.ajv': typeof window.ajv,
                    'window.Ajv.default': window.Ajv && window.Ajv.default,
                    'AjvLoadError': window.AjvLoadError,
                    'AjvEmergencyMode': window.AjvEmergencyMode,
                    'formatsAvailable': formatsAvailable,
                    'keywordsAvailable': keywordsAvailable
                });
                
                // Auto-trigger emergency fallback if not already done
                if (!window.AjvEmergencyMode && !window.AjvLoadError) {
                    console.log('‚ö° Auto-triggering emergency fallback...');
                    window.AjvLoadError = true;
                    setTimeout(() => loadEmergencyAjvFallback(), 100);
                }
            } else if (available) {
                const mode = window.AjvEmergencyMode ? 'üÜò Emergency' : '‚úÖ Full';
                console.log(`AJV Status: ${mode}, Formats: ${formatsAvailable ? '‚úÖ' : '‚ùå'}, Keywords: ${keywordsAvailable ? '‚úÖ' : '‚ùå'}`);
                
                // Show version info if available
                try {
                    if (typeof Ajv !== 'undefined' && Ajv.version) {
                        console.log(`üì¶ AJV Version: ${Ajv.version}`);
                    }
                } catch (e) {
                    // Ignore version check errors
                }
            }
            return available;
        }

        // Enhanced error message for schema validation issues
        function getSchemaValidationErrorMessage() {
            if (window.AjvEmergencyMode) {
                return '–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –±–∞–∑–æ–≤–∏–π —Ä–µ–∂–∏–º –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Å—Ö–µ–º–∏. –î–µ—è–∫—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –º–æ–∂—É—Ç—å –±—É—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ.';
            } else if (window.AjvLoadError) {
                return 'AJV –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ö–µ–º–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑\'—î–¥–Ω–∞–Ω–Ω—è –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —Ä–µ–∂–∏–º –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è.';
            } else {
                return '–í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ö–µ–º–∏ —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.';
            }
        }
    </script>
    <style>
        :root {
            /* Modern Color Palette 2024 */
            --bg-color: #f8fafc;
            --main-color: #ffffff;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --text-color: #1a202c;
            --text-muted: #64748b;
            --header-color: #2d3748;
            
            /* Brand Colors with Gradients */
            --accent-color: #3b82f6;
            --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            --success-color: #10b981;
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --warning-color: #f59e0b;
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --error-color: #ef4444;
            --error-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --info-color: #06b6d4;
            --info-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            
            /* Legacy color aliases for compatibility */
            --green: #10b981;
            --red: #ef4444;
            --blue: #3b82f6;
            --orange: #f59e0b;
            --purple: #8b5cf6;
            
            /* Additional Modern Colors */
            --purple-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            --pink-gradient: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            --indigo-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            --emerald-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            --orange-gradient: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
            --rose-gradient: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
            
            /* Neutral Shades */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Border Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --radius-2xl: 1rem;
            --radius-3xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace;
            
            /* Toast Colors */
            --toast-success-bg: #ecfdf5;
            --toast-success-color: #065f46;
            --toast-success-border: #10b981;
            --toast-error-bg: #fef2f2;
            --toast-error-color: #991b1b;
            --toast-error-border: #ef4444;
            --toast-warning-bg: #fffbeb;
            --toast-warning-color: #92400e;
            --toast-warning-border: #f59e0b;
            --toast-info-bg: #f0f9ff;
            --toast-info-color: #0c4a6e;
            --toast-info-border: #06b6d4;
            --toast-border-radius: 12px;

            /* JSON Syntax Highlighting - Modern Colors */
            --json-key: #8b5cf6;
            --json-string: #10b981;
            --json-number: #3b82f6;
            --json-boolean: #f59e0b;
            --json-null: #ef4444;
            --json-bracket: #6b7280;
            --json-comma: #6b7280;
            --json-colon: #6b7280;
        }

        body.dark-mode {
            /* Modern Dark Mode 2024 */
            --bg-color: #0f172a;
            --main-color: #1e293b;
            --border-color: #334155;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --text-color: #f1f5f9;
            --text-muted: #94a3b8;
            --header-color: #ffffff;
            
            /* Dark Mode Gradients */
            --accent-gradient: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            --success-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            --warning-gradient: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --error-gradient: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            --info-gradient: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
            --purple-gradient: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            --pink-gradient: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);
            --indigo-gradient: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            --emerald-gradient: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
            --orange-gradient: linear-gradient(135deg, #fdba74 0%, #fb923c 100%);
            --rose-gradient: linear-gradient(135deg, #fb7185 0%, #f43f5e 100%);
            
            /* Dark Mode Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.5);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.75);
            
            /* Dark Mode Toast Colors */
            --toast-success-bg: #064e3b;
            --toast-success-color: #6ee7b7;
            --toast-success-border: #34d399;
            --toast-error-bg: #7f1d1d;
            --toast-error-color: #fca5a5;
            --toast-error-border: #f87171;
            --toast-warning-bg: #78350f;
            --toast-warning-color: #fcd34d;
            --toast-warning-border: #fbbf24;
            --toast-info-bg: #164e63;
            --toast-info-color: #67e8f9;
            --toast-info-border: #22d3ee;

            /* Dark Mode JSON Syntax Highlighting */
            --json-key: #a78bfa;
            --json-string: #6ee7b7;
            --json-number: #60a5fa;
            --json-boolean: #fbbf24;
            --json-null: #f87171;
            --json-bracket: #b0b0b0;
            --json-comma: #b0b0b0;
            --json-colon: #b0b0b0;
        }

        /* Import modern fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 24px;
            background: var(--bg-color);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: -0.025em;
            transition: all var(--transition-normal);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }
        
        body.dark-mode {
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(96, 165, 250, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(167, 139, 250, 0.1) 0%, transparent 50%);
        }

        /* Modern Typography */
        h1 {
            font-size: 3rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin: 0 0 2rem 0;
            letter-spacing: -0.05em;
            line-height: 1.1;
            animation: slideUp 0.8s ease-out;
        }

        h2 {
            font-size: 1.875rem;
            font-weight: 600;
            color: var(--header-color);
            margin: 2rem 0 1rem 0;
            letter-spacing: -0.025em;
        }

        h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--header-color);
            margin: 1.5rem 0 0.75rem 0;
            letter-spacing: -0.025em;
        }

        h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--header-color);
            margin: 1rem 0 0.5rem 0;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            transition: max-width 0.3s ease-in-out;
        }
        .container.full-width {
            max-width: 98%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        .header h1 {
            color: var(--header-color);
            font-weight: 600;
        }

        /* Diff Highlighting for JSON View */
        .diff-added-text { background-color: rgba(40, 167, 69, 0.2); }
        .diff-removed-text { background-color: rgba(220, 53, 69, 0.2); }
        .diff-changed-text { background-color: rgba(0, 123, 255, 0.2); } /* For ValueChanged, TypeChanged, LengthChanged, SchemaError */

        body.dark-mode .diff-added-text { background-color: rgba(40, 167, 69, 0.3); }
        body.dark-mode .diff-removed-text { background-color: rgba(220, 53, 69, 0.3); }
        body.dark-mode .diff-changed-text { background-color: rgba(0, 123, 255, 0.3); }


        /* Top Controls (Theme, Settings, Width) */
        .top-controls { position: absolute; top: 10px; right: 20px; display: flex; align-items: center; gap: 15px; }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        #settingsBtn, #widthToggleBtn { background: none; border: none; cursor: pointer; font-size: 1.4em; color: var(--text-color); opacity: 0.7; transition: opacity 0.2s, transform 0.2s; padding: 0; display: flex; align-items: center; justify-content: center; }
        #settingsBtn:hover, #widthToggleBtn:hover { opacity: 1; transform: scale(1.1); }
        #widthToggleBtn svg { width: 22px; height: 22px; }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            background-color: var(--main-color);
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        .mode-selector label {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }
        .mode-selector input { display: none; }
        .mode-selector input:checked + .tooltip-container label {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Special positioning for mode selector tooltips */
        .mode-selector .tooltip-container {
            position: relative;
            display: inline-block;
        }
        
        .mode-selector .tooltip {
            min-width: 260px;
            max-width: 320px;
            text-align: left;
            z-index: 1001; /* Higher than normal tooltips to appear above other elements */
        }
        
        .tooltip strong {
            color: inherit;
            font-weight: 600;
        }
        
        .tooltip br {
            line-height: 1.6;
        }
        
        /* Remove leading/trailing whitespace for cleaner tooltip appearance */
        .tooltip {
            white-space-collapse: discard; /* Modern browsers */
        }
        
        .tooltip:empty::before {
            content: none;
        }
        .drop-zones {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
            animation: slideUp 0.6s ease-out;
        }
        
        #dropZoneSchema { 
            grid-column: span 2; 
            animation: slideUp 0.8s ease-out;
        }
        
        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-2xl);
            background: var(--main-color);
            transition: all var(--transition-normal);
            position: relative;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .drop-zone::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--accent-gradient);
            border-radius: var(--radius-2xl);
            opacity: 0;
            transition: opacity var(--transition-normal);
            z-index: -1;
        }
        
        .drop-zone.invalid {
            border-color: var(--error-color);
            animation: bounce 0.6s ease-out;
        }
        
        .drop-zone.dragover {
            background: var(--gray-50);
            border-color: var(--accent-color);
            transform: scale(1.02) translateY(-4px);
            box-shadow: var(--shadow-2xl);
        }
        
        .drop-zone.dragover::before {
            opacity: 0.1;
        }
        
        body.dark-mode .drop-zone.dragover { 
            background: var(--gray-800); 
        }
        
        .drop-zone textarea {
            width: 100%;
            height: 180px;
            border: none;
            outline: none;
            resize: none;
            padding: 0;
            box-sizing: border-box;
            background: transparent;
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
            font-weight: 400;
            letter-spacing: -0.025em;
        }
        .drop-zone .file-name { font-weight: 600; color: var(--accent-color); margin-top: 10px; display: block; text-align: center; padding-bottom: 10px;}
        .error-message {
            color: var(--red);
            font-size: 0.9em;
            padding: 0 15px 10px;
            text-align: left;
            display: none;
        }
        .controls { 
            text-align: center; 
            margin-bottom: 40px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 16px;
            padding: 24px;
            background: var(--main-color);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            animation: slideUp 1s ease-out;
        }
        .action-btn {
            position: relative;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-md);
            background: var(--accent-gradient);
            overflow: hidden;
            letter-spacing: -0.025em;
            font-family: var(--font-family);
            backdrop-filter: blur(10px);
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: left var(--transition-slow);
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        .action-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: var(--shadow-md);
        }

        /* Specific button colors */
        #compareBtn { 
            background: var(--accent-gradient);
        }
        
        #compareBtn:disabled { 
            background: var(--gray-400);
            cursor: not-allowed; 
            box-shadow: var(--shadow-sm);
            transform: none;
        }

        #compareBtn:disabled::before {
            display: none;
        }

        /* Specific colored buttons */
        #historyBtn {
            background: var(--purple-gradient);
        }

        #aiAnalyzeBtn {
            background: var(--indigo-gradient);
        }

        #batchProcessingBtn {
            background: var(--purple-gradient);
        }

        #aiSchemaGenerationBtn {
            background: var(--pink-gradient);
        }

        #smartIgnoreBtn {
            background: var(--orange-gradient);
        }

        #ajvDiagnosticsBtn {
            background: var(--warning-gradient);
        }

        .export-container { position: relative; display: inline-block; }
        #exportBtn { 
            background: var(--success-gradient);
        }
        .export-dropdown { display: none; position: absolute; background-color: var(--main-color); min-width: 160px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2); z-index: 1; border-radius: 8px; border: 1px solid var(--border-color); }
        .export-dropdown a { color: var(--text-color); padding: 12px 16px; text-decoration: none; display: block; }
        .export-dropdown a:hover { background-color: #f1f3f5; }
        body.dark-mode .export-dropdown a:hover { background-color: #2c2c2c; }
        .export-container:hover .export-dropdown { display: block; }
        #clearAllBtn { 
            background: var(--error-gradient);
        }
        
        #copyResultsBtn { 
            background: var(--info-gradient);
        }

        
        #results {
            background-color: var(--main-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            display: none;
        }
        h2 { color: var(--header-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th.sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
        th.sortable::after { content: '‚Üï'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0.4; }
        th.sort-asc::after { content: '‚ñ≤'; opacity: 1; }
        th.sort-desc::after { content: '‚ñº'; opacity: 1; }
        pre { margin: 0; white-space: pre-wrap; word-break: break-all; font-family: 'Courier New', Courier, monospace; }
        
        /* Icon circles */
        .icon-circle {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 24px; /* Size of the circle */
            height: 24px; /* Size of the circle */
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.8em; /* Size of the text/symbol inside */
            color: white; /* Text color inside the circle */
        }
        .icon-circle-added { background-color: var(--green); }
        .icon-circle-removed { background-color: var(--red); }
        .icon-circle-changed { background-color: var(--blue); } /* For üîÑ, üß±, üìè, ‚ùó, X */
        .icon-circle-total { background-color: var(--orange); } /* New color for total */
        
        .results-controls { 
            margin-bottom: 24px; 
            display: flex; 
            gap: 20px; 
            align-items: center; 
            flex-wrap: wrap; 
            padding: 20px; 
            background: var(--main-color); 
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        .results-controls input[type="search"] { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--main-color); color: var(--text-color); min-width: 250px; }
        .results-controls .filter-group { display: flex; gap: 15px; align-items: center; }
        .results-controls .filter-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        
        .stats-bar { 
            display: flex; 
            gap: 24px; 
            padding: 24px; 
            background: var(--main-color);
            border-radius: var(--radius-xl); 
            margin-bottom: 24px; 
            align-items: center;
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }
        .stat-item { 
            font-size: 1.1em; 
            font-weight: 500; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .stat-item-total {
            font-size: 1.3em;
            padding: 8px 16px;
            background-color: var(--main-color);
            border-radius: 8px;
            border: 1px solid var(--accent-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-item-total strong {
            color: var(--accent-color);
        }
        .stats-divider {
            width: 2px;
            height: 30px;
            background-color: var(--border-color);
            margin: 0 10px;
        }
        
        /* Responsive design for stats */
        @media (max-width: 768px) {
            .stats-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .stats-divider {
                width: 100%;
                height: 2px;
                margin: 5px 0;
            }
            
            .stat-item-total {
                text-align: center;
            }
        }

        .json-view { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .json-view pre {
            background-color: var(--main-color);
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6em;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: auto; /* Changed from visible for scrolling */
            border: 1px solid var(--border-color);
            margin: 0;
            font-size: 14px;
        }
        body.dark-mode .json-view pre {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        /* JSON Syntax Highlighting */
        .json-key { color: var(--json-key); }
        .json-string { color: var(--json-string); }
        .json-number { color: var(--json-number); }
        .json-boolean { color: var(--json-boolean); }
        .json-null { color: var(--json-null); }
        .json-bracket { color: var(--json-bracket); }
        .json-comma { color: var(--json-comma); }
        .json-colon { color: var(--json-colon); }
        
        /* Collapsible Sections */
        .collapsible-header { width: 100%; background: transparent; border: none; padding: 0; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .collapsible-header h2 { border: none; }
        .collapse-icon { transition: transform 0.3s ease; color: var(--text-color); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .collapsible-section:not(.collapsed) .collapsible-content { max-height: 5000px; /* Arbitrary large value */ }
        .collapsible-section.collapsed .collapse-icon { transform: rotate(-90deg); }

        /* Loading Overlay */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than modal */
        }
        .loader-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--accent-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
            }
            50% { 
                opacity: 0.5; 
            }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0, -10px, 0);
            }
            70% {
                transform: translate3d(0, -5px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }
        
        /* Modern Modal Styles */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.75); 
            backdrop-filter: blur(8px);
            z-index: 1000; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            animation: fadeIn 0.3s ease; 
        }
        
        .modal-content { 
            background: var(--main-color); 
            padding: 32px; 
            border-radius: var(--radius-2xl); 
            box-shadow: var(--shadow-2xl); 
            border: 1px solid var(--border-color);
            width: 90%; 
            max-width: 600px; 
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 20px; 
            margin-bottom: 24px; 
        }
        
        .modal-header h2 { 
            margin: 0; 
            color: var(--header-color); 
            border: none;
            font-size: 1.75rem;
            font-weight: 600;
        }
        
        .modal-close { 
            font-size: 1.5em; 
            font-weight: bold; 
            cursor: pointer; 
            color: var(--text-muted); 
            background: none; 
            border: none;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--text-color);
            transform: scale(1.1);
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            margin-top: 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .modal-body .form-group { margin-bottom: 20px; }
        .modal-body label { display: block; font-weight: 600; margin-bottom: 8px; }
        /* Modern Form Fields */
        input[type="text"], 
        input[type="email"], 
        input[type="password"],
        textarea, 
        select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: var(--main-color);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 15px;
            font-weight: 400;
            letter-spacing: -0.025em;
            box-sizing: border-box;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        input[type="text"]:focus, 
        input[type="email"]:focus, 
        input[type="password"]:focus,
        textarea:focus, 
        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: var(--font-mono);
            line-height: 1.6;
        }

        .modal-body input[type="text"], 
        .modal-body textarea { 
            /* Override for modal inputs */
        }
        .modal-body textarea { min-height: 80px; resize: vertical; }
        .modal-body .radio-group label { display: inline-block; margin-right: 15px; font-weight: normal; }
        .modal-body .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .modal-footer { text-align: right; border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 20px; }
        
        /* Tooltip Styles */
        .tooltip-container {
            position: relative; /* –©–æ–± –ø—ñ–¥–∫–∞–∑–∫–∞ –ø–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–ª–∞—Å—è –≤—ñ–¥–Ω–æ—Å–Ω–æ —Ü—å–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞ */
            display: inline-block; /* –©–æ–± –Ω–µ –∑–∞–π–º–∞–≤ –≤—Å—é —à–∏—Ä–∏–Ω—É */
            cursor: help; /* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä, —â–æ —î –ø—ñ–¥–∫–∞–∑–∫–∞ */
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            width: auto; /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ —à–∏—Ä–∏–Ω–∞ */
            max-width: 280px; /* –û–ø—Ç–∏–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è */
            background-color: var(--header-color);
            color: var(--main-color);
            text-align: left;
            border-radius: 8px;
            padding: 10px 14px; /* –¢—Ä–æ—Ö–∏ –∑–±—ñ–ª—å—à–µ–Ω–∏–π padding –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤–∏–¥—É */
            position: fixed;
            z-index: 1000;
            font-size: 0.85em;
            line-height: 1.4; /* –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –≤–∏—Å–æ—Ç–∞ —Ä—è–¥–∫–∞ */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
            white-space: pre-line; /* –ó–±–µ—Ä—ñ–≥–∞—î –ø–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤, –∞–ª–µ –≤–∏–¥–∞–ª—è—î –∑–∞–π–≤—ñ –ø—Ä–æ–±—ñ–ª–∏ */
            word-wrap: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –¥–æ–≤–≥—ñ —Å–ª–æ–≤–∞ */
            overflow-wrap: break-word; /* –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å—É */
        }

        /* Dark mode adjustments for tooltip */
        body.dark-mode .tooltip {
            background-color: #555;
            color: #eee;
        }

        /* Toast notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1002; /* Above modals and tooltips */
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }
        .toast {
            padding: 16px 20px;
            border-radius: var(--toast-border-radius);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: -0.025em;
            box-shadow: var(--shadow-xl);
            opacity: 0;
            transform: translateX(100%) scale(0.9);
            transition: all var(--transition-normal);
            min-width: 280px;
            max-width: 400px;
            text-align: left;
            backdrop-filter: blur(10px);
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
        
        .toast.success {
            background: var(--toast-success-bg);
            color: var(--toast-success-color);
            border-color: var(--toast-success-border);
        }
        
        .toast.success::before {
            content: '‚úÖ';
            font-size: 16px;
        }
        
        .toast.error {
            background: var(--toast-error-bg);
            color: var(--toast-error-color);
            border-color: var(--toast-error-border);
        }
        
        .toast.error::before {
            content: '‚ùå';
            font-size: 16px;
        }
        
        .toast.warning {
            background: var(--toast-warning-bg);
            color: var(--toast-warning-color);
            border-color: var(--toast-warning-border);
        }
        
        .toast.warning::before {
            content: '‚ö†Ô∏è';
            font-size: 16px;
        }
        
        .toast.info {
            background: var(--toast-info-bg);
            color: var(--toast-info-color);
            border-color: var(--toast-info-border);
        }
        
        .toast.info::before {
            content: '‚ÑπÔ∏è';
            font-size: 16px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 16px;
                font-size: 14px;
            }

            h1 {
                font-size: 2.25rem;
                margin-bottom: 1.5rem;
            }

            .drop-zones {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 24px;
            }

            #dropZoneSchema {
                grid-column: span 1;
            }

            .controls {
                padding: 16px;
                gap: 12px;
            }

            .action-btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .stats-bar {
                padding: 16px;
                gap: 16px;
            }

            .modal-content {
                padding: 24px;
                margin: 16px;
                width: calc(100% - 32px);
                max-width: none;
            }

            .modal-header h2 {
                font-size: 1.5rem;
            }

            .toast {
                min-width: 240px;
                max-width: calc(100vw - 32px);
            }

            .results-controls {
                padding: 16px;
                gap: 12px;
            }

            .drop-zone textarea {
                height: 120px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }

            h1 {
                font-size: 1.875rem;
            }

            .drop-zone {
                padding: 16px;
            }

            .drop-zone textarea {
                height: 100px;
                font-size: 12px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* JSON Tree View styles */
        .json-tree-view {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 15px;
            border-radius: 8px;
            background-color: var(--main-color);
            border: 1px solid var(--border-color);
            overflow: auto;
            max-height: 400px; /* Example max height for tree view */
        }
        body.dark-mode .json-tree-view {
            background-color: #1e1e1e;
        }

        .json-tree {
            list-style: none;
            padding-left: 0; /* No indent for root ul */
            margin: 0;
        }
        .json-tree ul {
            list-style: none;
            padding-left: 1.5em; /* Indent children */
            margin: 0;
            display: block;
        }
        .json-tree li {
            position: relative;
            padding-left: 0; /* Remove default padding */
        }
        .json-tree li.collapsed > ul {
            display: none;
        }
        
        .json-tree ul {
            transition: all 0.3s ease;
        }
        
        /* Better spacing for tree items */
        .json-tree li {
            margin: 2px 0;
            line-height: 1.6;
        }
        
        /* Styling for collapsed/expanded indicators */
        .json-tree .tree-toggle:before {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            margin-right: 6px;
            vertical-align: middle;
            border-left: 6px solid var(--text-color);
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            transition: transform 0.2s ease;
        }
        
        .json-tree li.collapsed .tree-toggle:before {
            transform: rotate(-90deg);
        }

        /* Drag & Drop Styles */
        .drop-zone {
            position: relative;
            transition: all 0.3s ease;
            border: 2px dashed transparent;
            border-radius: 8px;
            background: var(--bg-color);
        }
        
        .drop-zone.drag-over {
            border-color: var(--accent-color);
            background: rgba(76, 175, 80, 0.1);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }
        
        .drop-zone.drag-invalid {
            border-color: var(--red);
            background: rgba(244, 67, 54, 0.1);
            animation: shake 0.5s ease-in-out;
        }
        
        .drop-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            background: var(--main-color);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .drop-zone.drag-over .drop-indicator {
            opacity: 1;
        }
        
        .drop-zone.drag-invalid .drop-indicator {
            border-color: var(--red);
            color: var(--red);
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes dropSuccess {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        .drop-success {
            animation: dropSuccess 0.6s ease-in-out;
        }
        
        /* File input styling */
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-hidden {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--text-muted);
            font-size: 1.2em;
            pointer-events: none;
        }

        /* JSON Formatter Controls */
        .formatter-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            opacity: 0.7;
            transition: all var(--transition-normal);
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        
        body.dark-mode .formatter-controls {
            background: rgba(30, 41, 59, 0.9);
        }
        
        .drop-zone:hover .formatter-controls,
        .drop-zone:focus-within .formatter-controls {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .formatter-btn {
            background: var(--gray-600);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius-lg);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
            letter-spacing: -0.025em;
            font-family: var(--font-family);
        }
        
        .formatter-btn:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: var(--shadow-md);
        }
        
        .formatter-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: var(--shadow-sm);
        }
        
        .formatter-btn.beautify {
            background: var(--success-gradient);
        }
        
        .formatter-btn.minify {
            background: var(--orange-gradient);
        }
        
        .formatter-btn.validate {
            background: var(--accent-gradient);
        }
        
        .formatter-btn.delete {
            background: var(--error-gradient);
        }

         /* History Modal Styles */
         .history-list {
             max-height: 400px;
             overflow-y: auto;
             margin: 20px 0;
         }
         
         .history-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 12px;
             border: 1px solid var(--border-color);
             border-radius: 6px;
             margin-bottom: 8px;
             background: var(--bg-color);
             transition: all 0.2s ease;
             cursor: pointer;
         }
         
         .history-item:hover {
             background: var(--main-color);
             border-color: var(--accent-color);
             transform: translateY(-1px);
             box-shadow: 0 2px 8px rgba(0,0,0,0.1);
         }
         
         .history-item.selected {
             border-color: var(--accent-color);
             background: rgba(76, 175, 80, 0.1);
         }
         
         .history-info {
             flex: 1;
         }
         
         .history-title {
             font-weight: 600;
             color: var(--header-color);
             margin-bottom: 4px;
         }
         
         .history-meta {
             font-size: 0.85em;
             color: var(--text-muted);
             display: flex;
             gap: 15px;
         }
         
         .history-actions {
             display: flex;
             gap: 8px;
         }
         
         .history-btn {
             padding: 4px 8px;
             border: none;
             border-radius: 4px;
             font-size: 0.8em;
             cursor: pointer;
             transition: all 0.2s ease;
         }
         
         .history-btn.load {
             background: var(--accent-color);
             color: white;
         }
         
         .history-btn.load:hover {
             background: var(--accent-hover);
         }
         
         .history-btn.delete {
             background: var(--red);
             color: white;
         }
         
         .history-btn.delete:hover {
             background: #d32f2f;
         }
         
         .history-empty {
             text-align: center;
             padding: 40px 20px;
             color: var(--text-muted);
         }
         
         .history-stats {
             background: var(--bg-color);
             padding: 10px;
             border-radius: 6px;
             margin-bottom: 15px;
             font-size: 0.9em;
             color: var(--text-muted);
         }

         /* Side-by-Side Diff Viewer Styles */
         .view-mode-toggle {
             display: flex;
             gap: 10px;
             margin-bottom: 20px;
             padding: 10px;
             background: var(--bg-color);
             border-radius: 8px;
             border: 1px solid var(--border-color);
         }
         
         .view-mode-btn {
             padding: 8px 16px;
             border: 1px solid var(--border-color);
             border-radius: 6px;
             background: var(--main-color);
             color: var(--text-color);
             cursor: pointer;
             transition: all 0.2s ease;
             font-size: 0.9em;
         }
         
         .view-mode-btn:hover {
             border-color: var(--accent-color);
             transform: translateY(-1px);
         }
         
         .view-mode-btn.active {
             background: var(--accent-color);
             color: white;
             border-color: var(--accent-color);
         }
         
         .side-by-side-container {
             display: flex;
             gap: 20px;
             height: 600px;
             border: 1px solid var(--border-color);
             border-radius: 8px;
             overflow: hidden;
         }
         
         .side-panel {
             flex: 1;
             display: flex;
             flex-direction: column;
             background: var(--main-color);
         }
         
         .side-panel-header {
             background: var(--bg-color);
             padding: 12px 16px;
             border-bottom: 1px solid var(--border-color);
             font-weight: 600;
             color: var(--header-color);
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .side-panel-content {
             flex: 1;
             overflow: auto;
             padding: 16px;
             font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
             font-size: 14px;
             line-height: 1.6;
             white-space: pre-wrap;
             word-break: break-word;
         }
         
         .side-panel.left {
             border-right: 1px solid var(--border-color);
         }
         
         .diff-line {
             padding: 2px 8px;
             margin: 1px 0;
             border-radius: 4px;
             position: relative;
         }
         
         .diff-line.added {
             background: rgba(76, 175, 80, 0.15);
             border-left: 3px solid #4CAF50;
         }
         
         .diff-line.removed {
             background: rgba(244, 67, 54, 0.15);
             border-left: 3px solid #f44336;
         }
         
         .diff-line.modified {
             background: rgba(255, 152, 0, 0.15);
             border-left: 3px solid #FF9800;
         }
         
         .diff-line.context {
             background: transparent;
             color: var(--text-muted);
         }
         
         .diff-line-number {
             display: inline-block;
             width: 40px;
             text-align: right;
             color: var(--text-muted);
             margin-right: 12px;
             font-size: 0.85em;
         }
         
         .diff-highlight {
             background: rgba(255, 235, 59, 0.4);
             padding: 2px;
             border-radius: 2px;
         }
         
         .sync-scroll {
             scrollbar-width: thin;
         }
         
         .sync-scroll::-webkit-scrollbar {
             width: 8px;
         }
         
         .sync-scroll::-webkit-scrollbar-track {
             background: var(--bg-color);
         }
         
         .sync-scroll::-webkit-scrollbar-thumb {
             background: var(--border-color);
             border-radius: 4px;
         }
         
         .sync-scroll::-webkit-scrollbar-thumb:hover {
             background: var(--text-muted);
         }

         /* Advanced Search Styles */
         .search-container {
             background: var(--bg-color);
             padding: 15px;
             border-radius: 8px;
             border: 1px solid var(--border-color);
             margin-bottom: 20px;
         }
         
         .search-box {
             position: relative;
             display: flex;
             align-items: center;
             gap: 10px;
         }
         
         .search-input {
             flex: 1;
             padding: 10px 40px 10px 12px;
             border: 1px solid var(--border-color);
             border-radius: 6px;
             background: var(--main-color);
             color: var(--text-color);
             font-size: 14px;
             transition: border-color 0.2s ease;
         }
         
         .search-input:focus {
             outline: none;
             border-color: var(--accent-color);
             box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
         }
         
         .search-icon {
             position: absolute;
             right: 12px;
             top: 50%;
             transform: translateY(-50%);
             color: var(--text-muted);
             pointer-events: none;
         }
         
         .search-filters {
             display: flex;
             gap: 15px;
             margin-top: 10px;
             flex-wrap: wrap;
         }
         
         .search-filter-group {
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .search-filter-group label {
             font-size: 0.9em;
             color: var(--text-color);
             cursor: pointer;
         }
         
         .search-filter-group input[type="checkbox"] {
             margin: 0;
         }
         
         .search-stats {
             margin-top: 10px;
             padding: 8px 12px;
             background: var(--main-color);
             border-radius: 4px;
             font-size: 0.9em;
             color: var(--text-muted);
             border-left: 3px solid var(--accent-color);
         }
         
         .search-highlight {
             background: rgba(255, 235, 59, 0.6);
             padding: 1px 2px;
             border-radius: 2px;
             font-weight: 600;
         }
         
         .search-hidden {
             display: none !important;
         }
         
         .search-match {
             background: rgba(76, 175, 80, 0.1);
             border-left: 3px solid var(--accent-color);
         }
         
         .search-no-results {
             text-align: center;
             padding: 40px 20px;
             color: var(--text-muted);
             background: var(--bg-color);
             border-radius: 6px;
             margin: 20px 0;
         }

         /* Real-time JSON Editor Styles */
         .json-editor-container {
             position: relative;
         }
         
         .json-editor-overlay {
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             pointer-events: none;
             font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
             font-size: inherit;
             line-height: inherit;
             padding: inherit;
             margin: inherit;
             border: inherit;
             white-space: pre-wrap;
             overflow: hidden;
             color: transparent;
             background: transparent;
         }
         
         .json-editor-textarea {
             position: relative;
             z-index: 2;
             background: transparent;
             color: var(--text-color);
             resize: vertical;
         }
         
         .json-syntax-highlight {
             z-index: 1;
         }
         
         .json-preview {
             background: var(--bg-color);
             border: 1px solid var(--border-color);
             border-radius: 6px;
             padding: 12px;
             margin-top: 10px;
             font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
             font-size: 0.9em;
             max-height: 200px;
             overflow: auto;
         }
         
         .json-validation-status {
             display: flex;
             align-items: center;
             gap: 8px;
             margin-top: 8px;
             padding: 6px 10px;
             border-radius: 4px;
             font-size: 0.85em;
             transition: all 0.2s ease;
         }
         
         .json-validation-status.valid {
             background: rgba(76, 175, 80, 0.1);
             color: var(--green);
             border-left: 3px solid var(--green);
         }
         
         .json-validation-status.invalid {
             background: rgba(244, 67, 54, 0.1);
             color: var(--red);
             border-left: 3px solid var(--red);
         }
         
         .json-validation-status.empty {
             background: rgba(158, 158, 158, 0.1);
             color: var(--text-muted);
             border-left: 3px solid var(--text-muted);
         }
         
         .json-char-count {
             position: absolute;
             bottom: 8px;
             right: 12px;
             font-size: 0.75em;
             color: var(--text-muted);
             background: var(--main-color);
             padding: 2px 6px;
             border-radius: 3px;
             pointer-events: none;
         }
         
         .json-line-numbers {
             position: absolute;
             top: 0;
             left: 0;
             bottom: 0;
             width: 40px;
             background: var(--bg-color);
             border-right: 1px solid var(--border-color);
             color: var(--text-muted);
             font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
             font-size: 0.85em;
             line-height: inherit;
             padding: 12px 8px;
             user-select: none;
             overflow: hidden;
         }
         
         .json-editor-with-numbers textarea {
             padding-left: 52px;
         }
         
         .auto-save-indicator {
             position: absolute;
             top: 8px;
             right: 8px;
             padding: 4px 8px;
             background: var(--accent-color);
             color: white;
             border-radius: 4px;
             font-size: 0.75em;
             opacity: 0;
             transition: opacity 0.3s ease;
         }
         
         .auto-save-indicator.show {
             opacity: 1;
         }

         /* Batch Processing Styles */
         .batch-processing-modal .modal-content {
             max-width: 800px;
             width: 90%;
         }
         
         .batch-upload-zone {
             border: 2px dashed var(--border-color);
             border-radius: 8px;
             padding: 40px 20px;
             text-align: center;
             background: var(--bg-color);
             transition: all 0.3s ease;
             cursor: pointer;
         }
         
         .batch-upload-zone:hover,
         .batch-upload-zone.drag-over {
             border-color: var(--accent-color);
             background: rgba(76, 175, 80, 0.1);
         }
         
         .batch-file-list {
             max-height: 300px;
             overflow-y: auto;
             margin: 20px 0;
             background: var(--main-color);
             border: 1px solid var(--border-color);
             border-radius: 6px;
         }
         
         .batch-file-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 12px 16px;
             border-bottom: 1px solid var(--border-color);
             transition: background 0.2s ease;
         }
         
         .batch-file-item:hover {
             background: var(--bg-color);
         }
         
         .batch-file-item:last-child {
             border-bottom: none;
         }
         
         .batch-file-info {
             flex: 1;
         }
         
         .batch-file-name {
             font-weight: 600;
             color: var(--header-color);
             margin-bottom: 4px;
         }
         
         .batch-file-meta {
             font-size: 0.85em;
             color: var(--text-muted);
         }
         
         .batch-file-actions {
             display: flex;
             gap: 8px;
         }
         
         .batch-progress {
             background: var(--bg-color);
             border-radius: 8px;
             padding: 20px;
             margin: 20px 0;
             display: none;
         }
         
         .batch-progress-bar {
             width: 100%;
             height: 8px;
             background: var(--border-color);
             border-radius: 4px;
             overflow: hidden;
             margin: 10px 0;
         }
         
         .batch-progress-fill {
             height: 100%;
             background: var(--accent-color);
             transition: width 0.3s ease;
             width: 0%;
         }
         
         .batch-results {
             margin-top: 20px;
         }
         
         .batch-result-item {
             background: var(--main-color);
             border: 1px solid var(--border-color);
             border-radius: 6px;
             margin-bottom: 12px;
             overflow: hidden;
         }
         
         .batch-result-header {
             background: var(--bg-color);
             padding: 12px 16px;
             font-weight: 600;
             color: var(--header-color);
             cursor: pointer;
             display: flex;
             justify-content: space-between;
             align-items: center;
         }
         
         .batch-result-content {
             padding: 16px;
             max-height: 300px;
             overflow-y: auto;
             display: none;
         }
         
         .batch-result-content.expanded {
             display: block;
         }
         
         .batch-summary {
             background: var(--bg-color);
             border-radius: 6px;
             padding: 16px;
             margin-bottom: 20px;
         }
         
         .batch-summary-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
             gap: 16px;
         }
         
         .batch-summary-item {
             text-align: center;
         }
         
         .batch-summary-value {
             font-size: 1.5em;
             font-weight: 600;
             color: var(--accent-color);
         }
         
         .batch-summary-label {
             font-size: 0.9em;
             color: var(--text-muted);
             margin-top: 4px;
         }

         /* AI Schema Generation Styles */
         .schema-generation-modal .modal-content {
             max-width: 900px;
             width: 95%;
         }
         
         .schema-input-section {
             background: var(--bg-color);
             border-radius: 8px;
             padding: 20px;
             margin-bottom: 20px;
         }
         
         .schema-json-input {
             width: 100%;
             min-height: 200px;
             padding: 12px;
             border: 1px solid var(--border-color);
             border-radius: 6px;
             background: var(--main-color);
             color: var(--text-color);
             font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
             font-size: 14px;
             resize: vertical;
         }
         
         .schema-options {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
             gap: 20px;
             margin: 20px 0;
         }
         
         .schema-option-group {
             background: var(--main-color);
             border: 1px solid var(--border-color);
             border-radius: 6px;
             padding: 16px;
         }
         
         .schema-option-title {
             font-weight: 600;
             color: var(--header-color);
             margin-bottom: 12px;
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .schema-checkbox-list {
             display: flex;
             flex-direction: column;
             gap: 8px;
         }
         
         .schema-checkbox-item {
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .schema-output {
             background: var(--main-color);
             border: 1px solid var(--border-color);
             border-radius: 6px;
             margin-top: 20px;
             overflow: hidden;
         }
         
         .schema-output-header {
             background: var(--bg-color);
             padding: 12px 16px;
             font-weight: 600;
             color: var(--header-color);
             display: flex;
             justify-content: space-between;
             align-items: center;
         }
         
         .schema-output-content {
             padding: 16px;
             max-height: 400px;
             overflow-y: auto;
             font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
             font-size: 14px;
             line-height: 1.5;
         }
         
         .schema-generation-progress {
             background: var(--bg-color);
             border-radius: 8px;
             padding: 20px;
             margin: 20px 0;
             text-align: center;
             display: none;
         }
         
                 .schema-loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid transparent;
            border-radius: 50%;
            background: conic-gradient(from 0deg, transparent, var(--accent-color));
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
            position: relative;
        }

        .schema-loading-spinner::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            background: var(--main-color);
            border-radius: 50%;
            z-index: 1;
        }

        .schema-loading-spinner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
         
         .schema-quality-indicator {
             display: inline-flex;
             align-items: center;
             gap: 6px;
             padding: 4px 8px;
             border-radius: 4px;
             font-size: 0.85em;
             font-weight: 600;
         }
         
         .schema-quality-indicator.excellent {
             background: rgba(76, 175, 80, 0.2);
             color: var(--green);
         }
         
         .schema-quality-indicator.good {
             background: rgba(255, 193, 7, 0.2);
             color: #f57c00;
         }
         
         .schema-quality-indicator.basic {
             background: rgba(108, 117, 125, 0.2);
             color: var(--text-muted);
         }

         /* Smart Ignore Rules Styles */
         .smart-ignore-modal .modal-content {
             max-width: 1000px;
             width: 95%;
         }
         
         .ignore-rules-container {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 20px;
             margin: 20px 0;
         }
         
         .ignore-rules-panel {
             background: var(--main-color);
             border: 1px solid var(--border-color);
             border-radius: 8px;
             overflow: hidden;
         }
         
         .ignore-rules-header {
             background: var(--bg-color);
             padding: 12px 16px;
             font-weight: 600;
             color: var(--header-color);
             display: flex;
             justify-content: between;
             align-items: center;
         }
         
         .ignore-rules-content {
             padding: 16px;
             max-height: 400px;
             overflow-y: auto;
         }
         
         .ignore-category {
             margin-bottom: 20px;
         }
         
         .ignore-category-title {
             font-weight: 600;
             color: var(--header-color);
             margin-bottom: 12px;
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .ignore-rule-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 8px 12px;
             background: var(--bg-color);
             border-radius: 4px;
             margin-bottom: 6px;
             transition: all 0.2s ease;
         }
         
         .ignore-rule-item:hover {
             background: var(--border-color);
         }
         
         .ignore-rule-info {
             flex: 1;
         }
         
         .ignore-rule-pattern {
             font-family: monospace;
             color: var(--accent-color);
             font-weight: 600;
         }
         
         .ignore-rule-description {
             font-size: 0.85em;
             color: var(--text-muted);
             margin-top: 2px;
         }
         
         .ignore-rule-actions {
             display: flex;
             gap: 6px;
         }
         
         .ignore-rule-btn {
             padding: 4px 8px;
             border: none;
             border-radius: 3px;
             cursor: pointer;
             font-size: 0.8em;
             transition: all 0.2s ease;
         }
         
         .ignore-rule-btn.add {
             background: var(--accent-color);
             color: white;
         }
         
         .ignore-rule-btn.remove {
             background: var(--red);
             color: white;
         }
         
         .ignore-rule-btn:hover {
             transform: scale(1.1);
         }
         
         .current-ignore-rules {
             background: var(--bg-color);
             border-radius: 6px;
             padding: 12px;
             margin: 20px 0;
         }
         
         .current-rule-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 6px 10px;
             background: var(--main-color);
             border-radius: 4px;
             margin-bottom: 4px;
             border-left: 3px solid var(--accent-color);
         }
         
         .ai-suggestions {
             background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(33, 150, 243, 0.1));
             border: 1px solid rgba(76, 175, 80, 0.3);
             border-radius: 8px;
             padding: 16px;
             margin: 20px 0;
         }
         
         .ai-suggestion-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 10px;
             background: var(--main-color);
             border-radius: 6px;
             margin-bottom: 8px;
             border-left: 4px solid var(--accent-color);
         }
         
         .confidence-indicator {
             display: inline-flex;
             align-items: center;
             gap: 4px;
             padding: 2px 8px;
             border-radius: 12px;
             font-size: 0.75em;
             font-weight: 600;
         }
         
         .confidence-high {
             background: rgba(76, 175, 80, 0.2);
             color: var(--green);
         }
         
         .confidence-medium {
             background: rgba(255, 193, 7, 0.2);
             color: #f57c00;
         }
         
         .confidence-low {
             background: rgba(108, 117, 125, 0.2);
             color: var(--text-muted);
         }
        .json-tree .tree-toggle {
            cursor: pointer;
            display: inline-block;
            width: 1.2em;
            text-align: center;
            user-select: none;
            /* Using CSS variables for color */
            color: var(--text-color); 
        }
        .json-tree .tree-toggle:hover {
            color: var(--accent-color);
        }
        .json-tree .json-key { color: var(--json-key); }
        .json-tree .json-string { color: var(--json-string); }
        .json-tree .json-number { color: var(--json-number); }
        .json-tree .json-boolean { color: var(--json-boolean); }
        .json-tree .json-null { color: var(--json-null); }
        .json-tree .json-bracket { 
            color: var(--json-bracket); 
            font-weight: 500;
            opacity: 0.8;
        }
        .json-tree .json-comma { color: var(--json-comma); }
        .json-tree .json-colon { color: var(--json-colon); }
        
        /* Array index styling - using attribute selector for better compatibility */
        .json-tree .array-index { 
            color: var(--orange); 
            font-weight: 600;
            font-style: italic;
        }

        /* Schema validation result styling */
        .schema-success {
            background-color: rgba(40, 167, 69, 0.1);
            border-left: 4px solid var(--green);
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .schema-error {
            background-color: rgba(220, 53, 69, 0.1);
            border-left: 4px solid var(--red);
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        /* Schema examples styling */
        .schema-examples details {
            margin-top: 8px;
        }

        .schema-examples details[open] {
            background-color: var(--bg-color);
            border-radius: 6px;
            padding: 8px;
        }

        .schema-examples summary {
            font-weight: 500;
            color: var(--accent-color);
        }

        .schema-examples summary:hover {
            opacity: 0.8;
        }

        .schema-examples pre {
            background: var(--main-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            overflow-x: auto;
        }

        /* Schema validation specific error types */
        .error-type-SchemaRequiredError {
            border-left-color: #e74c3c;
        }

        .error-type-SchemaTypeError {
            border-left-color: #f39c12;
        }

        .error-type-SchemaFormatError {
            border-left-color: #9b59b6;
        }

        .error-type-SchemaRangeError {
            border-left-color: #e67e22;
        }

        /* Dark mode adjustments */
        body.dark-mode .schema-success {
            background-color: rgba(40, 167, 69, 0.15);
        }

        body.dark-mode .schema-error {
            background-color: rgba(220, 53, 69, 0.15);
        }

        /* Diff highlighting in tree view */
        .json-tree .diff-added-text { background-color: rgba(40, 167, 69, 0.2); }
        .json-tree .diff-removed-text { background-color: rgba(220, 53, 69, 0.2); }
        .json-tree .diff-changed-text { background-color: rgba(0, 123, 255, 0.2); }

        body.dark-mode .json-tree .diff-added-text { background-color: rgba(40, 167, 69, 0.3); }
        body.dark-mode .json-tree .diff-removed-text { background-color: rgba(220, 53, 69, 0.3); }
        body.dark-mode .json-tree .diff-changed-text { background-color: rgba(0, 123, 255, 0.3); }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Skip navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--accent-color);
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
            border-radius: 4px;
        }
        .skip-link:focus {
            top: 6px;
        }

        /* Focus improvements */
        *:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* High contrast improvements */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000;
                --text-color: #000;
                --bg-color: #fff;
            }
            body.dark-mode {
                --border-color: #fff;
                --text-color: #fff;
                --bg-color: #000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Live region for announcements */
        #live-region {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        /* Scroll to top button */
        #scrollToTopBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
        }

        #scrollToTopBtn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #scrollToTopBtn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        #scrollToTopBtn:active {
            transform: translateY(0);
        }

        body.dark-mode #scrollToTopBtn {
            background-color: #0056b3;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        body.dark-mode #scrollToTopBtn:hover {
            background-color: #004494;
        }

        /* === VISUAL ENHANCEMENTS & ANALYTICS === */
        
        /* Minimap Navigation */
        .minimap-container {
            position: sticky;
            top: 20px;
            width: 200px;
            max-height: 400px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-left: 15px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .minimap-header {
            font-size: 12px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 8px;
            text-align: center;
        }

        .minimap-item {
            padding: 2px 6px;
            margin: 1px 0;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .minimap-item:hover {
            background: var(--hover-color);
            transform: translateX(2px);
        }

        .minimap-item.added { border-left-color: var(--color-added); background: rgba(40, 167, 69, 0.1); }
        .minimap-item.removed { border-left-color: var(--color-removed); background: rgba(220, 53, 69, 0.1); }
        .minimap-item.changed { border-left-color: var(--color-changed); background: rgba(255, 193, 7, 0.1); }
        .minimap-item.schema-error { border-left-color: var(--color-error); background: rgba(220, 53, 69, 0.15); }

        .minimap-path {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Enhanced Diff Display */
        .diff-panel {
            position: relative;
            margin-bottom: 20px;
        }

        .diff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 6px 6px 0 0;
            border-bottom: 1px solid var(--border-color);
        }

        .diff-title {
            font-weight: bold;
            font-size: 14px;
        }

        .diff-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .view-toggle button {
            padding: 4px 8px;
            border: none;
            background: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .view-toggle button.active {
            background: var(--accent-color);
            color: white;
        }

        .view-toggle button:hover:not(.active) {
            background: var(--hover-color);
        }

        /* Inline Diff Highlighting */
        .inline-diff {
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .char-added {
            background: rgba(40, 167, 69, 0.3);
            color: #155724;
            padding: 0 1px;
        }

        .char-removed {
            background: rgba(220, 53, 69, 0.3);
            color: #721c24;
            text-decoration: line-through;
            padding: 0 1px;
        }

        .char-unchanged {
            opacity: 0.7;
        }

        /* Importance-based Color Coding */
        .importance-critical { border-left: 4px solid #dc3545; background: rgba(220, 53, 69, 0.05); }
        .importance-high { border-left: 4px solid #fd7e14; background: rgba(253, 126, 20, 0.05); }
        .importance-medium { border-left: 4px solid #ffc107; background: rgba(255, 193, 7, 0.05); }
        .importance-low { border-left: 4px solid #6c757d; background: rgba(108, 117, 125, 0.05); }

        /* Grouped Diff View */
        .grouped-diff {
            margin: 15px 0;
        }

        .diff-group {
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .group-header {
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-header:hover {
            background: var(--hover-color);
        }

        .group-count {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: normal;
        }

        .group-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .group-content.collapsed {
            display: none;
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .analytics-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .analytics-export {
            display: flex;
            gap: 8px;
        }

        .analytics-export button {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .analytics-export button:hover {
            background: var(--hover-color);
            border-color: var(--accent-color);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .analytics-card {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
        }

        .card-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin: 10px 0;
        }

        .chart-container canvas {
            max-height: 100%;
        }

        /* Heatmap Styles */
        .heatmap-container {
            display: grid;
            gap: 2px;
            margin: 10px 0;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .heatmap-cell.intensity-0 { background: var(--bg-secondary); }
        .heatmap-cell.intensity-1 { background: rgba(40, 167, 69, 0.2); }
        .heatmap-cell.intensity-2 { background: rgba(40, 167, 69, 0.4); }
        .heatmap-cell.intensity-3 { background: rgba(40, 167, 69, 0.6); }
        .heatmap-cell.intensity-4 { background: rgba(40, 167, 69, 0.8); }
        .heatmap-cell.intensity-5 { background: rgba(40, 167, 69, 1.0); }

        /* Timeline Styles */
        .timeline-container {
            margin: 15px 0;
        }

        .timeline-track {
            position: relative;
            height: 60px;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin: 10px 0;
            overflow: hidden;
        }

        .timeline-item {
            position: absolute;
            top: 10px;
            height: 40px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .timeline-item:hover {
            transform: scaleY(1.1);
            z-index: 10;
        }

        .timeline-item.added { background: var(--color-added); }
        .timeline-item.removed { background: var(--color-removed); }
        .timeline-item.changed { background: var(--color-changed); }

        /* Responsive adjustments for analytics */
        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .minimap-container {
                position: relative;
                width: 100%;
                margin: 10px 0;
            }
            
            .diff-header {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
        }

        /* Additional styles for enhanced diff display */
        .highlighted-row {
            background: rgba(255, 193, 7, 0.3) !important;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
            transition: all 0.3s ease;
        }

        .metrics-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: var(--text-color);
        }

        .metric-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        .diff-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid transparent;
        }

        .diff-path {
            font-size: 12px;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .diff-reason {
            font-size: 13px;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .diff-values {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
        }

        .old-value, .new-value {
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--bg-secondary);
        }

        /* Results layout with minimap */
        .results-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .results-main {
            flex: 1;
            min-width: 0;
        }

        .results-sidebar {
            flex-shrink: 0;
        }

        /* Tree view styles */
        .json-tree-view {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
        }

        .tree-node {
            margin: 2px 0;
        }

        .tree-node-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tree-node-header:hover {
            background: var(--hover-color);
        }

        .tree-node-normal { color: var(--text-color); }
        .tree-node-added { 
            background: rgba(40, 167, 69, 0.1); 
            border-left: 3px solid var(--color-added); 
        }
        .tree-node-removed { 
            background: rgba(220, 53, 69, 0.1); 
            border-left: 3px solid var(--color-removed); 
        }
        .tree-node-changed { 
            background: rgba(255, 193, 7, 0.1); 
            border-left: 3px solid var(--color-changed); 
        }
        .tree-node-schema-error { 
            background: rgba(220, 53, 69, 0.15); 
            border-left: 3px solid var(--color-error); 
        }

        .tree-toggle {
            font-family: monospace;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
            width: 12px;
            text-align: center;
        }

        .tree-spacer {
            width: 12px;
            text-align: center;
            font-size: 8px;
            opacity: 0.5;
        }

        .tree-key {
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .tree-diff-count {
            background: var(--accent-color);
            color: white;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 8px;
            margin-left: auto;
        }

        .tree-node-content {
            margin-left: 18px;
            border-left: 1px dotted var(--border-color);
            padding-left: 10px;
        }

        .tree-node-content.collapsed {
            display: none;
        }

        .tree-diff-item {
            padding: 6px 10px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .diff-type {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 10px;
            min-width: 60px;
            text-align: center;
        }

        .diff-reason {
            flex: 1;
            color: var(--text-color);
        }

        /* Sync scroll between diff panels */
        .diff-sync-scroll {
            overflow-y: auto;
            max-height: 400px;
        }

        .diff-sync-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .diff-sync-scroll::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .diff-sync-scroll::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

        .diff-sync-scroll::-webkit-scrollbar-thumb:hover {
            background: #0056b3;
        }
    </style>
  </head>
<body>
    <!-- Skip Navigation -->
    <a href="#main-content" class="skip-link">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≤–º—ñ—Å—Ç—É</a>
    <a href="#results" class="skip-link">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</a>
    
    <!-- Live region for screen reader announcements -->
    <div id="live-region" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Scroll to top button -->
    <div class="tooltip-container">
        <button id="scrollToTopBtn" aria-label="–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ø–æ—á–∞—Ç–∫—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏">
            ‚Üë
        </button>
        <span class="tooltip">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ø–æ—á–∞—Ç–∫—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏</span>
    </div>
    
    <div id="app-content">
        <div id="loader"><div class="loader-spinner"></div></div>
        <div id="settingsModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</h2>
                    <button class="modal-close" id="closeSettingsModal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏ –≤—ñ–∫–Ω–æ">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Templates Section -->
                    <div class="form-group">
                        <label class="tooltip-container">
                            üìã –®–∞–±–ª–æ–Ω–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
                            <span class="tooltip">
                                –ó–±–µ—Ä–µ–∂—ñ—Ç—å –ø–æ—Ç–æ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —è–∫ —à–∞–±–ª–æ–Ω –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≥–æ—Ç–æ–≤–∏–π
                            </span>
                        </label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <select id="settingsTemplates" style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color);">
                                <option value="">–û–±–µ—Ä—ñ—Ç—å —à–∞–±–ª–æ–Ω...</option>
                                <option value="default">üè† –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</option>
                                <option value="api-comparison">üîå API –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</option>
                                <option value="config-files">‚öôÔ∏è –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ —Ñ–∞–π–ª–∏</option>
                                <option value="strict-validation">üîí –°—Ç—Ä–æ–≥–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è</option>
                                <option value="loose-comparison">üîì –ú'—è–∫–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</option>
                            </select>
                            <button type="button" id="loadTemplate" class="action-btn" style="padding: 8px 12px; font-size: 0.9em;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newTemplateName" placeholder="–ù–∞–∑–≤–∞ –Ω–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω—É..." style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--main-color); color: var(--text-color);">
                            <button type="button" id="saveTemplate" class="action-btn" style="padding: 8px 12px; font-size: 0.9em;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                            <button type="button" id="deleteTemplate" class="action-btn" style="padding: 8px 12px; font-size: 0.9em; background: var(--red);">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </div>
                    </div>
                    
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">
                    
                    <div class="form-group">
                        <label for="ignorePaths" class="tooltip-container">
                            –ü–æ–ª—è –¥–ª—è —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è (JSONPath)
                            <span class="tooltip">
                                –í–∫–∞–∂—ñ—Ç—å —à–ª—è—Ö–∏ –¥–æ –ø–æ–ª—ñ–≤, —è–∫—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏.<br>
                                –ö–æ–∂–µ–Ω —à–ª—è—Ö –∑ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞.<br>
                                –ù–∞–ø—Ä–∏–∫–ª–∞–¥: `$.updatedAt` –∞–±–æ `$.items[*].timestamp`
                            </span>
                        </label>
                        <textarea id="ignorePaths" placeholder="$.timestamp&#10;$.user.lastLogin"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="tooltip-container">
                            –†–µ–∂–∏–º –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –º–∞—Å–∏–≤—ñ–≤
                            <span class="tooltip">
                                "–†–æ–∑—É–º–Ω–∏–π" —Ä–µ–∂–∏–º: —à—É–∫–∞—î –æ–±'—î–∫—Ç–∏ –≤ –º–∞—Å–∏–≤–∞—Ö –∑–∞ –∫–ª—é—á–µ–º (id, name), —ñ–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ–≤–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–∏—Ö —Å–ø–∏—Å–∫—ñ–≤.<br>
                                "–ü—Ä–æ—Å—Ç–∏–π" —Ä–µ–∂–∏–º –ø–æ—Ä—ñ–≤–Ω—é—î –µ–ª–µ–º–µ–Ω—Ç–∏ –º–∞—Å–∏–≤—ñ–≤ –∑–∞ —ó—Ö–Ω—å–æ—é –ø–æ–∑–∏—Ü—ñ—î—é (—ñ–Ω–¥–µ–∫—Å–æ–º), —â–æ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –≤–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–∏—Ö —Å–ø–∏—Å–∫—ñ–≤.
                            </span>
                        </label>
                        <div class="radio-group">
                            <input type="radio" id="arrayModeKey" name="arrayCompareMode" value="key" checked>
                            <label for="arrayModeKey">–†–æ–∑—É–º–Ω–∏–π (–∑–∞ –∫–ª—é—á–µ–º)</label>
                            <input type="radio" id="arrayModeIndex" name="arrayCompareMode" value="index">
                            <label for="arrayModeIndex">–ü—Ä–æ—Å—Ç–∏–π (–∑–∞ —ñ–Ω–¥–µ–∫—Å–æ–º)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="caseSensitive">
                            <label for="caseSensitive" class="tooltip-container">
                                –í—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ —Ä–µ–≥—ñ—Å—Ç—Ä —Å–∏–º–≤–æ–ª—ñ–≤
                                <span class="tooltip">
                                    –Ø–∫—â–æ –≤–∏–º–∫–Ω–µ–Ω–æ, "Text" —Ç–∞ "text" –±—É–¥—É—Ç—å –≤–≤–∞–∂–∞—Ç–∏—Å—è –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏.
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- AI Settings Section -->
                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">
                    <h3 style="margin: 0 0 20px 0; color: var(--header-color); display: flex; align-items: center; gap: 8px;">
                        ü§ñ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Gemini AI
                    </h3>
                    
                    <div class="form-group">
                        <label for="geminiApiKey" class="tooltip-container">
                            Gemini API –∫–ª—é—á
                            <span class="tooltip">
                                –í–≤–µ–¥—ñ—Ç—å –≤–∞—à API –∫–ª—é—á –≤—ñ–¥ Google AI Studio.<br>
                                –û—Ç—Ä–∏–º–∞—Ç–∏ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –∫–ª—é—á: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
                            </span>
                        </label>
                        <input type="password" id="geminiApiKey" placeholder="–í–≤–µ–¥—ñ—Ç—å API –∫–ª—é—á...">
                        <button type="button" id="testApiKey" class="action-btn" style="margin-top: 10px; padding: 5px 10px; font-size: 0.9em;">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–ª—é—á</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="geminiModel" class="tooltip-container">
                            –ú–æ–¥–µ–ª—å Gemini
                            <span class="tooltip">
                                –í–∏–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É.<br>
                                Pro —à–≤–∏–¥—à–∞, Pro Vision –ø—ñ–¥—Ç—Ä–∏–º—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                            </span>
                        </label>
                        <select id="geminiModel">
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash (—à–≤–∏–¥–∫–∞)</option>
                            <option value="gemini-1.5-pro" selected>Gemini 1.5 Pro (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞)</option>
                            <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="tooltip-container">
                            –¢–∏–ø –∞–Ω–∞–ª—ñ–∑—É
                            <span class="tooltip">
                                –í–∏–±–µ—Ä—ñ—Ç—å —è–∫–∏–π —Ç–∏–ø –∞–Ω–∞–ª—ñ–∑—É –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ AI
                            </span>
                        </label>
                        <div class="checkbox-group" style="flex-direction: column; align-items: flex-start;">
                            <label><input type="checkbox" id="aiAnalyzeSummary" checked> –ó–∞–≥–∞–ª—å–Ω–∏–π –ø—ñ–¥—Å—É–º–æ–∫ –∑–º—ñ–Ω</label>
                            <label><input type="checkbox" id="aiAnalyzeImpact" checked> –ê–Ω–∞–ª—ñ–∑ –≤–ø–ª–∏–≤—É –∑–º—ñ–Ω</label>
                            <label><input type="checkbox" id="aiAnalyzeRisks" checked> –í–∏—è–≤–ª–µ–Ω–Ω—è —Ä–∏–∑–∏–∫—ñ–≤</label>
                            <label><input type="checkbox" id="aiAnalyzeRecommendations" checked> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</label>
                            <label><input type="checkbox" id="aiAnalyzeCategories"> –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—è</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="aiAutoAnalyze">
                            <label for="aiAutoAnalyze" class="tooltip-container">
                                –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑
                                <span class="tooltip">
                                    –ó–∞–ø—É—Å–∫–∞—Ç–∏ AI –∞–Ω–∞–ª—ñ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="saveSettingsBtn" class="action-btn">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div id="historyModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìö –Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä—ñ–≤–Ω—è–Ω—å</h2>
                    <button class="modal-close" id="closeHistoryModal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏ –≤—ñ–∫–Ω–æ">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="history-stats" id="historyStats">
                        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
                    </div>
                    
                    <div class="history-list" id="historyList">
                        <!-- History items will be inserted here -->
                    </div>
                    
                    <div class="history-empty" id="historyEmpty" style="display: none;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üìù</div>
                        <p>–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä—ñ–≤–Ω—è–Ω—å –ø—É—Å—Ç–∞</p>
                        <p style="font-size: 0.9em;">–í–∏–∫–æ–Ω–∞–π—Ç–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —Ç—É—Ç</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="clearHistoryBtn" class="action-btn" style="background: var(--red);">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é</button>
                    <button id="exportHistoryBtn" class="action-btn">üíæ –ï–∫—Å–ø–æ—Ä—Ç —ñ—Å—Ç–æ—Ä—ñ—ó</button>
                </div>
            </div>
        </div>

        <div class="container" id="main-container">
            <main id="main-content">
            <div class="header">
                 <div class="top-controls">
                    <span class="tooltip-container">
                        <button id="widthToggleBtn" aria-label="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —à–∏—Ä–∏–Ω—É">
                            <svg id="width-enter-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                            <svg id="width-exit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9 3h6v6M15 21H9v-6M3 9V3h6M21 15v6h-6"/></svg>
                        </button>
                        <span class="tooltip">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —à–∏—Ä–∏–Ω—É —Ä–æ–±–æ—á–æ—ó –æ–±–ª–∞—Å—Ç—ñ</span>
                    </span>
                    <div class="theme-switch-wrapper tooltip-container">
                        <label class="theme-switch" for="checkbox">
                            <input type="checkbox" id="checkbox" aria-label="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º–Ω—É —Ç–µ–º—É" />
                            <div class="slider round"></div>
                        </label>
                        <span class="tooltip">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Å–≤—ñ—Ç–ª—É/—Ç–µ–º–Ω—É —Ç–µ–º—É</span>
                    </div>
                    <span class="tooltip-container">
                        <button id="settingsBtn" aria-label="–†–æ–∑—à–∏—Ä–µ–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è">‚öôÔ∏è</button>
                        <span class="tooltip">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</span>
                    </span>
                </div>
                <h1>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π JSON Comparator</h1>
                <p>–ü–æ—Ä—ñ–≤–Ω—é–π—Ç–µ —Ñ–∞–π–ª–∏ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ —Å—Ö–µ–º–∏</p>
            </div>

            <div class="mode-selector" role="radiogroup" aria-labelledby="mode-selector-label">
                <span id="mode-selector-label" class="sr-only">–û–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</span>
                <input type="radio" id="modeDirect" name="compareMode" value="direct" checked aria-describedby="modeDirect-desc">
                <div class="tooltip-container">
                    <label for="modeDirect">–ü—Ä—è–º–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</label>
                    <span class="tooltip">–ü–æ—Ä—ñ–≤–Ω—é—î –≤—Å—ñ –ø–æ–ª—è —Ç–∞ –∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ–∂ –¥–≤–æ–º–∞ JSON —Ñ–∞–π–ª–∞–º–∏.<br/>–ü–æ–∫–∞–∑—É—î –≤—Å—ñ –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ: –¥–æ–¥–∞–Ω—ñ, –≤–∏–¥–∞–ª–µ–Ω—ñ —Ç–∞ –∑–º—ñ–Ω–µ–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏.<br/><strong>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –¥–ª—è:</strong> –ø–æ–≤–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π.</span>
                </div>
                <span id="modeDirect-desc" class="sr-only">–ü–æ—Ä—ñ–≤–Ω—é—î –≤—Å—ñ –∑–Ω–∞—á–µ–Ω–Ω—è —É JSON —Ñ–∞–π–ª–∞—Ö</span>
                
                <input type="radio" id="modeKeys" name="compareMode" value="keys" aria-describedby="modeKeys-desc">
                <div class="tooltip-container">
                    <label for="modeKeys">–õ–∏—à–µ –∫–ª—é—á—ñ</label>
                    <span class="tooltip">–ü–æ—Ä—ñ–≤–Ω—é—î —Ç—ñ–ª—å–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞ –Ω–∞–∑–≤–∏ –∫–ª—é—á—ñ–≤, —ñ–≥–Ω–æ—Ä—É—é—á–∏ –∑–Ω–∞—á–µ–Ω–Ω—è.<br/>–ö–æ—Ä–∏—Å–Ω–æ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ö–µ–º–∏ –±–µ–∑ –∞–Ω–∞–ª—ñ–∑—É –¥–∞–Ω–∏—Ö.<br/><strong>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –¥–ª—è:</strong> –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ JSON.</span>
                </div>
                <span id="modeKeys-desc" class="sr-only">–ü–æ—Ä—ñ–≤–Ω—é—î —Ç—ñ–ª—å–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–ª—é—á—ñ–≤ –±–µ–∑ –∑–Ω–∞—á–µ–Ω—å</span>

                <input type="radio" id="modeSchema" name="compareMode" value="schema" aria-describedby="modeSchema-desc">
                <div class="tooltip-container">
                    <label for="modeSchema">–í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ö–µ–º–∏</label>
                    <span class="tooltip">–ü–µ—Ä–µ–≤—ñ—Ä—è—î JSON —Ñ–∞–π–ª –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å JSON Schema.<br/>–í–∏—è–≤–ª—è—î –ø–æ—Ä—É—à–µ–Ω–Ω—è —Ç–∏–ø—ñ–≤ –¥–∞–Ω–∏—Ö, –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –ø–æ–ª—ñ–≤ —Ç–∞ –æ–±–º–µ–∂–µ–Ω—å.<br/><strong>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –¥–ª—è:</strong> –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö –∑–∞ —Å—Ö–µ–º–æ—é.<br/><strong>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞:</strong> AJV v8.17.1 + –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–æ—Ä–º–∞—Ç–∏ (email, date, uri, etc.)<br/><strong>–°—Ö–µ–º–∏:</strong> Draft 4, 6, 7, 2019-09, 2020-12</span>
                </div>
                <span id="modeSchema-desc" class="sr-only">–ü–µ—Ä–µ–≤—ñ—Ä—è—î JSON –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å —Å—Ö–µ–º—ñ</span>
            </div>

            <div class="drop-zones">
                <div id="dropZone1" class="drop-zone" role="region" aria-labelledby="dropZone1-label" aria-describedby="dropZone1-desc">
                    <label id="dropZone1-label" for="sourceText" class="sr-only">Source JSON —Ñ–∞–π–ª</label>
                    <span id="dropZone1-desc" class="sr-only">–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å JSON —Ñ–∞–π–ª –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —è–∫ –¥–∂–µ—Ä–µ–ª–æ</span>
                    <textarea id="sourceText" placeholder="–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Å—é–¥–∏ Source —Ñ–∞–π–ª –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ JSON" 
                              aria-labelledby="dropZone1-label" aria-describedby="dropZone1-desc sourceError"
                              aria-invalid="false"></textarea>
                    <div class="formatter-controls">
                        <button class="formatter-btn beautify" title="–§–æ—Ä–º–∞—Ç—É–≤–∞—Ç–∏ JSON" data-target="sourceText">‚ú® Format</button>
                        <button class="formatter-btn minify" title="–°—Ç–∏—Å–Ω—É—Ç–∏ JSON" data-target="sourceText">üì¶ Minify</button>
                        <button class="formatter-btn validate" title="–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ JSON" data-target="sourceText">‚úÖ Valid</button>
                    </div>
                    <div class="drop-indicator">
                        üìÑ –í—ñ–¥–ø—É—Å—Ç—ñ—Ç—å –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è JSON —Ñ–∞–π–ª—É
                    </div>
                    <div class="error-message" id="sourceError" role="alert" aria-live="polite"></div>
                    <span class="file-name" id="fileName1" aria-live="polite"></span>
                </div>
                <div id="dropZone2" class="drop-zone" role="region" aria-labelledby="dropZone2-label" aria-describedby="dropZone2-desc">
                    <label id="dropZone2-label" for="targetText" class="sr-only">Target JSON —Ñ–∞–π–ª</label>
                    <span id="dropZone2-desc" class="sr-only">–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å JSON —Ñ–∞–π–ª –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —è–∫ —Ü—ñ–ª—å</span>
                    <textarea id="targetText" placeholder="–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Å—é–¥–∏ Target —Ñ–∞–π–ª –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ JSON"
                              aria-labelledby="dropZone2-label" aria-describedby="dropZone2-desc targetError"
                              aria-invalid="false"></textarea>
                    <div class="formatter-controls">
                        <button class="formatter-btn beautify" title="–§–æ—Ä–º–∞—Ç—É–≤–∞—Ç–∏ JSON" data-target="targetText">‚ú® Format</button>
                        <button class="formatter-btn minify" title="–°—Ç–∏—Å–Ω—É—Ç–∏ JSON" data-target="targetText">üì¶ Minify</button>
                        <button class="formatter-btn validate" title="–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ JSON" data-target="targetText">‚úÖ Valid</button>
                    </div>
                    <div class="drop-indicator">
                        üìÑ –í—ñ–¥–ø—É—Å—Ç—ñ—Ç—å –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è JSON —Ñ–∞–π–ª—É
                    </div>
                    <div class="error-message" id="targetError" role="alert" aria-live="polite"></div>
                    <span class="file-name" id="fileName2" aria-live="polite"></span>
                </div>
                <div id="dropZoneSchema" class="drop-zone hidden" role="region" aria-labelledby="dropZoneSchema-label" aria-describedby="dropZoneSchema-desc">
                    <label id="dropZoneSchema-label" for="schemaText" class="sr-only">JSON Schema —Ñ–∞–π–ª</label>
                    <span id="dropZoneSchema-desc" class="sr-only">–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å JSON Schema —Ñ–∞–π–ª –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ —Å—Ö–µ–º—É –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó</span>
                                    <textarea id="schemaText" placeholder="–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Å—é–¥–∏ JSON Schema —Ñ–∞–π–ª –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ —Å—Ö–µ–º—É"
                          aria-labelledby="dropZoneSchema-label" aria-describedby="dropZoneSchema-desc schemaError"
                          aria-invalid="false"></textarea>
                    <div class="formatter-controls">
                        <button class="formatter-btn beautify" title="–§–æ—Ä–º–∞—Ç—É–≤–∞—Ç–∏ Schema" data-target="schemaText">‚ú® Format</button>
                        <button class="formatter-btn minify" title="–°—Ç–∏—Å–Ω—É—Ç–∏ Schema" data-target="schemaText">üì¶ Minify</button>
                        <button class="formatter-btn validate" title="–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Schema" data-target="schemaText">‚úÖ Valid</button>
                    </div>
                    <div class="drop-indicator">
                        üìã –í—ñ–¥–ø—É—Å—Ç—ñ—Ç—å –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è JSON Schema
                    </div>
                <div class="schema-examples" style="margin-top: 10px; font-size: 0.9em; color: var(--text-color); opacity: 0.7;">
                    <details>
                        <summary style="cursor: pointer; margin-bottom: 5px;">üìã –ü—Ä–∏–∫–ª–∞–¥–∏ JSON Schema</summary>
                        <div style="background: var(--bg-color); padding: 10px; border-radius: 4px; margin-top: 5px;">
                            <strong>–ë–∞–∑–æ–≤–∞ —Å—Ö–µ–º–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:</strong>
                            <button id="insertExampleSchema" style="float: right; background: var(--accent-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;" title="–í—Å—Ç–∞–≤–∏—Ç–∏ —Ü—é —Å—Ö–µ–º—É">üìã –í—Å—Ç–∞–≤–∏—Ç–∏</button>
                            <pre id="exampleSchemaText" style="font-size: 0.8em; margin: 5px 0; white-space: pre-wrap; clear: both;">{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["name", "email", "age"],
  "properties": {
    "name": { "type": "string", "minLength": 1 },
    "email": { "type": "string", "format": "email" },
    "age": { "type": "integer", "minimum": 0, "maximum": 150 },
    "phone": { "type": "string", "pattern": "^\\+?[1-9]\\d{1,14}$" }
  },
  "additionalProperties": false
}</pre>
                        </div>
                    </details>
                </div>
                    <div class="error-message" id="schemaError" role="alert" aria-live="polite"></div>
                    <span class="file-name" id="fileNameSchema" aria-live="polite"></span>
                </div>
            </div>

            <div class="controls">
                <span class="tooltip-container">
                    <button id="compareBtn" class="action-btn" disabled>–ü–æ—Ä—ñ–≤–Ω—è—Ç–∏</button>
                    <span class="tooltip">–†–æ–∑–ø–æ—á–∞—Ç–∏ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∞–±–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é —Ñ–∞–π–ª—ñ–≤</span>
                </span>
                
                <div class="export-container tooltip-container">
                    <button id="exportBtn" class="action-btn" style="display:none;">üíæ –ï–∫—Å–ø–æ—Ä—Ç</button>
                    <span class="tooltip">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–≤—ñ—Ç –ø—Ä–æ –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ —É —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö</span>
                    <div class="export-dropdown">
                        <a href="#" id="exportTxt">–¢–µ–∫—Å—Ç–æ–≤–∏–π –∑–≤—ñ—Ç (.txt)</a>
                        <a href="#" id="exportJson">JSON –∑–≤—ñ—Ç (.json)</a>
                        <a href="#" id="exportCsv">CSV –∑–≤—ñ—Ç (.csv)</a>
                    </div>
                </div>
                <span class="tooltip-container">
                    <button id="clearAllBtn" class="action-btn">–û—á–∏—Å—Ç–∏—Ç–∏</button>
                    <span class="tooltip">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –≤—Ö—ñ–¥–Ω—ñ –ø–æ–ª—è —Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</span>
                </span>
                <span class="tooltip-container">
                    <button id="historyBtn" class="action-btn">üìö –Ü—Å—Ç–æ—Ä—ñ—è</button>
                    <span class="tooltip">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</span>
                </span>
                <span class="tooltip-container">
                    <button id="copyResultsBtn" class="action-btn" style="display:none;">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                    <span class="tooltip">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –∑–≤—ñ—Ç –¥–æ –±—É—Ñ–µ—Ä–∞ –æ–±–º—ñ–Ω—É (CSV —Ñ–æ—Ä–º–∞—Ç)</span>
                </span>
                <span class="tooltip-container">
                    <button id="aiAnalyzeBtn" class="action-btn" style="display:none;">ü§ñ AI –ê–Ω–∞–ª—ñ–∑</button>
                    <span class="tooltip">–†–æ–∑—É–º–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –∑–º—ñ–Ω –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Gemini AI</span>
                </span>
                <span class="tooltip-container">
                    <button id="ajvDiagnosticsBtn" class="action-btn" style="display:none; background: #ffc107;">üîß AJV –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
                    <span class="tooltip">–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é —Å—Ö–µ–º–∏</span>
                </span>
                <span class="tooltip-container">
                    <button id="batchProcessingBtn" class="action-btn" style="background: #6f42c1;">üìÅ Batch</button>
                    <span class="tooltip">–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Ö —Ñ–∞–π–ª—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ</span>
                </span>
                <span class="tooltip-container">
                    <button id="aiSchemaGenerationBtn" class="action-btn" style="background: #e91e63;">üß† Schema</button>
                    <span class="tooltip">–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è JSON Schema –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é AI</span>
                </span>
                <span class="tooltip-container">
                    <button id="smartIgnoreBtn" class="action-btn" style="background: #795548;">üß© Smart Ignore</button>
                    <span class="tooltip">–†–æ–∑—É–º–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –ø–æ–ª—ñ–≤</span>
                </span>
            </div>

                            <div id="results" role="region" aria-labelledby="results-heading">
                </div>
                
                <!-- AI Analysis Results Section -->
                <div id="aiAnalysisSection" style="display:none;" role="region" aria-labelledby="ai-analysis-heading">
                    <div class="ai-analysis-container" style="margin-top: 20px; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color);">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <h3 id="ai-analysis-heading" style="margin: 0; color: var(--header-color);">ü§ñ AI –ê–Ω–∞–ª—ñ–∑ –∑–º—ñ–Ω</h3>
                            <div id="aiLoader" style="display: none; margin-left: 15px;">
                                <div style="width: 20px; height: 20px; border: 2px solid var(--border-color); border-top: 2px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            </div>
                        </div>
                        <div id="aiAnalysisContent">
                            <!-- AI analysis results will be inserted here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="toast-container"></div>
    
    <script>
        // --- Global Helper Functions (moved outside DOMContentLoaded for wider scope) ---

        // Toast Notifications
        const toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        document.body.appendChild(toastContainer); // Append toast container early
        function showToast(message, type = 'info', duration = 3000) {
            try {
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                toast.textContent = message;
                
                if (toastContainer && toastContainer.appendChild) {
                    toastContainer.appendChild(toast);
                } else {
                    console.warn('Toast container not available');
                    return;
                }

                void toast.offsetWidth; // Force reflow
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            } catch (e) {
                console.error('Error showing toast:', e);
                // Fallback to console log
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        // Enhanced HTML escaping for better XSS protection
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            
            const str = String(text);
            const map = { 
                '&': '&amp;', 
                '<': '&lt;', 
                '>': '&gt;', 
                '"': '&quot;', 
                "'": '&#x27;',
                '/': '&#x2F;',
                '`': '&#x60;',
                '=': '&#x3D;'
            };
            
            return str.replace(/[&<>"'`=\/]/g, m => map[m]);
        }

        // Additional sanitization for user input
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            
            // Remove potentially dangerous patterns
            const dangerous = [
                /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
                /<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,
                /javascript:/gi,
                /on\w+\s*=/gi,
                /data:text\/html/gi
            ];
            
            let sanitized = input;
            dangerous.forEach(pattern => {
                sanitized = sanitized.replace(pattern, '');
            });
            
            return sanitized;
        }

        // Validate file type and content
        function validateFileContent(content, filename) {
            // Check file extension
            const allowedExtensions = ['.json', '.txt'];
            const extension = filename.toLowerCase().substring(filename.lastIndexOf('.'));
            
            if (!allowedExtensions.includes(extension)) {
                throw new Error(`–ù–µ–ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏–π —Ç–∏–ø —Ñ–∞–π–ª—É: ${extension}. –î–æ–∑–≤–æ–ª–µ–Ω—ñ: ${allowedExtensions.join(', ')}`);
            }
            
            // Basic content validation
            if (typeof content !== 'string') {
                throw new Error('–í–º—ñ—Å—Ç —Ñ–∞–π–ª—É –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤–∏–º');
            }
            
            // Check for suspicious content
            const suspiciousPatterns = [
                /<script/i,
                /javascript:/i,
                /<iframe/i,
                /data:text\/html/i,
                /vbscript:/i
            ];
            
            for (const pattern of suspiciousPatterns) {
                if (pattern.test(content)) {
                    throw new Error('–§–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–π –≤–º—ñ—Å—Ç');
                }
            }
            
            return sanitizeInput(content);
        }

        // Helper for JSON syntax highlighting (used in both code and tree views)
        function applySyntaxHighlighting(value) {
            let formattedValue;
            if (typeof value === 'string') {
                formattedValue = `<span class="json-string">${escapeHtml(JSON.stringify(value))}</span>`; // Keep quotes, escape HTML
            } else if (typeof value === 'number') {
                formattedValue = `<span class="json-number">${value}</span>`;
            } else if (typeof value === 'boolean') {
                formattedValue = `<span class="json-boolean">${value}</span>`;
            } else if (value === null) {
                formattedValue = `<span class="json-null">null</span>`;
            } else {
                formattedValue = escapeHtml(String(value)); // Fallback, should not typically happen for primitives
            }
            return formattedValue;
        }

        // Helper to determine the diff class for a given path (used by both code and tree views)
        function getLineClass(path, isKeyLine, diffMap, side) {
            let lineClass = '';
            const type = diffMap.get(path);

            if (type) {
                if (side === 'target' && type.includes('Added')) lineClass = 'diff-added-text';
                else if (side === 'source' && type.includes('Removed')) lineClass = 'diff-removed-text';
                else if (type.includes('Changed') || type.includes('Error')) lineClass = 'diff-changed-text';
            } else if (isKeyLine) {
                // If it's a key line (parent of a value), check for child diffs for broader highlighting
                for (const [diffPathFromMap, diffType] of diffMap.entries()) {
                    const diffPathStr = String(diffPathFromMap); // Ensure it's a string
                    if (diffPathStr.startsWith(path + '.') || diffPathStr.startsWith(path + '[')) {
                        if (side === 'target' && diffType.includes('Added')) { lineClass = 'diff-added-text'; break; }
                        if (side === 'source' && diffType.includes('Removed')) { lineClass = 'diff-removed-text'; break; }
                        if (diffType.includes('Changed') || diffType.includes('Error')) { lineClass = 'diff-changed-text'; break; }
                    }
                }
            }
            return lineClass;
        }

        // --- JSON Traverse and Render (for code view) ---
        function jsonTraverseAndRender(obj, diffs, side, currentPath = '$', indentLevel = 0) {
            const indentSpace = ' '.repeat(indentLevel * 2);
            let html = '';
            const diffMap = new Map(diffs.map(d => [d.path, d.type]));

            const formatAndHighlightLine = (contentHtml, path, isKeyLine = false) => {
                const lineClass = getLineClass(path, isKeyLine, diffMap, side);
                return `<span class="diff-line${lineClass ? ' ' + lineClass : ''}" data-path="${path}">${contentHtml}</span>`;
            };

            if (typeof obj !== 'object' || obj === null) {
                return formatAndHighlightLine(applySyntaxHighlighting(obj), currentPath);
            }

            if (Array.isArray(obj)) {
                html += formatAndHighlightLine(indentSpace + '<span class="json-bracket">[</span>', currentPath) + '\n';
                
                const potentialKeys = ['id', 'productId', 'variantId', 'reviewId', 'key', 'name'];
                const bestKey = potentialKeys.find(key => obj.every(item => item && typeof item === 'object' && item[key] !== undefined));

                for (let i = 0; i < obj.length; i++) {
                    const item = obj[i];
                    let itemPath = `${currentPath}[${i}]`;

                    if (bestKey && typeof item === 'object' && item !== null && item[bestKey] !== undefined) {
                        itemPath = `${currentPath}[${bestKey}=${JSON.stringify(item[bestKey])}]`;
                    }
                    
                    html += jsonTraverseAndRender(item, diffs, side, itemPath, indentLevel + 1);
                    
                    if (i < obj.length - 1) {
                        html += `<span class="json-comma">,</span>`;
                    }
                    html += `\n`;
                }
                html += formatAndHighlightLine(indentSpace + '<span class="json-bracket">]</span>', currentPath);
            } else { // Object
                html += formatAndHighlightLine(indentSpace + '<span class="json-bracket">{</span>', currentPath) + '\n';
                const keys = Object.keys(obj);

                for (let i = 0; i < keys.length; i++) {
                    const key = keys[i];
                    const propPath = `${currentPath}.${key}`;
                    const value = obj[key];
                    
                    const valueHtml = jsonTraverseAndRender(value, diffs, side, propPath, indentLevel + 1);
                    
                    const keyLineContent = `<span class="json-key">"${escapeHtml(key)}"</span><span class="json-colon">:</span> ${valueHtml}`;
                    
                    html += formatAndHighlightLine(keyLineContent, propPath, true);
                    if (i < keys.length - 1) {
                        html += `<span class="json-comma">,</span>`;
                    }
                    html += `</span>\n`; // Close span for the line and add newline
                }
                html += formatAndHighlightLine(indentSpace + '<span class="json-bracket">}</span>', currentPath);
            }
            return html;
        }

        // --- JSON Tree View Functions ---
        function createJsonTree(data, containerElement, diffs, side) {
            console.log('Creating JSON tree for:', { 
                data: data, 
                side: side, 
                diffsCount: diffs.length,
                containerElement: containerElement 
            });
            
            containerElement.innerHTML = ''; // Clear previous tree
            const ul = document.createElement('ul');
            ul.classList.add('json-tree');
            let diffMap = new Map(diffs.map(d => [d.path, d.type]));

            function buildTree(node, path, parentUl) {
                const li = document.createElement('li');
                li.dataset.path = path;

                let nodeClass = getLineClass(path, true, diffMap, side);
                if (nodeClass && nodeClass.trim()) {
                    li.classList.add(nodeClass);
                }

                if (typeof node === 'object' && node !== null) {
                    const isArray = Array.isArray(node);
                    const toggleSpan = document.createElement('span');
                    toggleSpan.classList.add('tree-toggle');
                    
                    if (path !== '$' && path.includes('.')) { // Object property
                        const key = path.substring(path.lastIndexOf('.') + 1);
                        toggleSpan.innerHTML = `<span class="json-key">"${escapeHtml(key)}"</span><span class="json-colon">:</span> `;
                    } else if (path !== '$' && path.includes('[')) { // Array item
                        // Show array index or key for array items
                        const indexMatch = path.match(/\[([^\]]+)\]$/);
                        if (indexMatch) {
                            const indexOrKey = indexMatch[1];
                            if (indexOrKey.includes('=')) {
                                // Key-based indexing like [id=123]
                                const [keyName, keyValue] = indexOrKey.split('=');
                                toggleSpan.innerHTML = `<span class="json-key array-index">[${keyName}: ${keyValue}]</span> `;
                            } else {
                                // Numeric index like [0]
                                toggleSpan.innerHTML = `<span class="json-key array-index">[${indexOrKey}]</span> `;
                            }
                        }
                    }

                    // Initial state of brackets for toggle - –ø–æ–∫–∞–∑—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —É –∑–≥–æ—Ä–Ω—É—Ç–æ–º—É —Å—Ç–∞–Ω—ñ
                    const isCollapsed = path !== '$' ? true : false; // Root is expanded, others collapsed
                    
                    let bracketText;
                    if (isCollapsed) {
                        if (isArray) {
                            const itemText = node.length === 1 ? '–µ–ª–µ–º–µ–Ω—Ç' : (node.length < 5 ? '–µ–ª–µ–º–µ–Ω—Ç–∏' : '–µ–ª–µ–º–µ–Ω—Ç—ñ–≤');
                            bracketText = `[ ${node.length} ${itemText} ]`;
                        } else {
                            const keyCount = Object.keys(node).length;
                            const keyText = keyCount === 1 ? '–∫–ª—é—á' : (keyCount < 5 ? '–∫–ª—é—á—ñ' : '–∫–ª—é—á—ñ–≤');
                            bracketText = `{ ${keyCount} ${keyText} }`;
                        }
                    } else {
                        bracketText = isArray ? '[ - ]' : '{ - }';
                    }
                    
                    toggleSpan.innerHTML += `<span class="json-bracket">${bracketText}</span>`;

                    toggleSpan.addEventListener('click', (e) => {
                        e.stopPropagation();
                        li.classList.toggle('collapsed');
                        const isCollapsed = li.classList.contains('collapsed');
                        
                        // Dynamically calculate bracket text with count info
                        let bracketText;
                        if (isCollapsed) {
                            if (isArray) {
                                const itemText = node.length === 1 ? '–µ–ª–µ–º–µ–Ω—Ç' : (node.length < 5 ? '–µ–ª–µ–º–µ–Ω—Ç–∏' : '–µ–ª–µ–º–µ–Ω—Ç—ñ–≤');
                                bracketText = `[ ${node.length} ${itemText} ]`;
                            } else {
                                const keyCount = Object.keys(node).length;
                                const keyText = keyCount === 1 ? '–∫–ª—é—á' : (keyCount < 5 ? '–∫–ª—é—á—ñ' : '–∫–ª—é—á—ñ–≤');
                                bracketText = `{ ${keyCount} ${keyText} }`;
                            }
                        } else {
                            bracketText = isArray ? '[ - ]' : '{ - }';
                        }
                        
                        let currentKeyHtml = '';
                        if (path !== '$' && path.includes('.')) {
                            const key = path.substring(path.lastIndexOf('.') + 1);
                            currentKeyHtml = `<span class="json-key">"${escapeHtml(key)}"</span><span class="json-colon">:</span> `;
                        } else if (path !== '$' && path.includes('[')) {
                            // Show array index or key for array items
                            const indexMatch = path.match(/\[([^\]]+)\]$/);
                            if (indexMatch) {
                                const indexOrKey = indexMatch[1];
                                if (indexOrKey.includes('=')) {
                                    // Key-based indexing like [id=123]
                                    const [keyName, keyValue] = indexOrKey.split('=');
                                    currentKeyHtml = `<span class="json-key array-index">[${keyName}: ${keyValue}]</span> `;
                                } else {
                                    // Numeric index like [0]
                                    currentKeyHtml = `<span class="json-key array-index">[${indexOrKey}]</span> `;
                                }
                            }
                        }
                        toggleSpan.innerHTML = `${currentKeyHtml}<span class="json-bracket">${bracketText}</span>`;
                        
                        // Toggle child ul visibility
                        const childUlElement = li.querySelector('ul.nested');
                        if (childUlElement) {
                            childUlElement.style.display = isCollapsed ? 'none' : 'block';
                        }
                        
                        // Debounce height synchronization for better performance
                        clearTimeout(window.heightSyncTimeout);
                        window.heightSyncTimeout = setTimeout(synchronizeJsonViewHeights, 150);
                    });
                    li.appendChild(toggleSpan);

                    if (isArray) {
                        li.classList.add('array-node');
                        // Collapse nested nodes but keep root expanded
                        if (path !== '$') {
                            li.classList.add('collapsed');
                        }
                    } else {
                        li.classList.add('object-node');
                        // Collapse nested nodes but keep root expanded
                        if (path !== '$') {
                            li.classList.add('collapsed');
                        }
                    }

                    const childUl = document.createElement('ul');
                    childUl.classList.add('nested');
                    
                    // Set initial visibility based on collapsed state
                    if (path !== '$') {
                        childUl.style.display = 'none'; // Initially hidden for non-root nodes
                    } else {
                        childUl.style.display = 'block'; // Root node is always expanded initially
                    }

                    if (isArray) {
                        const innerPotentialKeys = ['id', 'productId', 'variantId', 'reviewId', 'key', 'name'];
                        const innerBestKey = innerPotentialKeys.find(key => node.every(item => item && typeof item === 'object' && item[key] !== undefined));

                        node.forEach((item, index) => {
                            let itemPath = `${path}[${index}]`;
                            if (innerBestKey && typeof item === 'object' && item !== null && item[innerBestKey] !== undefined) {
                                itemPath = `${path}[${innerBestKey}=${JSON.stringify(item[innerBestKey])}]`;
                            }
                            buildTree(item, itemPath, childUl);
                        });
                    } else { // Object
                        Object.keys(node).forEach(key => {
                            const propPath = `${path}.${key}`;
                            const value = node[key];
                            const childLi = document.createElement('li');
                            childLi.dataset.path = propPath;
                            const lineClass = getLineClass(propPath, true, diffMap, side);
                            if (lineClass && lineClass.trim()) {
                                childLi.classList.add(lineClass);
                            }
                            
                            if (typeof value !== 'object' || value === null) {
                                // Primitive value: display key-value directly in this <li>
                                try {
                                    childLi.innerHTML = `<span class="json-key">"${escapeHtml(key)}"</span><span class="json-colon">:</span> ${applySyntaxHighlighting(value)}`;
                                } catch (e) {
                                    console.error('Error rendering primitive value:', e);
                                    childLi.textContent = `"${key}": ${String(value)}`;
                                }
                            } else {
                                // Nested object/array: this <li> will have a toggle and a nested <ul>
                                const nestedToggleSpan = document.createElement('span');
                                nestedToggleSpan.classList.add('tree-toggle');
                                // Show count info for nested objects/arrays
                                let nestedBracketText;
                                if (Array.isArray(value)) {
                                    const itemText = value.length === 1 ? '–µ–ª–µ–º–µ–Ω—Ç' : (value.length < 5 ? '–µ–ª–µ–º–µ–Ω—Ç–∏' : '–µ–ª–µ–º–µ–Ω—Ç—ñ–≤');
                                    nestedBracketText = `[ ${value.length} ${itemText} ]`;
                                } else {
                                    const keyCount = Object.keys(value).length;
                                    const keyText = keyCount === 1 ? '–∫–ª—é—á' : (keyCount < 5 ? '–∫–ª—é—á—ñ' : '–∫–ª—é—á—ñ–≤');
                                    nestedBracketText = `{ ${keyCount} ${keyText} }`;
                                }
                                nestedToggleSpan.innerHTML = `<span class="json-key">"${escapeHtml(key)}"</span><span class="json-colon">:</span> <span class="json-bracket">${nestedBracketText}</span>`;
                                
                                nestedToggleSpan.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    childLi.classList.toggle('collapsed');
                                    const isCollapsed = childLi.classList.contains('collapsed');
                                    
                                    // Show count info when collapsed, simple brackets when expanded
                                    let bracketText;
                                    if (isCollapsed) {
                                        if (Array.isArray(value)) {
                                            const itemText = value.length === 1 ? '–µ–ª–µ–º–µ–Ω—Ç' : (value.length < 5 ? '–µ–ª–µ–º–µ–Ω—Ç–∏' : '–µ–ª–µ–º–µ–Ω—Ç—ñ–≤');
                                            bracketText = `[ ${value.length} ${itemText} ]`;
                                        } else {
                                            const keyCount = Object.keys(value).length;
                                            const keyText = keyCount === 1 ? '–∫–ª—é—á' : (keyCount < 5 ? '–∫–ª—é—á—ñ' : '–∫–ª—é—á—ñ–≤');
                                            bracketText = `{ ${keyCount} ${keyText} }`;
                                        }
                                    } else {
                                        bracketText = Array.isArray(value) ? '[ - ]' : '{ - }';
                                    }
                                    nestedToggleSpan.innerHTML = `<span class="json-key">"${escapeHtml(key)}"</span><span class="json-colon">:</span> <span class="json-bracket">${bracketText}</span>`;
                                    
                                    // Toggle child ul visibility
                                    const childUlElement = childLi.querySelector('ul.nested');
                                    if (childUlElement) {
                                        childUlElement.style.display = isCollapsed ? 'none' : 'block';
                                    }
                                    
                                    // Debounce height synchronization for better performance
                                    clearTimeout(window.heightSyncTimeout);
                                    window.heightSyncTimeout = setTimeout(synchronizeJsonViewHeights, 150);
                                });
                                childLi.appendChild(nestedToggleSpan);

                                const innerUl = document.createElement('ul');
                                innerUl.classList.add('nested');
                                if (Array.isArray(value)) innerUl.classList.add('array-node'); else innerUl.classList.add('object-node');
                                // Initial nested elements are collapsed
                                childLi.classList.add('collapsed');
                                innerUl.style.display = 'none'; // Initially hidden

                                buildTree(value, propPath, innerUl); // Recurse for the nested object/array
                                childLi.appendChild(innerUl);
                            }
                            childUl.appendChild(childLi);
                        });
                    }
                    li.appendChild(childUl); // Append the child list to the current li
                } else {
                    // Primitive value node
                    try {
                        li.innerHTML = applySyntaxHighlighting(node);
                    } catch (e) {
                        console.error('Error rendering primitive node:', e);
                        li.textContent = String(node);
                    }
                }
                parentUl.appendChild(li);
            }

            // Initial build for the root node
            buildTree(data, '$', ul);
            containerElement.appendChild(ul);
            
            // Ensure root level items are visible
            const rootItems = ul.querySelectorAll('ul.nested');
            rootItems.forEach(item => {
                if (item.parentElement.dataset.path === '$') {
                    item.style.display = 'block';
                }
            });
            
            console.log('JSON tree created successfully for', side, 'with', diffs.length, 'differences');
            synchronizeJsonViewHeights(); // Adjust heights after tree is built
        }

        // --- JSON View Toggle Logic ---
        function setupJsonViewToggle(sourceJson, targetJson, differences) {
            const radioButtons = document.querySelectorAll('input[name="jsonViewMode"]');
            const sourceCodeView = document.getElementById('sourceJsonViewCode');
            const targetCodeView = document.getElementById('targetJsonViewCode');
            const sourceTreeView = document.getElementById('sourceJsonViewTree');
            const targetTreeView = document.getElementById('targetJsonViewTree');
            
            // Re-create tree views every time to ensure they reflect current diffs/settings
            if (sourceJson) {
                createJsonTree(sourceJson, sourceTreeView, differences, 'source');
            } else {
                sourceTreeView.innerHTML = ''; // Clear if no source JSON
            }
            if (targetJson) {
                createJsonTree(targetJson, targetTreeView, differences, 'target');
            } else {
                targetTreeView.innerHTML = ''; // Clear if no target JSON
            }

            // Add event listeners to existing radio buttons
            radioButtons.forEach(radio => {
                radio.addEventListener('change', handleJsonViewChange);
            });

            function handleJsonViewChange(event) {
                if (event.target.value === 'code') {
                    if (sourceCodeView) sourceCodeView.style.display = 'block';
                    if (sourceTreeView) sourceTreeView.style.display = 'none';
                    if (targetCodeView) targetCodeView.style.display = 'block';
                    if (targetTreeView) targetTreeView.style.display = 'none';
                } else { // tree mode
                    if (sourceCodeView) sourceCodeView.style.display = 'none';
                    if (sourceTreeView) sourceTreeView.style.display = 'block';
                    if (targetCodeView) targetCodeView.style.display = 'none';
                    if (targetTreeView) targetTreeView.style.display = 'block';
                }
                synchronizeJsonViewHeights(); // Re-adjust heights after mode change
            }

            // Ensure initial state is "code" and heights are synced
            if (document.querySelector('input[name="jsonViewMode"][value="code"]').checked) {
                 synchronizeJsonViewHeights();
            } else {
                 // If tree mode was checked, ensure tree views are displayed
                if (sourceCodeView) sourceCodeView.style.display = 'none';
                if (sourceTreeView) sourceTreeView.style.display = 'block';
                if (targetCodeView) targetCodeView.style.display = 'none';
                if (targetTreeView) targetTreeView.style.display = 'block';
                synchronizeJsonViewHeights();
            }
        }


        // --- Global utility functions (moved to global scope to avoid duplication) ---
        function synchronizeJsonViewHeights() {
            const sourceViewCode = document.getElementById('sourceJsonViewCode'); 
            const targetViewCode = document.getElementById('targetJsonViewCode');
            const sourceViewTree = document.getElementById('sourceJsonViewTree');
            const targetViewTree = document.getElementById('targetJsonViewTree');

            const isCodeMode = document.querySelector('input[name="jsonViewMode"][value="code"]')?.checked || true;

            let currentSourceView = isCodeMode ? sourceViewCode : sourceViewTree;
            let currentTargetView = isCodeMode ? targetViewCode : targetViewTree;

            // Reset heights
            if (sourceViewCode) sourceViewCode.style.height = 'auto';
            if (targetViewCode) targetViewCode.style.height = 'auto';
            if (sourceViewTree) sourceViewTree.style.height = 'auto';
            if (targetViewTree) targetViewTree.style.height = 'auto';

            // Set max height for visible views
            if (currentSourceView && currentTargetView) {
                const maxHeight = Math.max(currentSourceView.scrollHeight, currentTargetView.scrollHeight);
                currentSourceView.style.height = `${maxHeight}px`;
                currentTargetView.style.height = `${maxHeight}px`;
            } else if (currentSourceView) { 
                currentSourceView.style.height = `${currentSourceView.scrollHeight}px`;
            } else if (currentTargetView) { 
                currentTargetView.style.height = `${currentTargetView.scrollHeight}px`;
            }
        }
        
        function setupCollapsibleSections() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                // Remove existing listeners to prevent duplicates
                const newHeader = header.cloneNode(true);
                header.parentNode.replaceChild(newHeader, header);
                newHeader.addEventListener('click', toggleCollapsible);
            });
        }

        function toggleCollapsible() {
            this.closest('.collapsible-section').classList.toggle('collapsed');
            setTimeout(synchronizeJsonViewHeights, 450); 
        }

        // --- Memory Management ---
        let globalEventCleanup = [];

        function addGlobalEventListener(element, event, handler, options = {}) {
            element.addEventListener(event, handler, options);
            globalEventCleanup.push(() => element.removeEventListener(event, handler, options));
        }

        function cleanupGlobalEvents() {
            globalEventCleanup.forEach(cleanup => {
                try {
                    cleanup();
                } catch (e) {
                    console.warn('Error during cleanup:', e);
                }
            });
            globalEventCleanup = [];
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanupGlobalEvents);

        // --- Loading Management ---
        function showLoader() {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.display = 'flex';
            }
        }

        function hideLoader() {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.display = 'none';
            }
        }

        // --- Performance Optimization ---
        
        // Chunk processing for large operations to prevent UI blocking
        function processInChunks(items, processor, chunkSize = 100, delay = 10) {
            return new Promise((resolve, reject) => {
                let index = 0;
                const results = [];

                function processChunk() {
                    const chunk = items.slice(index, index + chunkSize);
                    
                    try {
                        for (const item of chunk) {
                            results.push(processor(item));
                        }
                    } catch (error) {
                        reject(error);
                        return;
                    }

                    index += chunkSize;

                    if (index < items.length) {
                        setTimeout(processChunk, delay);
                    } else {
                        resolve(results);
                    }
                }

                processChunk();
            });
        }

        // Debounce function to limit frequent operations
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle function for scroll events
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // Virtual scrolling for large tables (basic implementation)
        function setupVirtualScrolling(container, items, renderItem, itemHeight = 40) {
            const totalHeight = items.length * itemHeight;
            const visibleCount = Math.ceil(container.clientHeight / itemHeight);
            let scrollTop = 0;

            const viewport = document.createElement('div');
            viewport.style.height = totalHeight + 'px';
            viewport.style.position = 'relative';

            const content = document.createElement('div');
            content.style.position = 'absolute';
            content.style.top = '0';
            content.style.width = '100%';

            viewport.appendChild(content);
            container.appendChild(viewport);

            function updateView() {
                const startIndex = Math.floor(scrollTop / itemHeight);
                const endIndex = Math.min(startIndex + visibleCount + 5, items.length);
                
                content.style.transform = `translateY(${startIndex * itemHeight}px)`;
                content.innerHTML = '';

                for (let i = startIndex; i < endIndex; i++) {
                    const item = renderItem(items[i], i);
                    item.style.height = itemHeight + 'px';
                    content.appendChild(item);
                }
            }

            container.addEventListener('scroll', throttle(() => {
                scrollTop = container.scrollTop;
                updateView();
            }, 16)); // ~60fps

            updateView();
        }

        // --- Scroll to Top Functionality ---
        function setupScrollToTop() {
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            if (!scrollToTopBtn) return;

            // Show/hide button based on scroll position
            function toggleScrollButton() {
                if (window.pageYOffset > 300) {
                    scrollToTopBtn.classList.add('show');
                } else {
                    scrollToTopBtn.classList.remove('show');
                }
            }

            // Smooth scroll to top
            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            // Add event listeners
            window.addEventListener('scroll', throttle(toggleScrollButton, 100));
            scrollToTopBtn.addEventListener('click', scrollToTop);

            // Initial check
            toggleScrollButton();
        }

        // --- Accessibility Functions ---
        function announceToScreenReader(message, priority = 'polite') {
            const liveRegion = document.getElementById('live-region');
            if (liveRegion) {
                liveRegion.setAttribute('aria-live', priority);
                liveRegion.textContent = message;
                
                // Clear after a delay to prevent repetition
                setTimeout(() => {
                    liveRegion.textContent = '';
                }, 1000);
            }
        }

        function updateAriaInvalid(element, isInvalid) {
            if (element) {
                element.setAttribute('aria-invalid', isInvalid ? 'true' : 'false');
            }
        }

        // Add keyboard navigation support
        function addKeyboardSupport() {
            document.addEventListener('keydown', (e) => {
                // Allow Escape to close modals
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal-overlay[style*="flex"]');
                    if (openModal) {
                        openModal.style.display = 'none';
                        e.preventDefault();
                    }
                }
            });

            // Improve tab navigation for tooltips
            document.querySelectorAll('.tooltip-container').forEach(container => {
                if (!container.hasAttribute('tabindex')) {
                    container.setAttribute('tabindex', '0');
                }
                
                let focusTimeoutId;
                
                addGlobalEventListener(container, 'focus', () => {
                    const tooltip = container.querySelector('.tooltip');
                    if (tooltip) {
                        clearTimeout(focusTimeoutId);
                        // –ó–∞—Ç—Ä–∏–º–∫–∞ 2 —Å–µ–∫—É–Ω–¥–∏ –¥–ª—è focus —Ç–∞–∫–æ–∂
                        focusTimeoutId = setTimeout(() => {
                            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –µ–ª–µ–º–µ–Ω—Ç –≤—Å–µ —â–µ –º–∞—î —Ñ–æ–∫—É—Å
                            if (document.activeElement === container || container.contains(document.activeElement)) {
                                positionTooltip(container, tooltip);
                                tooltip.style.visibility = 'visible';
                                tooltip.style.opacity = '1';
                                tooltip.style.transform = 'translateY(0)';
                            }
                        }, 2000);
                    }
                });

                addGlobalEventListener(container, 'blur', () => {
                    const tooltip = container.querySelector('.tooltip');
                    if (tooltip) {
                        clearTimeout(focusTimeoutId); // –°–∫–∞—Å–æ–≤—É—î–º–æ –ø–æ–∫–∞–∑ tooltip'–∞ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ —Ñ–æ–∫—É—Å–∞
                        tooltip.style.visibility = 'hidden';
                        tooltip.style.opacity = '0';
                        tooltip.style.transform = 'translateY(10px)';
                    }
                });
            });
        }

        // --- Missing utility functions ---
        function updateUiForMode() {
            const currentMode = document.querySelector('input[name="compareMode"]:checked')?.value || 'direct';
            const dropZoneSchema = document.getElementById('dropZoneSchema');
            
            if (currentMode === 'schema') {
                dropZoneSchema.classList.remove('hidden');
                dropZoneSchema.style.display = 'block';
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ AJV –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ —Ä–µ–∂–∏–º—É —Å—Ö–µ–º–∏
                if (!isAjvAvailable()) {
                    showToast(getSchemaValidationErrorMessage(), window.AjvEmergencyMode ? 'warning' : 'error', 5000);
                }
            } else {
                dropZoneSchema.classList.add('hidden'); 
                dropZoneSchema.style.display = 'none';
            }
        }

        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('jsonComparatorSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    
                    // Load ignore paths
                    const ignorePathsField = document.getElementById('ignorePaths');
                    if (ignorePathsField && settings.ignorePaths) {
                        ignorePathsField.value = settings.ignorePaths.join('\n');
                    }
                    
                    // Load array compare mode
                    const arrayModeRadio = document.querySelector(`input[name="arrayCompareMode"][value="${settings.arrayCompareMode || 'key'}"]`);
                    if (arrayModeRadio) {
                        arrayModeRadio.checked = true;
                    }
                    
                    // Load case sensitivity
                    const caseSensitiveCheck = document.getElementById('caseSensitive');
                    if (caseSensitiveCheck) {
                        caseSensitiveCheck.checked = settings.caseSensitive !== false;
                    }
                }
            } catch (error) {
                console.warn('Failed to load settings:', error);
            }
        }

        function saveSettings() {
            try {
                // Save comparison settings
                const ignorePathsField = document.getElementById('ignorePaths');
                const arrayCompareMode = document.querySelector('input[name="arrayCompareMode"]:checked')?.value || 'key';
                const caseSensitive = document.getElementById('caseSensitive')?.checked || true;
                
                const settings = {
                    ignorePaths: ignorePathsField ? ignorePathsField.value.split('\n').filter(path => path.trim()) : [],
                    arrayCompareMode: arrayCompareMode,
                    caseSensitive: caseSensitive
                };
                
                localStorage.setItem('jsonComparatorSettings', JSON.stringify(settings));
                
                // Update global settings variable if it exists
                if (typeof window.settings !== 'undefined') {
                    window.settings = settings;
                }
                
                // Save AI settings
                saveAiSettings();
                
                // Close modal
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) {
                    settingsModal.style.display = 'none';
                }
                
                showToast('–í—Å—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', 'success');
            } catch (error) {
                console.error('Failed to save settings:', error);
                showToast('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å!', 'error');
            }
        }

        function initializeTooltips() {
            // Add tooltip listeners to existing containers without cloning
            const containers = document.querySelectorAll('.tooltip-container');
            console.log(`Initializing ${containers.length} tooltip containers`);
            containers.forEach(container => {
                addTooltipListeners(container);
            });
        }

        function addTooltipListeners(container) {
            const tooltip = container.querySelector('.tooltip');
            if (!tooltip) return;

            let showTimeoutId;
            let hideTimeoutId;
            let mousePosition = { x: 0, y: 0 };
            let isMouseOver = false; // –§–ª–∞–≥ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó –∫—É—Ä—Å–æ—Ä–∞
            
            // –û—á–∏—â–∞—î–º–æ –≤—Å—ñ —ñ—Å–Ω—É—é—á—ñ timeout'–∏ –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
            clearTimeout(showTimeoutId);
            clearTimeout(hideTimeoutId);
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ tooltip –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
            
            /* 
             * –õ–æ–≥—ñ–∫–∞ —Ä–æ–±–æ—Ç–∏ tooltip'—ñ–≤:
             * 1. –ü—Ä–∏ mouseenter - –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —Ç–∞–π–º–µ—Ä –Ω–∞ 2 —Å–µ–∫—É–Ω–¥–∏
             * 2. –ü—Ä–∏ mouseleave - —Ç–∞–π–º–µ—Ä —Å–∫–∞—Å–æ–≤—É—î—Ç—å—Å—è + tooltip —Ö–æ–≤–∞—î—Ç—å—Å—è —è–∫—â–æ –±—É–≤ –≤–∏–¥–∏–º–∏–π
             * 3. –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è —á–∏ –∫—É—Ä—Å–æ—Ä –≤—Å–µ —â–µ –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ (–ø–æ–¥–≤—ñ–π–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞)
             * 4. –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –∫—É—Ä—Å–æ—Ä –∑–∞–ª–∏—à–∞–≤—Å—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ - –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è tooltip
             */

            // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è tooltip'–∞
            const hideTooltip = (delay = 100) => {
                clearTimeout(hideTimeoutId);
                hideTimeoutId = setTimeout(() => {
                    tooltip.style.visibility = 'hidden';
                    tooltip.style.opacity = '0';
                    tooltip.style.transform = 'translateY(10px)';
                }, delay);
            };

            // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É tooltip'–∞
            const showTooltip = () => {
                clearTimeout(hideTimeoutId);
                positionTooltipNearCursor(tooltip, mousePosition);
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
                tooltip.style.transform = 'translateY(0)';
            };

            const mouseMoveHandler = (e) => {
                // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –∫—É—Ä—Å–æ—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è tooltip'–∞
                mousePosition.x = e.clientX;
                mousePosition.y = e.clientY;
            };

            const mouseEnterHandler = (e) => {
                isMouseOver = true; // –ö—É—Ä—Å–æ—Ä –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ
                clearTimeout(showTimeoutId);
                clearTimeout(hideTimeoutId);
                
                mousePosition.x = e.clientX;
                mousePosition.y = e.clientY;
                
                // –ó–∞—Ç—Ä–∏–º–∫–∞ 2 —Å–µ–∫—É–Ω–¥–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º tooltip
                showTimeoutId = setTimeout(() => {
                    // –ü–æ–¥–≤—ñ–π–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: —Ñ–ª–∞–≥ + —Ä–µ–∞–ª—å–Ω–∞ –ø–æ–∑–∏—Ü—ñ—è –∫—É—Ä—Å–æ—Ä–∞
                    const elementUnderCursor = document.elementFromPoint(mousePosition.x, mousePosition.y);
                    const isStillOverElement = isMouseOver && (
                        elementUnderCursor === container || 
                        container.contains(elementUnderCursor)
                    );
                    
                    if (isStillOverElement) {
                        showTooltip();
                    }
                }, 2000);
            };

            const mouseLeaveHandler = () => {
                isMouseOver = false; // –ö—É—Ä—Å–æ—Ä –ø–æ–∫–∏–Ω—É–≤ –µ–ª–µ–º–µ–Ω—Ç
                clearTimeout(showTimeoutId); // –°–∫–∞—Å–æ–≤—É—î–º–æ –ø–æ–∫–∞–∑ tooltip'–∞
                
                // –•–æ–≤–∞—î–º–æ tooltip —è–∫—â–æ –≤—ñ–Ω –≤–∏–¥–∏–º–∏–π
                if (tooltip.style.visibility === 'visible') {
                    hideTooltip();
                }
            };

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è mouse events
            addGlobalEventListener(container, 'mousemove', mouseMoveHandler);
            addGlobalEventListener(container, 'mouseenter', mouseEnterHandler);
            addGlobalEventListener(container, 'mouseleave', mouseLeaveHandler);
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è touch events (–º–æ–±—ñ–ª—å–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó)
            let touchTimeoutId;
            
            addGlobalEventListener(container, 'touchstart', (e) => {
                clearTimeout(touchTimeoutId);
                const touch = e.touches[0];
                mousePosition.x = touch.clientX;
                mousePosition.y = touch.clientY;
                
                touchTimeoutId = setTimeout(() => {
                    // –î–ª—è touch events –ø–æ–∫–∞–∑—É—î–º–æ tooltip –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è —Ç–∞–π–º–∞—É—Ç—É
                    showTooltip();
                }, 2000);
            });
            
            addGlobalEventListener(container, 'touchend', () => {
                clearTimeout(touchTimeoutId);
                if (tooltip.style.visibility === 'visible') {
                    hideTooltip();
                }
            });
        }

        function positionTooltipNearCursor(tooltip, mousePos) {
            const windowHeight = window.innerHeight;
            const windowWidth = window.innerWidth;
            const offset = 15; // Distance from cursor



            // Reset positioning styles
            tooltip.style.position = 'fixed';
            tooltip.style.left = 'auto';
            tooltip.style.right = 'auto';
            tooltip.style.top = 'auto';
            tooltip.style.bottom = 'auto';
            tooltip.style.transform = 'none';
            tooltip.style.margin = '0';

            // Get tooltip dimensions (make it temporarily visible for measurement)
            const wasVisible = tooltip.style.visibility === 'visible';
            if (!wasVisible) {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '1';
            }
            
            const tooltipRect = tooltip.getBoundingClientRect();
            const tooltipWidth = tooltipRect.width || 200; // fallback width
            const tooltipHeight = tooltipRect.height || 50; // fallback height

            // Calculate preferred position (right of cursor)
            let left = mousePos.x + offset;
            let top = mousePos.y - tooltipHeight / 2;

            // Check boundaries and adjust
            if (left + tooltipWidth > windowWidth - 10) {
                // If doesn't fit on right, place on left
                left = mousePos.x - tooltipWidth - offset;
            }

            if (left < 10) {
                // If still doesn't fit, position at edge
                left = 10;
            }

            if (top < 10) {
                top = 10;
            } else if (top + tooltipHeight > windowHeight - 10) {
                top = windowHeight - tooltipHeight - 10;
            }

            // Apply final position
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';

            // Restore visibility state
            if (!wasVisible) {
                tooltip.style.visibility = 'hidden';
                tooltip.style.opacity = '0';
            }
        }

        // Legacy function for focus-based positioning
        function positionTooltip(container, tooltip) {
            const containerRect = container.getBoundingClientRect();
            const mousePos = {
                x: containerRect.left + containerRect.width / 2,
                y: containerRect.top + containerRect.height / 2
            };
            positionTooltipNearCursor(tooltip, mousePos);
        }

        // --- Global utility functions for file handling ---
        
        // Global state variables
        let sourceFileContent = null;
        let targetFileContent = null;
        let schemaFileContent = null;
        let globalDifferences = [];
        let currentMode = 'direct';
        let settings = {
            ignorePaths: [],
            arrayCompareMode: 'key',
            caseSensitive: true,
        };

        // Analytics and visualization state
        let analyticsCharts = {};
        let currentViewMode = 'table'; // 'table', 'grouped', 'tree'

        // === VISUAL ENHANCEMENTS & ANALYTICS FUNCTIONS ===

        // Minimap Navigation
        function createMinimap(differences) {
            const minimapContainer = document.createElement('div');
            minimapContainer.className = 'minimap-container';
            
            const header = document.createElement('div');
            header.className = 'minimap-header';
            header.textContent = 'üó∫Ô∏è –ù–∞–≤—ñ–≥–∞—Ü—ñ—è';
            minimapContainer.appendChild(header);

            // Group differences by path hierarchy for better navigation
            const pathGroups = {};
            differences.forEach((diff, index) => {
                const pathParts = diff.path.split('.');
                const topLevel = pathParts.length > 1 ? pathParts[1] : pathParts[0];
                if (!pathGroups[topLevel]) {
                    pathGroups[topLevel] = [];
                }
                pathGroups[topLevel].push({ ...diff, originalIndex: index });
            });

            Object.keys(pathGroups).forEach(groupName => {
                const groupItems = pathGroups[groupName];
                const firstItem = groupItems[0];
                
                const minimapItem = document.createElement('div');
                minimapItem.className = `minimap-item ${getMinimapClass(firstItem.type)}`;
                
                const pathSpan = document.createElement('span');
                pathSpan.className = 'minimap-path';
                pathSpan.textContent = `${groupName} (${groupItems.length})`;
                minimapItem.appendChild(pathSpan);

                minimapItem.addEventListener('click', () => {
                    scrollToTableRow(firstItem.originalIndex);
                    highlightTableRow(firstItem.originalIndex);
                });

                minimapContainer.appendChild(minimapItem);
            });

            return minimapContainer;
        }

        function getMinimapClass(diffType) {
            if (diffType.toLowerCase().includes('add')) return 'added';
            if (diffType.toLowerCase().includes('remov')) return 'removed';
            if (diffType.toLowerCase().includes('schema')) return 'schema-error';
            return 'changed';
        }

        function scrollToTableRow(index) {
            const table = document.querySelector('#results table');
            if (table) {
                const rows = table.querySelectorAll('tbody tr');
                if (rows[index]) {
                    rows[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function highlightTableRow(index) {
            // Remove previous highlights
            document.querySelectorAll('.highlighted-row').forEach(row => {
                row.classList.remove('highlighted-row');
            });

            const table = document.querySelector('#results table');
            if (table) {
                const rows = table.querySelectorAll('tbody tr');
                if (rows[index]) {
                    rows[index].classList.add('highlighted-row');
                    setTimeout(() => {
                        rows[index].classList.remove('highlighted-row');
                    }, 3000);
                }
            }
        }

        // Character-level inline diff
        function createInlineDiff(oldText, newText) {
            if (!oldText && !newText) return '';
            if (!oldText) return `<span class="char-added">${escapeHtml(newText)}</span>`;
            if (!newText) return `<span class="char-removed">${escapeHtml(oldText)}</span>`;

            // Simple character-level diff algorithm
            const oldStr = String(oldText);
            const newStr = String(newText);
            
            if (oldStr === newStr) {
                return `<span class="char-unchanged">${escapeHtml(oldStr)}</span>`;
            }

            // Use LCS (Longest Common Subsequence) for better diff
            const diff = computeCharDiff(oldStr, newStr);
            return diff.map(part => {
                if (part.type === 'equal') {
                    return `<span class="char-unchanged">${escapeHtml(part.value)}</span>`;
                } else if (part.type === 'delete') {
                    return `<span class="char-removed">${escapeHtml(part.value)}</span>`;
                } else {
                    return `<span class="char-added">${escapeHtml(part.value)}</span>`;
                }
            }).join('');
        }

        function computeCharDiff(oldStr, newStr) {
            // Simplified diff algorithm
            const result = [];
            let i = 0, j = 0;
            
            while (i < oldStr.length || j < newStr.length) {
                if (i < oldStr.length && j < newStr.length && oldStr[i] === newStr[j]) {
                    // Characters match
                    let start = i;
                    while (i < oldStr.length && j < newStr.length && oldStr[i] === newStr[j]) {
                        i++; j++;
                    }
                    result.push({ type: 'equal', value: oldStr.substring(start, i) });
                } else {
                    // Characters don't match
                    let deletedPart = '';
                    let addedPart = '';
                    
                    // Collect deleted characters
                    while (i < oldStr.length && (j >= newStr.length || oldStr[i] !== newStr[j])) {
                        deletedPart += oldStr[i];
                        i++;
                    }
                    
                    // Collect added characters
                    while (j < newStr.length && (i >= oldStr.length || oldStr[i] !== newStr[j])) {
                        addedPart += newStr[j];
                        j++;
                    }
                    
                    if (deletedPart) result.push({ type: 'delete', value: deletedPart });
                    if (addedPart) result.push({ type: 'insert', value: addedPart });
                }
            }
            
            return result;
        }

        // Determine importance level for color coding
        function getImportanceLevel(diff) {
            const path = diff.path.toLowerCase();
            const type = diff.type.toLowerCase();
            
            // Critical importance
            if (type.includes('schema') || path.includes('id') || path.includes('key')) {
                return 'critical';
            }
            
            // High importance
            if (type.includes('type') || path.includes('status') || path.includes('state')) {
                return 'high';
            }
            
            // Medium importance
            if (type.includes('value') || path.includes('name') || path.includes('title')) {
                return 'medium';
            }
            
            // Low importance (default)
            return 'low';
        }

        // Grouped diff view
        function createGroupedDiffView(differences) {
            const grouped = {};
            
            differences.forEach(diff => {
                const groupKey = diff.type;
                if (!grouped[groupKey]) {
                    grouped[groupKey] = [];
                }
                grouped[groupKey].push(diff);
            });

            const container = document.createElement('div');
            container.className = 'grouped-diff';

            Object.keys(grouped).forEach(groupType => {
                const group = grouped[groupType];
                const groupDiv = document.createElement('div');
                groupDiv.className = 'diff-group';

                const header = document.createElement('div');
                header.className = 'group-header';
                header.innerHTML = `
                    <span>${groupType}</span>
                    <span class="group-count">${group.length}</span>
                `;

                const content = document.createElement('div');
                content.className = 'group-content';
                
                group.forEach(diff => {
                    const item = document.createElement('div');
                    item.className = `diff-item importance-${getImportanceLevel(diff)}`;
                    item.innerHTML = `
                        <div class="diff-path"><code>${escapeHtml(diff.path)}</code></div>
                        <div class="diff-reason">${escapeHtml(diff.reason)}</div>
                        <div class="diff-values">
                            <div class="old-value"><strong>–ë—É–ª–æ:</strong> <code>${escapeHtml(diff.oldValue || '–Ω/–¥')}</code></div>
                            <div class="new-value"><strong>–°—Ç–∞–ª–æ:</strong> <code>${escapeHtml(diff.newValue || '–Ω/–¥')}</code></div>
                        </div>
                    `;
                    content.appendChild(item);
                });

                header.addEventListener('click', () => {
                    content.classList.toggle('collapsed');
                });

                groupDiv.appendChild(header);
                groupDiv.appendChild(content);
                container.appendChild(groupDiv);
            });

            return container;
        }

        // Analytics Dashboard Creation
        function createAnalyticsDashboard(differences, sourceJson, targetJson) {
            const dashboard = document.createElement('div');
            dashboard.className = 'analytics-dashboard';

            const header = document.createElement('div');
            header.className = 'analytics-header';
            header.innerHTML = `
                <h3 class="analytics-title">üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –∑–º—ñ–Ω</h3>
                <div class="analytics-export">
                    <button onclick="exportAnalytics('excel')">Excel –∑–≤—ñ—Ç</button>
                    <button onclick="exportAnalytics('detailed-csv')">–î–µ—Ç–∞–ª—å–Ω–∏–π CSV</button>
                    <button onclick="generateInsights()">üí° –Ü–Ω—Å–∞–π—Ç–∏</button>
                </div>
            `;

            const grid = document.createElement('div');
            grid.className = 'analytics-grid';

            // Create various analytics cards
            grid.appendChild(createChangeDistributionChart(differences));
            grid.appendChild(createImportanceLevelChart(differences));
            grid.appendChild(createComplexityMetrics(differences, sourceJson, targetJson));
            grid.appendChild(createPathAnalysisChart(differences));
            grid.appendChild(createTimelineAnalysis(differences));

            dashboard.appendChild(header);
            dashboard.appendChild(grid);

            // Add heatmap if enough data
            if (differences.length > 10) {
                dashboard.appendChild(createStructureHeatmap(differences, sourceJson, targetJson));
            }

            return dashboard;
        }

        // Individual analytics components
        function createChangeDistributionChart(differences) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            card.innerHTML = `
                <div class="card-title">–†–æ–∑–ø–æ–¥—ñ–ª —Ç–∏–ø—ñ–≤ –∑–º—ñ–Ω</div>
                <div class="chart-container">
                    <canvas id="changeDistributionChart"></canvas>
                </div>
            `;

            // Count change types
            const typeCounts = {};
            differences.forEach(diff => {
                const type = diff.type;
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            // Create chart after element is added to DOM
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    const ctx = document.getElementById('changeDistributionChart');
                    if (ctx) {
                        analyticsCharts.distribution = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(typeCounts),
                                datasets: [{
                                    data: Object.values(typeCounts),
                                    backgroundColor: [
                                        '#28a745', '#dc3545', '#ffc107', 
                                        '#17a2b8', '#6f42c1', '#fd7e14'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            font: { size: 10 }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            }, 100);

            return card;
        }

        function createImportanceLevelChart(differences) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            card.innerHTML = `
                <div class="card-title">–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ –≤–∞–∂–ª–∏–≤—ñ—Å—Ç—é</div>
                <div class="chart-container">
                    <canvas id="importanceLevelChart"></canvas>
                </div>
            `;

            // Count importance levels
            const importanceCounts = {
                'critical': 0,
                'high': 0,
                'medium': 0,
                'low': 0
            };

            differences.forEach(diff => {
                const importance = getImportanceLevel(diff);
                importanceCounts[importance]++;
            });

            // Remove zero counts for cleaner chart
            const nonZeroImportance = {};
            Object.entries(importanceCounts).forEach(([level, count]) => {
                if (count > 0) {
                    nonZeroImportance[level] = count;
                }
            });

            const importanceLabels = {
                'critical': 'üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∞',
                'high': 'üü° –í–∏—Å–æ–∫–∞',
                'medium': 'üü¢ –°–µ—Ä–µ–¥–Ω—è',
                'low': '‚ö™ –ù–∏–∑—å–∫–∞'
            };

            const importanceColors = {
                'critical': '#dc3545',
                'high': '#fd7e14',
                'medium': '#ffc107',
                'low': '#6c757d'
            };

            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    const ctx = document.getElementById('importanceLevelChart');
                    if (ctx) {
                        analyticsCharts.importance = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: Object.keys(nonZeroImportance).map(level => importanceLabels[level]),
                                datasets: [{
                                    data: Object.values(nonZeroImportance),
                                    backgroundColor: Object.keys(nonZeroImportance).map(level => importanceColors[level]),
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            font: { size: 10 },
                                            padding: 10
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            }, 100);

            return card;
        }

        function createComplexityMetrics(differences, sourceJson, targetJson) {
            const card = document.createElement('div');
            card.className = 'analytics-card';

            const sourceDepth = getObjectDepth(sourceJson);
            const targetDepth = getObjectDepth(targetJson);
            const avgPathLength = differences.reduce((sum, diff) => sum + diff.path.split('.').length, 0) / differences.length;
            const changeIntensity = differences.length / Math.max(getObjectSize(sourceJson), getObjectSize(targetJson));

            card.innerHTML = `
                <div class="card-title">–ú–µ—Ç—Ä–∏–∫–∏ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ</div>
                <div class="metrics-list">
                    <div class="metric-item">
                        <span class="metric-label">–ì–ª–∏–±–∏–Ω–∞ Source:</span>
                        <span class="metric-value">${sourceDepth} —Ä—ñ–≤–Ω—ñ–≤</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">–ì–ª–∏–±–∏–Ω–∞ Target:</span>
                        <span class="metric-value">${targetDepth} —Ä—ñ–≤–Ω—ñ–≤</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">–°–µ—Ä–µ–¥–Ω—è –≥–ª–∏–±–∏–Ω–∞ –∑–º—ñ–Ω:</span>
                        <span class="metric-value">${avgPathLength.toFixed(1)}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å –∑–º—ñ–Ω:</span>
                        <span class="metric-value">${(changeIntensity * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `;

            return card;
        }

        function getObjectSize(obj) {
            if (obj === null || obj === undefined) return 0;
            if (typeof obj !== 'object') return 1;
            
            let size = 0;
            if (Array.isArray(obj)) {
                size = obj.length;
                obj.forEach(item => size += getObjectSize(item));
            } else {
                size = Object.keys(obj).length;
                Object.values(obj).forEach(value => size += getObjectSize(value));
            }
            return size;
        }

        function createPathAnalysisChart(differences) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            card.innerHTML = `
                <div class="card-title">–ê–Ω–∞–ª—ñ–∑ —à–ª—è—Ö—ñ–≤ –∑–º—ñ–Ω</div>
                <div class="chart-container">
                    <canvas id="pathAnalysisChart"></canvas>
                </div>
            `;

            // Analyze path depths
            const depthCounts = {};
            differences.forEach(diff => {
                const depth = diff.path.split('.').length;
                depthCounts[depth] = (depthCounts[depth] || 0) + 1;
            });

            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    const ctx = document.getElementById('pathAnalysisChart');
                    if (ctx) {
                        analyticsCharts.pathAnalysis = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(depthCounts).map(d => `–†—ñ–≤–µ–Ω—å ${d}`),
                                datasets: [{
                                    label: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–º—ñ–Ω',
                                    data: Object.values(depthCounts),
                                    backgroundColor: '#007bff',
                                    borderColor: '#0056b3',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }
                }
            }, 100);

            return card;
        }

        function createTimelineAnalysis(differences) {
            const card = document.createElement('div');
            card.className = 'analytics-card';
            card.innerHTML = `<div class="card-title">Timeline –∞–Ω–∞–ª—ñ–∑</div>`;

            // Try to detect timestamp fields
            const timeFields = ['timestamp', 'createdAt', 'updatedAt', 'date', 'time'];
            const timelineData = [];

            differences.forEach(diff => {
                timeFields.forEach(field => {
                    if (diff.path.toLowerCase().includes(field.toLowerCase())) {
                        let timeValue = null;
                        try {
                            timeValue = new Date(diff.newValue || diff.oldValue);
                            if (!isNaN(timeValue.getTime())) {
                                timelineData.push({
                                    time: timeValue,
                                    type: diff.type,
                                    path: diff.path
                                });
                            }
                        } catch (e) {
                            // Ignore invalid dates
                        }
                    }
                });
            });

            if (timelineData.length > 0) {
                const timelineContainer = document.createElement('div');
                timelineContainer.className = 'timeline-container';
                
                timelineData.sort((a, b) => a.time - b.time);
                const minTime = timelineData[0].time.getTime();
                const maxTime = timelineData[timelineData.length - 1].time.getTime();
                const timeRange = maxTime - minTime || 1;

                const track = document.createElement('div');
                track.className = 'timeline-track';

                timelineData.forEach(item => {
                    const position = ((item.time.getTime() - minTime) / timeRange) * 100;
                    const timelineItem = document.createElement('div');
                    timelineItem.className = `timeline-item ${getMinimapClass(item.type)}`;
                    timelineItem.style.left = `${position}%`;
                    timelineItem.style.width = '8px';
                    timelineItem.title = `${item.path}: ${item.time.toLocaleDateString()}`;
                    track.appendChild(timelineItem);
                });

                timelineContainer.appendChild(track);
                card.appendChild(timelineContainer);
            } else {
                card.innerHTML += '<p style="text-align: center; color: #666; margin: 20px 0;">–ù–µ –≤–∏—è–≤–ª–µ–Ω–æ –ø–æ–ª—ñ–≤ –∑ –¥–∞—Ç–∞–º–∏ –¥–ª—è timeline –∞–Ω–∞–ª—ñ–∑—É</p>';
            }

            return card;
        }

        function createStructureHeatmap(differences, sourceJson, targetJson) {
            const container = document.createElement('div');
            container.innerHTML = '<div class="card-title">üî• Heatmap –∑–º—ñ–Ω –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ</div>';
            
            // Create a simplified heatmap based on path frequency
            const pathMap = {};
            differences.forEach(diff => {
                const pathParts = diff.path.split('.');
                pathParts.forEach((part, index) => {
                    const partialPath = pathParts.slice(0, index + 1).join('.');
                    pathMap[partialPath] = (pathMap[partialPath] || 0) + 1;
                });
            });

            const maxChanges = Math.max(...Object.values(pathMap));
            const heatmapContainer = document.createElement('div');
            heatmapContainer.className = 'heatmap-container';
            
            // Determine grid size based on data complexity
            const uniquePaths = Object.keys(pathMap);
            const gridSize = Math.min(20, Math.max(8, Math.ceil(Math.sqrt(uniquePaths.length))));
            heatmapContainer.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;

            uniquePaths.slice(0, gridSize * gridSize).forEach(path => {
                const intensity = Math.ceil((pathMap[path] / maxChanges) * 5);
                const cell = document.createElement('div');
                cell.className = `heatmap-cell intensity-${intensity}`;
                cell.title = `${path}: ${pathMap[path]} –∑–º—ñ–Ω`;
                cell.addEventListener('click', () => {
                    // Filter table to show only this path
                    filterTableByPath(path);
                });
                heatmapContainer.appendChild(cell);
            });

            container.appendChild(heatmapContainer);
            return container;
        }

        function filterTableByPath(path) {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = path;
                searchInput.dispatchEvent(new Event('input'));
                showToast(`–§—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —à–ª—è—Ö—É: ${path}`, 'info');
            }
        }

        // Export analytics functions
        function exportAnalytics(format) {
            const analytics = generateAnalyticsData();
            
            if (format === 'excel') {
                exportToExcel(analytics);
            } else if (format === 'detailed-csv') {
                exportDetailedCSV(analytics);
            }
        }

        function generateAnalyticsData() {
            return {
                summary: {
                    totalChanges: globalDifferences.length,
                    changeTypes: getChangeTypeCounts(),
                    complexity: calculateComplexityScore(),
                    timestamp: new Date().toISOString()
                },
                details: globalDifferences.map(diff => ({
                    ...diff,
                    importance: getImportanceLevel(diff),
                    pathDepth: diff.path.split('.').length
                }))
            };
        }

        function getChangeTypeCounts() {
            const counts = {};
            globalDifferences.forEach(diff => {
                counts[diff.type] = (counts[diff.type] || 0) + 1;
            });
            return counts;
        }

        function calculateComplexityScore() {
            // Simple complexity score based on number of changes and path depths
            const avgDepth = globalDifferences.reduce((sum, diff) => 
                sum + diff.path.split('.').length, 0) / globalDifferences.length;
            return Math.round(globalDifferences.length * avgDepth / 10);
        }

        function exportToExcel(analytics) {
            // Create CSV that Excel can open with analytics data
            const csvContent = [
                'JSON Comparator - –î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –∑–≤—ñ—Ç',
                `–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è: ${new Date().toLocaleDateString('uk-UA')}`,
                `–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–º—ñ–Ω: ${analytics.summary.totalChanges}`,
                `–û—Ü—ñ–Ω–∫–∞ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ: ${analytics.summary.complexity}`,
                '',
                '–†–æ–∑–ø–æ–¥—ñ–ª –ø–æ —Ç–∏–ø–∞—Ö –∑–º—ñ–Ω:',
                ...Object.entries(analytics.summary.changeTypes).map(([type, count]) => `${type}: ${count}`),
                '',
                '–î–µ—Ç–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ:',
                '–¢–∏–ø,–®–ª—è—Ö,–ü—Ä–∏—á–∏–Ω–∞,–°—Ç–∞—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è,–ù–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è,–í–∞–∂–ª–∏–≤—ñ—Å—Ç—å,–ì–ª–∏–±–∏–Ω–∞ —à–ª—è—Ö—É',
                ...analytics.details.map(diff => [
                    diff.type,
                    diff.path,
                    diff.reason,
                    diff.oldValue || '',
                    diff.newValue || '',
                    diff.importance,
                    diff.pathDepth
                ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            downloadFile(csvContent, 'json-comparator-analytics.csv', 'text/csv;charset=utf-8;');
            showToast('Excel –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –∑–≤—ñ—Ç –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!', 'success');
        }

        function exportDetailedCSV(analytics) {
            const csvContent = [
                '–¢–∏–ø,–®–ª—è—Ö,–ü—Ä–∏—á–∏–Ω–∞,–°—Ç–∞—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è,–ù–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è,–í–∞–∂–ª–∏–≤—ñ—Å—Ç—å,–ì–ª–∏–±–∏–Ω–∞ —à–ª—è—Ö—É,–ß–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è',
                ...analytics.details.map(diff => [
                    diff.type,
                    diff.path, 
                    diff.reason,
                    diff.oldValue || '',
                    diff.newValue || '',
                    diff.importance,
                    diff.pathDepth,
                    analytics.summary.timestamp
                ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            downloadFile(csvContent, 'json-comparator-detailed.csv', 'text/csv;charset=utf-8;');
            showToast('–î–µ—Ç–∞–ª—å–Ω–∏–π CSV –∑–≤—ñ—Ç –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!', 'success');
        }

        function generateInsights() {
            const insights = [];
            const analytics = generateAnalyticsData();
            
            // Generate automated insights
            if (analytics.summary.totalChanges > 50) {
                insights.push('üîç –í–µ–ª–∏–∫–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–º—ñ–Ω –≤–∏—è–≤–ª–µ–Ω–∞ - —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –¥–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑');
            }
            
            if (analytics.summary.complexity > 20) {
                insights.push('‚ö†Ô∏è –í–∏—Å–æ–∫–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –∑–º—ñ–Ω - –º–æ–∂–µ –ø–æ—Ç—Ä–µ–±—É–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è');
            }

            const changeTypes = Object.keys(analytics.summary.changeTypes);
            if (changeTypes.includes('TypeChanged')) {
                insights.push('üîÑ –í–∏—è–≤–ª–µ–Ω–æ –∑–º—ñ–Ω–∏ —Ç–∏–ø—ñ–≤ –¥–∞–Ω–∏—Ö - –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å');
            }

            if (changeTypes.includes('SchemaError')) {
                insights.push('‚ùå –í–∏—è–≤–ª–µ–Ω–æ –ø–æ–º–∏–ª–∫–∏ —Å—Ö–µ–º–∏ - –Ω–µ–æ–±—Ö—ñ–¥–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è');
            }

            const pathDepths = analytics.details.map(d => d.pathDepth);
            const maxDepth = Math.max(...pathDepths);
            if (maxDepth > 6) {
                insights.push('üìä –ì–ª–∏–±–æ–∫–∞ –≤–∫–ª–∞–¥–µ–Ω—ñ—Å—Ç—å –∑–º—ñ–Ω - —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏');
            }

            showInsightsModal(insights);
        }

        function showInsightsModal(insights) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üí° –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —ñ–Ω—Å–∞–π—Ç–∏</h2>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${insights.length > 0 ? 
                            insights.map(insight => `<p>‚Ä¢ ${insight}</p>`).join('') :
                            '<p>üòä –ù–µ –≤–∏—è–≤–ª–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º. –ó–º—ñ–Ω–∏ –≤–∏–≥–ª—è–¥–∞—é—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–º–∏.</p>'
                        }
                    </div>
                </div>
            `;

            modal.querySelector('.modal-close').addEventListener('click', () => {
                modal.remove();
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            document.body.appendChild(modal);
            showToast('–Ü–Ω—Å–∞–π—Ç–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ!', 'info');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Setup view mode controls (table/grouped/tree views)
        function setupViewModeControls(differences) {
            const viewButtons = document.querySelectorAll('.view-toggle button');
            const tableContainer = document.getElementById('table-container');
            
            viewButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons
                    viewButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    button.classList.add('active');
                    
                    const viewMode = button.dataset.view;
                    currentViewMode = viewMode;
                    
                    // Clear current content
                    tableContainer.innerHTML = '';
                    
                    switch (viewMode) {
                        case 'table':
                            // Re-render normal table (this is already handled by renderInteractiveTable)
                            setTimeout(() => {
                                const applyFiltersFunc = window.currentApplyFiltersAndSort;
                                if (applyFiltersFunc) applyFiltersFunc();
                            }, 10);
                            break;
                            
                        case 'grouped':
                            const groupedView = createGroupedDiffView(differences);
                            tableContainer.appendChild(groupedView);
                            showToast('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ –≥—Ä—É–ø–æ–≤–∞–Ω–∏–π –≤–∏–≥–ª—è–¥', 'info');
                            break;
                            
                        case 'tree':
                            const treeView = createJsonTreeView(differences);
                            tableContainer.appendChild(treeView);
                            showToast('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ –¥–µ—Ä–µ–≤–æ–≤–∏–¥–Ω–∏–π –≤–∏–≥–ª—è–¥', 'info');
                            break;
                    }
                });
            });
        }

        // Create JSON tree view for differences
        function createJsonTreeView(differences) {
            const container = document.createElement('div');
            container.className = 'json-tree-view';
            container.innerHTML = '<div class="card-title">üå≥ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è–º –∑–º—ñ–Ω</div>';
            
            // Build tree structure from differences
            const pathTree = {};
            differences.forEach(diff => {
                const pathParts = diff.path.split('.');
                let current = pathTree;
                
                pathParts.forEach((part, index) => {
                    if (!current[part]) {
                        current[part] = {
                            children: {},
                            differences: [],
                            isLeaf: index === pathParts.length - 1
                        };
                    }
                    
                    if (index === pathParts.length - 1) {
                        current[part].differences.push(diff);
                    }
                    
                    current = current[part].children;
                });
            });

            function renderTreeNode(node, nodeKey, level = 0) {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';
                nodeDiv.style.marginLeft = `${level * 20}px`;
                
                const hasChildren = Object.keys(node.children).length > 0;
                const hasDifferences = node.differences.length > 0;
                
                let nodeClass = 'tree-node-normal';
                if (hasDifferences) {
                    const firstDiff = node.differences[0];
                    nodeClass = `tree-node-${getMinimapClass(firstDiff.type)}`;
                }
                
                nodeDiv.innerHTML = `
                    <div class="tree-node-header ${nodeClass}">
                        ${hasChildren ? '<span class="tree-toggle">‚ñº</span>' : '<span class="tree-spacer">‚Ä¢</span>'}
                        <span class="tree-key">${nodeKey}</span>
                        ${hasDifferences ? `<span class="tree-diff-count">(${node.differences.length})</span>` : ''}
                    </div>
                `;

                const nodeContent = document.createElement('div');
                nodeContent.className = 'tree-node-content';
                
                // Add differences for this node
                if (hasDifferences) {
                    node.differences.forEach(diff => {
                        const diffDiv = document.createElement('div');
                        diffDiv.className = `tree-diff-item importance-${getImportanceLevel(diff)}`;
                        diffDiv.innerHTML = `
                            <span class="diff-type">${diff.type}</span>
                            <span class="diff-reason">${escapeHtml(diff.reason)}</span>
                        `;
                        nodeContent.appendChild(diffDiv);
                    });
                }
                
                // Add child nodes
                Object.keys(node.children).forEach(childKey => {
                    const childNode = renderTreeNode(node.children[childKey], childKey, level + 1);
                    nodeContent.appendChild(childNode);
                });
                
                if (hasChildren) {
                    const toggle = nodeDiv.querySelector('.tree-toggle');
                    toggle.addEventListener('click', () => {
                        nodeContent.classList.toggle('collapsed');
                        toggle.textContent = nodeContent.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
                    });
                }
                
                nodeDiv.appendChild(nodeContent);
                return nodeDiv;
            }

            // Render root nodes
            Object.keys(pathTree).forEach(rootKey => {
                const rootNode = renderTreeNode(pathTree[rootKey], rootKey);
                container.appendChild(rootNode);
            });

            return container;
        }

        // Function to parse JSON content from textarea with enhanced error handling
        function parseJson(text, dropZone, errorEl) {
                try {
                    if (!text || text.trim() === '') {
                        errorEl.style.display = 'none';
                        dropZone.classList.remove('invalid');
                        return null;
                    }

                    // Check size limits (10MB as string length)
                    const MAX_JSON_SIZE = 10 * 1024 * 1024; // 10MB
                    if (text.length > MAX_JSON_SIZE) {
                        throw new Error(`JSON –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π (${(text.length / 1024 / 1024).toFixed(1)}MB). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä: ${MAX_JSON_SIZE / 1024 / 1024}MB`);
                    }

                    // Try to parse with timeout simulation for large objects
                    let parsed;
                    const startTime = Date.now();
                    
                    try {
                        parsed = JSON.parse(text);
                    } catch (parseError) {
                        if (parseError.message.includes('Unexpected token')) {
                            throw new Error(`–°–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ JSON –Ω–∞ –ø–æ–∑–∏—Ü—ñ—ó ${getJsonErrorPosition(text, parseError)}: ${parseError.message}`);
                        }
                        throw parseError;
                    }

                    const parseTime = Date.now() - startTime;
                    if (parseTime > 5000) { // 5 seconds warning
                        console.warn(`JSON parsing took ${parseTime}ms, consider optimizing`);
                    }

                    // Validate structure for non-schema modes
                    if (currentMode !== 'schema' && (typeof parsed !== 'object' || parsed === null)) {
                        throw new Error("–í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ JSON-–æ–±'—î–∫—Ç–æ–º –∞–±–æ –º–∞—Å–∏–≤–æ–º.");
                    }

                    // Additional validation for very deep nesting
                    const maxDepth = 50;
                    if (getObjectDepth(parsed) > maxDepth) {
                        console.warn(`JSON –º–∞—î –≥–ª–∏–±–æ–∫—É –≤–∫–ª–∞–¥–µ–Ω—ñ—Å—Ç—å (>${maxDepth} —Ä—ñ–≤–Ω—ñ–≤), —Ü–µ –º–æ–∂–µ –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å`);
                    }

                    errorEl.style.display = 'none';
                    dropZone.classList.remove('invalid');
                    updateAriaInvalid(dropZone.querySelector('textarea'), false);
                    return parsed;
                } catch (jsonError) {
                    const errorMessage = jsonError.message || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥—É JSON';
                    errorEl.textContent = `–ü–æ–º–∏–ª–∫–∞: ${errorMessage}`;
                    errorEl.style.display = 'block';
                    dropZone.classList.add('invalid');
                    updateAriaInvalid(dropZone.querySelector('textarea'), true);
                    announceToScreenReader(`–ü–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó JSON: ${errorMessage}`, 'assertive');
                    return null;
                }
            }

            // Helper function to get approximate error position in JSON
            function getJsonErrorPosition(text, error) {
                const match = error.message.match(/position (\d+)/);
                if (match) {
                    const pos = parseInt(match[1]);
                    const lines = text.substring(0, pos).split('\n');
                    return `—Ä—è–¥–æ–∫ ${lines.length}, —Å–∏–º–≤–æ–ª ${lines[lines.length - 1].length + 1}`;
                }
                return '–Ω–µ–≤—ñ–¥–æ–º–∞ –ø–æ–∑–∏—Ü—ñ—è';
            }

            // Helper function to calculate object depth
            function getObjectDepth(obj, currentDepth = 0) {
                if (typeof obj !== 'object' || obj === null || currentDepth > 100) {
                    return currentDepth;
                }
                
                let maxDepth = currentDepth;
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        const depth = getObjectDepth(obj[key], currentDepth + 1);
                        maxDepth = Math.max(maxDepth, depth);
                    }
                }
                return maxDepth;
            }

            // Function to setup drag-and-drop functionality for a drop zone
            function setupDropZone(dropZone, textArea, fileNameEl, errorEl, fileContentCallback) {
                textArea.addEventListener('input', () => {
                    try {
                        const rawContent = textArea.value;
                        
                        // Sanitize manual input
                        const content = sanitizeInput(rawContent);
                        
                        // Update textarea if content was sanitized
                        if (content !== rawContent) {
                            textArea.value = content;
                            showToast('–í–≤–µ–¥–µ–Ω–∏–π —Ç–µ–∫—Å—Ç –±—É–ª–æ –æ—á–∏—â–µ–Ω–æ –≤—ñ–¥ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤.', 'info');
                        }
                        
                        fileContentCallback(content);
                        const parsed = parseJson(content, dropZone, errorEl);
                        if (!parsed && content.trim() !== '') {
                            showToast(`–ü–æ–º–∏–ª–∫–∞ —É —Ñ–∞–π–ª—ñ: ${fileNameEl.textContent || dropZone.querySelector('textarea').placeholder.split(' ')[2]}. ${errorEl.textContent}`, 'error');
                        }
                        fileNameEl.textContent = '';
                        checkFilesReady();
                    } catch (error) {
                        console.error('Error processing input:', error);
                        showToast('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –≤–≤–µ–¥–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö.', 'error');
                    }
                });

                dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
                dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('dragover'); });
                dropZone.addEventListener('drop', e => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (!file) return;

                    if (file.size > 5 * 1024 * 1024) {
                        showToast("–§–∞–π–ª –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä - 5MB.", 'error');
                        return;
                    }

                    try {
                        // Enhanced file validation
                        if (!file.type.includes('json') && !file.name.endsWith('.json') && !file.name.endsWith('.txt')) {
                            throw new Error('–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å JSON –∞–±–æ —Ç–µ–∫—Å—Ç–æ–≤–∏–π —Ñ–∞–π–ª.');
                        }

                        fileNameEl.textContent = file.name;
                        const reader = new FileReader();
                        
                        reader.onload = (event) => {
                            try {
                                const rawContent = event.target.result;
                                
                                // Validate and sanitize file content
                                const content = validateFileContent(rawContent, file.name);
                                
                                textArea.value = content;
                                fileContentCallback(content);
                                
                                const parsed = parseJson(content, dropZone, errorEl);
                                if (!parsed && content.trim() !== '') {
                                    showToast(`–ü–æ–º–∏–ª–∫–∞ —É —Ñ–∞–π–ª—ñ '${file.name}'. ${errorEl.textContent}`, 'error');
                                } else {
                                    showToast(`–§–∞–π–ª '${file.name}' –±–µ–∑–ø–µ—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.`, 'success');
                                }
                                checkFilesReady();
                            } catch (validationError) {
                                errorEl.textContent = `–ü–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Ñ–∞–π–ª—É: ${validationError.message}`;
                                errorEl.style.display = 'block';
                                dropZone.classList.add('invalid');
                                showToast(`–§–∞–π–ª '${file.name}' –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ: ${validationError.message}`, 'error');
                                fileNameEl.textContent = '';
                                textArea.value = '';
                                fileContentCallback(null);
                                checkFilesReady();
                            }
                        };
                        
                        reader.onerror = () => {
                            showToast(`–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É '${file.name}'.`, 'error');
                            fileNameEl.textContent = '';
                            textArea.value = '';
                            fileContentCallback(null);
                            checkFilesReady();
                        };
                        
                        reader.readAsText(file);
                    } catch (error) {
                        showToast(error.message, 'error');
                        fileNameEl.textContent = '';
                        textArea.value = '';
                        fileContentCallback(null);
                        checkFilesReady();
                    }
                });
            }

        // Function to check if files are ready for comparison
        function checkFilesReady() {
            let isReady = false;
            const sourceValid = (!document.getElementById('sourceError').style.display || document.getElementById('sourceError').style.display === 'none') && (sourceFileContent !== null && sourceFileContent.trim() !== '');
            const targetValid = (!document.getElementById('targetError').style.display || document.getElementById('targetError').style.display === 'none') && (targetFileContent !== null && targetFileContent.trim() !== '');
            const schemaValid = (!document.getElementById('schemaError').style.display || document.getElementById('schemaError').style.display === 'none') && (schemaFileContent !== null && schemaFileContent.trim() !== '');

            if (currentMode === 'schema') {
                isReady = schemaValid && targetValid && isAjvAvailable();
            } else {
                isReady = sourceValid && targetValid;
            }
            const compareBtn = document.getElementById('compareBtn');
            if (compareBtn) {
                compareBtn.disabled = !isReady;
            }
        }

        // --- DOMContentLoaded initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ AJV –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
            console.log('AJV Library Check on DOMContentLoaded:', {
                'typeof Ajv': typeof Ajv,
                'typeof window.Ajv': typeof window.Ajv,
                'isAjvAvailable()': isAjvAvailable()
            });

            // –Ø–∫—â–æ AJV –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞, —Å–ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ó—ó —â–µ —Ä–∞–∑
            if (!isAjvAvailable()) {
                console.warn('AJV not available, attempting to load via alternative method...');
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://unpkg.com/ajv@8.17.1/dist/ajv.bundle.js';
                                fallbackScript.onload = function() {
                    console.log('AJV fallback loaded successfully');
                    console.log('üéØ JSON Schema validation is now available with enhanced error reporting');
                    showToast('‚úÖ AJV –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ!', 'success');
                    checkFilesReady(); // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                };
                fallbackScript.onerror = function() {
                    console.error('All AJV loading methods failed');
                    window.AjvLoadError = true;
                };
                document.head.appendChild(fallbackScript);
            }
            // --- DOM Elements ---
            const dropZone1 = document.getElementById('dropZone1');
            const dropZone2 = document.getElementById('dropZone2');
            const dropZoneSchema = document.getElementById('dropZoneSchema');
            const compareBtn = document.getElementById('compareBtn');
            const exportBtn = document.getElementById('exportBtn');
            const resultsContainer = document.getElementById('results');
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsModalBtn = document.getElementById('closeSettingsModal');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const copyResultsBtn = document.getElementById('copyResultsBtn');
            const widthToggleBtn = document.getElementById('widthToggleBtn');
            const widthEnterIcon = document.getElementById('width-enter-icon');
            const widthExitIcon = document.getElementById('width-exit-icon');

            // --- Initial setup ---
            loadSettings();
            updateUiForMode();
            initializeTooltips();
            addKeyboardSupport();
            setupScrollToTop();

            // --- Event Listeners ---
            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => { 
                    settingsModal.style.display = 'flex'; 
                    initializeTooltips();
                    loadAiSettings(); // Load AI settings when modal opens
                });
            }
            
            if (closeSettingsModalBtn) {
                closeSettingsModalBtn.addEventListener('click', () => { 
                    settingsModal.style.display = 'none'; 
                });
            }
            
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', saveSettings);
            }
            
            window.addEventListener('click', (event) => {
                if (event.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });
            
            const themeToggle = document.getElementById('checkbox');
            if (themeToggle) {
                themeToggle.addEventListener('change', () => {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                });

                // Re-apply theme on load
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeToggle.checked = true;
                }
            }

            // --- Initial setup for drop zones (needs to be inside DOMContentLoaded as it accesses DOM elements)
            setupDropZone(dropZone1, document.getElementById('sourceText'), document.getElementById('fileName1'), document.getElementById('sourceError'), content => sourceFileContent = content);
            setupDropZone(dropZone2, document.getElementById('targetText'), document.getElementById('fileName2'), document.getElementById('targetError'), content => targetFileContent = content);
            setupDropZone(dropZoneSchema, document.getElementById('schemaText'), document.getElementById('fileNameSchema'), document.getElementById('schemaError'), content => schemaFileContent = content);

            // --- Setup example schema insertion ---
            const insertExampleSchemaBtn = document.getElementById('insertExampleSchema');
            if (insertExampleSchemaBtn) {
                insertExampleSchemaBtn.addEventListener('click', () => {
                    const schemaTextArea = document.getElementById('schemaText');
                    const exampleSchemaText = document.getElementById('exampleSchemaText');
                    
                    if (schemaTextArea && exampleSchemaText) {
                        // Clear any existing error states
                        const schemaError = document.getElementById('schemaError');
                        if (schemaError) {
                            schemaError.style.display = 'none';
                        }
                        const dropZoneSchema = document.getElementById('dropZoneSchema');
                        if (dropZoneSchema) {
                            dropZoneSchema.classList.remove('invalid');
                        }
                        
                        // Insert the example schema
                        schemaTextArea.value = exampleSchemaText.textContent.trim();
                        schemaFileContent = schemaTextArea.value;
                        
                        // Update file name display
                        const fileNameSchema = document.getElementById('fileNameSchema');
                        if (fileNameSchema) {
                            fileNameSchema.textContent = 'üìã –ü—Ä–∏–∫–ª–∞–¥ —Å—Ö–µ–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞';
                        }
                        
                        // Check if files are ready for comparison
                        checkFilesReady();
                        
                        // Show success message
                        showToast('‚úÖ –ü—Ä–∏–∫–ª–∞–¥ —Å—Ö–µ–º–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!', 'success');
                        
                        // Close the details element
                        const detailsElement = insertExampleSchemaBtn.closest('details');
                        if (detailsElement) {
                            detailsElement.open = false;
                        }
                    }
                });
            }

            // Add event listeners for mode changes
            document.querySelectorAll('input[name="compareMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentMode = e.target.value;
                    updateUiForMode();
                    checkFilesReady();
                });
            });

            // Event listener for compare button with enhanced error handling
            compareBtn.addEventListener('click', () => {
                showLoader();
                
                // Use setTimeout to avoid blocking UI and enable timeout handling
                setTimeout(async () => {
                    const COMPARISON_TIMEOUT = 30000; // 30 seconds
                    let timeoutId;
                    
                    try {
                        // Set up timeout for long operations
                        const timeoutPromise = new Promise((_, reject) => {
                            timeoutId = setTimeout(() => {
                                reject(new Error('–ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ—ó –≤–∏—á–µ—Ä–ø–∞–Ω–æ (30 —Å–µ–∫—É–Ω–¥). –°–ø—Ä–æ–±—É–π—Ç–µ –∑ –º–µ–Ω—à–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏.'));
                            }, COMPARISON_TIMEOUT);
                        });

                        const comparisonPromise = new Promise((resolve, reject) => {
                            try {
                                let sourceJson = null;
                                let targetJson = null;
                                let schemaJson = null;

                                if (currentMode === 'schema') {
                                    schemaJson = parseJson(schemaFileContent, dropZoneSchema, document.getElementById('schemaError'));
                                    targetJson = parseJson(targetFileContent, dropZone2, document.getElementById('targetError'));
                                } else {
                                    sourceJson = parseJson(sourceFileContent, dropZone1, document.getElementById('sourceError'));
                                    targetJson = parseJson(targetFileContent, dropZone2, document.getElementById('targetError'));
                                }

                                let canProceed = false;
                                if (currentMode === 'schema') {
                                    canProceed = schemaJson && targetJson;
                                } else {
                                    canProceed = sourceJson && targetJson;
                                }

                                if (!canProceed) {
                                    reject(new Error("–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ. –û–¥–∏–Ω –∞–±–æ –¥–µ–∫—ñ–ª—å–∫–∞ —Ñ–∞–π–ª—ñ–≤ –Ω–µ —î –≤–∞–ª—ñ–¥–Ω–∏–º–∏ JSON."));
                                    return;
                                }

                                // Estimate complexity and warn user
                                const complexity = estimateComplexity(sourceJson, targetJson, schemaJson);
                                if (complexity > 100000) {
                                    console.warn(`High complexity operation detected: ${complexity}. This may take some time.`);
                                }

                                globalDifferences = [];
                                const startTime = Date.now();

                                if (currentMode === 'direct') {
                                    globalDifferences = findDifferences(sourceJson, targetJson, false, '$', settings);
                                    renderReport(globalDifferences, sourceJson, targetJson);
                                } else if (currentMode === 'keys') {
                                    globalDifferences = findDifferences(sourceJson, targetJson, true, '$', settings);
                                    renderReport(globalDifferences, sourceJson, targetJson);
                                } else if (currentMode === 'schema') {
                                    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ AJV –ø–µ—Ä–µ–¥ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é
                                    if (!isAjvAvailable()) {
                                        reject(new Error(getSchemaValidationErrorMessage()));
                                        return;
                                    }
                                    globalDifferences = validateWithSchema(targetJson, schemaJson);
                                    renderReport(globalDifferences, schemaJson, targetJson);
                                }

                                const duration = Date.now() - startTime;
                                console.log(`Comparison completed in ${duration}ms`);
                                
                                resolve();
                            } catch (error) {
                                reject(error);
                            }
                        });

                        // Race between comparison and timeout
                        await Promise.race([comparisonPromise, timeoutPromise]);
                        
                        showToast(`–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ó–Ω–∞–π–¥–µ–Ω–æ ${globalDifferences.length} –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π.`, 'success');
                        
                    } catch (e) {
                        console.error("–ü–æ–º–∏–ª–∫–∞ –∞–Ω–∞–ª—ñ–∑—É/–≤–∞–ª—ñ–¥–∞—Ü—ñ—ó:", e);
                        
                        let errorMessage = e.message;
                        if (e.message.includes('timeout') || e.message.includes('–ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è')) {
                            errorMessage = '–û–ø–µ—Ä–∞—Ü—ñ—è –∑–∞–π–Ω—è–ª–∞ –∑–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ —á–∞—Å—É. –°–ø—Ä–æ–±—É–π—Ç–µ –∑ –º–µ–Ω—à–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏ –∞–±–æ —Å–ø—Ä–æ—Å—Ç—ñ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É JSON.';
                        } else if (e.message.includes('memory') || e.message.includes("–ø–∞–º'—è—Ç—å")) {
                            errorMessage = '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø–∞–º\'—è—Ç—ñ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ —Ç–∞–∫–∏—Ö –≤–µ–ª–∏–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤. –°–ø—Ä–æ–±—É–π—Ç–µ –∑ –º–µ–Ω—à–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏.';
                        }
                        
                        showToast(`–ü–æ–º–∏–ª–∫–∞: ${errorMessage}`, 'error');
                        resultsContainer.innerHTML = `<p style="color: var(--red);">–ü–æ–º–∏–ª–∫–∞: ${errorMessage}</p>`;
                        resultsContainer.style.display = 'block';
                    } finally {
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                        }
                        hideLoader();
                    }
                }, 50);
            });

            // Helper function to estimate operation complexity
            function estimateComplexity(source, target, schema) {
                let complexity = 0;
                
                if (source) complexity += getObjectSize(source);
                if (target) complexity += getObjectSize(target);
                if (schema) complexity += getObjectSize(schema) * 0.5; // Schema validation is generally faster
                
                return complexity;
            }

            // Helper function to estimate object size (recursive count of properties)
            function getObjectSize(obj, depth = 0) {
                if (depth > 20) return 1; // Prevent stack overflow
                if (typeof obj !== 'object' || obj === null) return 1;
                
                let size = 1;
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        size += getObjectSize(obj[key], depth + 1);
                    }
                }
                return size;
            }

            document.getElementById('exportTxt').addEventListener('click', (e) => { e.preventDefault(); exportReport('txt'); });
            document.getElementById('exportJson').addEventListener('click', (e) => { e.preventDefault(); exportReport('json'); });
            document.getElementById('exportCsv').addEventListener('click', (e) => { e.preventDefault(); exportReport('csv'); });

            function exportReport(format) {
                let content = '';
                let fileName = `comparison_report_${new Date().toISOString().slice(0,10)}`;
                let mimeType = 'text/plain;charset=utf-8';

                if (globalDifferences.length === 0) {
                    content = "–í—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.";
                } else if (format === 'txt') {
                    content = globalDifferences.map(d => {
                        let line = `–¢–∏–ø: ${d.type}\n–®–ª—è—Ö: ${d.path}\n–ü—Ä–∏—á–∏–Ω–∞: ${d.reason}\n`;
                        if (d.oldValue !== undefined) line += `–°—Ç–∞—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è: ${d.oldValue}\n`;
                        if (d.newValue !== undefined) line += `–ù–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è: ${d.newValue}\n`;
                        return line + '---';
                    }).join('\n');
                    fileName += '.txt';
                } else if (format === 'json') {
                    content = JSON.stringify(globalDifferences, null, 2);
                    fileName += '.json';
                    mimeType = 'application/json;charset=utf-8';
                } else if (format === 'csv') {
                    const header = "Type,Path,Reason,OldValue,NewValue\n";
                    const rows = globalDifferences.map(d => {
                        const escapeCsv = (val) => {
                            if (val == null) return '';
                            const str = String(val);
                            if (str.includes('"') || str.includes(',') || str.includes('\n')) {
                                return `"${str.replace(/"/g, '""')}"`;
                            }
                            return str;
                        };
                        return [escapeCsv(d.type), escapeCsv(d.path), escapeCsv(d.reason), escapeCsv(d.oldValue), escapeCsv(d.newValue)].join(',');
                    }).join('\n');
                    content = "\uFEFF" + header + rows;
                    fileName += '.csv';
                    mimeType = 'text/csv;charset=utf-8';
                }
                
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast(`–ó–≤—ñ—Ç –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ —É ${format.toUpperCase()} —Ñ–æ—Ä–º–∞—Ç.`, 'success');
            }
            
            function isPathIgnored(path, ignorePatterns) {
                return ignorePatterns.some(pattern => {
                    let regexPattern = '^' + pattern.replace(/\$/g, '\\$').replace(/\./g, '\\.').replace(/\[\*\]/g, '\\[[0-9]+\\]');
                    if (pattern.endsWith('.*')) {
                        regexPattern = regexPattern.slice(0, -2) + '(\\.|$).*';
                    } else if (pattern.endsWith('[*]')) {
                        regexPattern = regexPattern.slice(0, -3) + '\\[[0-9]+\\](\\.|$).*';
                    }
                    const regex = new RegExp(regexPattern);
                    return regex.test(path);
                });
            }

            // --- CORE COMPARISON LOGIC ---
            function findDifferences(elem1, elem2, keysOnly, path = '$', settings) {
                if (isPathIgnored(path, settings.ignorePaths)) return [];
                const differences = [];
                if (typeof elem1 !== typeof elem2 || Array.isArray(elem1) !== Array.isArray(elem2)) {
                    differences.push({ path, type: 'TypeChanged', reason: '–†—ñ–∑–Ω—ñ —Ç–∏–ø–∏', oldValue: typeof elem1, newValue: typeof elem2 });
                    return differences;
                }
                if (Array.isArray(elem1)) {
                    if (settings.arrayCompareMode === 'key' && !tryCompareArraysByKey(elem1, elem2, keysOnly, path, differences, settings)) {
                        compareArraysByIndex(elem1, elem2, keysOnly, path, differences, settings);
                    } else if (settings.arrayCompareMode === 'index') {
                        compareArraysByIndex(elem1, elem2, keysOnly, path, differences, settings);
                    }
                } else if (typeof elem1 === 'object' && elem1 !== null) {
                    compareObjects(elem1, elem2, keysOnly, path, differences, settings);
                } else {
                    let val1 = elem1;
                    let val2 = elem2;
                    if (typeof val1 === 'string' && !settings.caseSensitive) {
                        val1 = val1.toLowerCase();
                        val2 = val2.toLowerCase();
                    }
                    if (!keysOnly && val1 !== val2) {
                        differences.push({ path, type: 'ValueChanged', reason: '–†—ñ–∑–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è', oldValue: JSON.stringify(elem1), newValue: JSON.stringify(elem2) });
                    }
                }
                return differences;
            }

            function compareObjects(obj1, obj2, keysOnly, path, differences, settings) {
                const allKeys = new Set([...Object.keys(obj1), ...Object.keys(obj2)]);
                allKeys.forEach(key => {
                    const currentPath = `${path}.${key}`;
                    if (isPathIgnored(currentPath, settings.ignorePaths)) return;
                    if (key in obj1 && !(key in obj2)) {
                        differences.push({ path: currentPath, type: 'Removed', reason: '–í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å –≤–∏–¥–∞–ª–µ–Ω–∞', oldValue: JSON.stringify(obj1[key], null, 2) });
                    } else if (!(key in obj1) && key in obj2) {
                        differences.push({ path: currentPath, type: 'Added', reason: '–í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å –¥–æ–¥–∞–Ω–∞', newValue: JSON.stringify(obj2[key], null, 2) });
                    } else {
                        differences.push(...findDifferences(obj1[key], obj2[key], keysOnly, currentPath, settings));
                    }
                });
            }
            
            function tryCompareArraysByKey(arr1, arr2, keysOnly, path, differences, settings) {
                const potentialKeys = ['id', 'productId', 'variantId', 'reviewId', 'key', 'name'];
                if (arr1.length === 0 && arr2.length === 0) return true;
                if (arr1.length > 0 && (typeof arr1[0] !== 'object' || arr1[0] === null)) return false;
                if (arr2.length > 0 && (typeof arr2[0] !== 'object' || arr2[0] === null)) return false;

                const bestKey = potentialKeys.find(key => 
                    (arr1.length === 0 || arr1.every(item => item && typeof item === 'object' && key in item)) &&
                    (arr2.length === 0 || arr2.every(item => item && typeof item === 'object' && key in item))
                );
                
                if (!bestKey) return false;

                const dict1 = new Map(arr1.map(item => [item[bestKey], item]));
                const dict2 = new Map(arr2.map(item => [item[bestKey], item]));

                dict1.forEach((value, key) => {
                    const currentPath = `${path}[${bestKey}=${JSON.stringify(key)}]`;
                    if (isPathIgnored(currentPath, settings.ignorePaths)) return;
                    if (!dict2.has(key)) {
                        differences.push({ path: currentPath, type: 'Removed', reason: '–û–±\'—î–∫—Ç –≤–∏–¥–∞–ª–µ–Ω–æ', oldValue: JSON.stringify(value, null, 2) });
                    } else {
                        differences.push(...findDifferences(value, dict2.get(key), keysOnly, currentPath, settings));
                        dict2.delete(key);
                    }
                });

                dict2.forEach((value, key) => {
                    const currentPath = `${path}[${bestKey}=${JSON.stringify(key)}]`;
                    if (isPathIgnored(currentPath, settings.ignorePaths)) return;
                    if (!dict1.has(key)) {
                        differences.push({ path: currentPath, type: 'Added', reason: '–û–±\'—î–∫—Ç –¥–æ–¥–∞–Ω–æ', newValue: JSON.stringify(value, null, 2) });
                    }
                });
                return true;
            }

            function compareArraysByIndex(arr1, arr2, keysOnly, path, differences, settings) {
                if (arr1.length !== arr2.length && !keysOnly) {
                    differences.push({ path, type: 'LengthChanged', reason: '–†—ñ–∑–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –µ–ª–µ–º–µ–Ω—Ç—ñ–≤', oldValue: arr1.length, newValue: arr2.length });
                }
                const len = Math.min(arr1.length, arr2.length);
                for (let i = 0; i < len; i++) {
                    const currentPath = `${path}[${i}]`;
                    if (isPathIgnored(currentPath, settings.ignorePaths)) continue;
                    differences.push(...findDifferences(arr1[i], arr2[i], keysOnly, currentPath, settings));
                }
                for (let i = len; i < arr1.length; i++) {
                    const currentPath = `${path}[${i}]`;
                    if (isPathIgnored(currentPath, settings.ignorePaths)) continue;
                    differences.push({ path: currentPath, type: 'Removed', reason: '–ï–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∞–ª–µ–Ω–æ', oldValue: JSON.stringify(arr1[i], null, 2) });
                }
                for (let i = len; i < arr2.length; i++) {
                    const currentPath = `${path}[${i}]`;
                    if (isPathIgnored(currentPath, settings.ignorePaths)) continue;
                    differences.push({ path: currentPath, type: 'Added', reason: '–ï–ª–µ–º–µ–Ω—Ç –¥–æ–¥–∞–Ω–æ', newValue: JSON.stringify(arr2[i], null, 2) });
                }
            }

            // --- JSON SCHEMA VALIDATION ---
            function validateWithSchema(data, schema) {
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ AJV –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
                if (!isAjvAvailable()) {
                    return [{
                        path: '$',
                        type: 'SchemaLibraryError',
                        reason: getSchemaValidationErrorMessage(),
                        oldValue: 'üîß –†—ñ—à–µ–Ω–Ω—è: F5 –∞–±–æ Ctrl+F5',
                        newValue: 'üì∂ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç'
                    }];
                }

                try {
                    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è AJV –∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–º–∏ –º–æ–∂–ª–∏–≤–æ—Å—Ç—è–º–∏
                    let ajv;
                    let AjvConstructor = null;
                    
                    // –°–ø—Ä–æ–±—É—î–º–æ —Ä—ñ–∑–Ω—ñ —Å–ø–æ—Å–æ–±–∏ –¥–æ—Å—Ç—É–ø—É –¥–æ AJV
                    if (typeof Ajv !== 'undefined') {
                        AjvConstructor = Ajv;
                    } else if (typeof window.Ajv !== 'undefined') {
                        AjvConstructor = window.Ajv;
                    } else if (typeof window.ajv !== 'undefined') {
                        AjvConstructor = window.ajv;
                    } else if (window.Ajv && window.Ajv.default) {
                        AjvConstructor = window.Ajv.default;
                    }
                    
                    if (!AjvConstructor) {
                        throw new Error('AJV –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—ñ—Å–ª—è –≤—Å—ñ—Ö —Å–ø—Ä–æ–±');
                    }
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ AJV instance –∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–º–∏ –æ–ø—Ü—ñ—è–º–∏
                    const ajvOptions = {
                        allErrors: true,           // –ü–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ –ø–æ–º–∏–ª–∫–∏, –Ω–µ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à—É
                        verbose: true,             // –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏
                        strict: false,             // –ú–µ–Ω—à —Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
                        validateFormats: true,     // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ñ–æ—Ä–º–∞—Ç—ñ–≤ (email, date, etc.)
                        addUsedSchema: false,      // –ù–µ –¥–æ–¥–∞–≤–∞—Ç–∏ —Å—Ö–µ–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
                        inlineRefs: true,         // –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –¥–ª—è $ref
                        loadSchema: false,        // –í—ñ–¥–∫–ª—é—á–∞—î–º–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ö–µ–º
                        allowUnionTypes: true     // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ union —Ç–∏–ø—ñ–≤
                    };
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∏–º–æ —á–∏ —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
                    if (typeof AjvConstructor === 'function') {
                        ajv = new AjvConstructor(ajvOptions);
                    } else if (AjvConstructor.default && typeof AjvConstructor.default === 'function') {
                        ajv = new AjvConstructor.default(ajvOptions);
                    } else {
                        throw new Error('AJV –Ω–µ —î –≤–∞–ª—ñ–¥–Ω–∏–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–º');
                    }

                    // –î–æ–¥–∞—î–º–æ —Ñ–æ—Ä–º–∞—Ç–∏ —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω—ñ
                    if (typeof addFormats !== 'undefined') {
                        try {
                            addFormats(ajv);
                            console.log('‚úÖ AJV Formats –¥–æ–¥–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
                        } catch (e) {
                            console.warn('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è AJV Formats:', e.message);
                        }
                    } else if (typeof window.addFormats !== 'undefined') {
                        try {
                            window.addFormats(ajv);
                            console.log('‚úÖ AJV Formats –¥–æ–¥–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ (window)');
                        } catch (e) {
                            console.warn('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è AJV Formats (window):', e.message);
                        }
                    }

                    // –î–æ–¥–∞—î–º–æ keywords —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω—ñ
                    if (typeof addKeywords !== 'undefined') {
                        try {
                            addKeywords(ajv);
                            console.log('‚úÖ AJV Keywords –¥–æ–¥–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
                        } catch (e) {
                            console.warn('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è AJV Keywords:', e.message);
                        }
                    } else if (typeof window.addKeywords !== 'undefined') {
                        try {
                            window.addKeywords(ajv);
                            console.log('‚úÖ AJV Keywords –¥–æ–¥–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ (window)');
                        } catch (e) {
                            console.warn('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è AJV Keywords (window):', e.message);
                        }
                    }

                    // –ö–æ–º–ø—ñ–ª—é—î–º–æ —Å—Ö–µ–º—É –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
                    let validate;
                    try {
                        validate = ajv.compile(schema);
                    } catch (compileError) {
                        return [{
                            path: '$',
                            type: 'SchemaCompileError',
                            reason: `üö´ –ü–æ–º–∏–ª–∫–∞ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó —Å—Ö–µ–º–∏: ${compileError.message}`,
                            oldValue: 'üìã –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Å—Ö–µ–º–∏',
                            newValue: 'üîß –í–∏–ø—Ä–∞–≤—Ç–µ –ø–æ–º–∏–ª–∫–∏ –≤ JSON Schema'
                        }];
                    }

                    // –í–∏–∫–æ–Ω—É—î–º–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é
                    const valid = validate(data);
                    
                    if (valid) {
                        const schemaInfo = getSchemaInfo(schema);
                        return [{
                            path: '$',
                            type: 'SchemaValidationSuccess',
                            reason: `‚úÖ JSON —É—Å–ø—ñ—à–Ω–æ –ø—Ä–æ–π—à–æ–≤ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é –∑–∞ —Å—Ö–µ–º–æ—é ${schemaInfo}`,
                            oldValue: 'üéØ –í—Å—ñ –ø—Ä–∞–≤–∏–ª–∞ —Å—Ö–µ–º–∏ –¥–æ—Ç—Ä–∏–º–∞–Ω–æ',
                            newValue: '‚ú® –î–∞–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –≤—Å—ñ–º –≤–∏–º–æ–≥–∞–º'
                        }];
                    }
                    
                    // –û–±—Ä–æ–±–ª—è—î–º–æ –ø–æ–º–∏–ª–∫–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é
                    return (validate.errors || []).map((err, index) => {
                        const errorPath = err.instancePath || err.dataPath || '$';
                        const errorValue = err.data !== undefined ? err.data : 'undefined';
                        
                        // –§–æ—Ä–º—É—î–º–æ –¥–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –ø–æ–º–∏–ª–∫–∏
                        let detailedReason = formatValidationError(err);
                        
                        // –î–æ–¥–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏
                        let contextInfo = '';
                        if (err.schemaPath) {
                            contextInfo = `Schema path: ${err.schemaPath}`;
                        }
                        
                        return {
                            path: errorPath,
                            type: getErrorType(err.keyword),
                            reason: detailedReason,
                            oldValue: `${contextInfo} | Expected: ${getExpectedValue(err)}`,
                            newValue: `Actual: ${JSON.stringify(errorValue, null, 2)}`
                        };
                    });
                } catch (e) {
                    console.error('Schema validation error:', e);
                    return [{
                        path: '$',
                        type: 'SchemaParseError',
                        reason: `–ü–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Å—Ö–µ–º–∏: ${e.message}`,
                        oldValue: 'Schema compilation failed',
                        newValue: 'Check schema format'
                    }];
                }
            }

            // --- HELPER FUNCTIONS FOR SCHEMA VALIDATION ---
            
            // –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å—Ö–µ–º—É
            function getSchemaInfo(schema) {
                let info = '';
                if (schema.title) info += `"${schema.title}"`;
                if (schema.version) info += ` v${schema.version}`;
                if (schema.$schema) {
                    const schemaVersion = schema.$schema.match(/draft-(\d+)/);
                    if (schemaVersion) info += ` (Draft ${schemaVersion[1]})`;
                }
                return info || 'Custom Schema';
            }

            // –§–æ—Ä–º–∞—Ç—É—î–º–æ –ø–æ–º–∏–ª–∫—É –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –∑ –µ–º–æ–¥–∂—ñ —Ç–∞ –¥–µ—Ç–∞–ª—è–º–∏
            function formatValidationError(err) {
                const keyword = err.keyword || 'unknown';
                const message = err.message || '–ü–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó';
                
                switch (keyword) {
                    case 'required':
                        return `üî¥ –û–±–æ–≤'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ –≤—ñ–¥—Å—É—Ç–Ω—î: ${err.params?.missingProperty || '–Ω–µ–≤—ñ–¥–æ–º–µ'}`;
                    case 'type':
                        return `üî∏ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ç–∏–ø –¥–∞–Ω–∏—Ö: ${message}`;
                    case 'format':
                        return `üìß –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç: ${message} (–æ—á—ñ–∫—É—î—Ç—å—Å—è ${err.params?.format})`;
                    case 'minimum':
                        return `üìè –ó–Ω–∞—á–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –º–∞–ª–µ: ${message} (–º—ñ–Ω—ñ–º—É–º: ${err.params?.limit})`;
                    case 'maximum':
                        return `üìè –ó–Ω–∞—á–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ: ${message} (–º–∞–∫—Å–∏–º—É–º: ${err.params?.limit})`;
                    case 'minLength':
                        return `üìù –†—è–¥–æ–∫ –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π: ${message} (–º—ñ–Ω—ñ–º—É–º: ${err.params?.limit} —Å–∏–º–≤–æ–ª—ñ–≤)`;
                    case 'maxLength':
                        return `üìù –†—è–¥–æ–∫ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∏–π: ${message} (–º–∞–∫—Å–∏–º—É–º: ${err.params?.limit} —Å–∏–º–≤–æ–ª—ñ–≤)`;
                    case 'pattern':
                        return `üîç –ù–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —à–∞–±–ª–æ–Ω—É: ${message}`;
                    case 'enum':
                        return `üéØ –ù–µ–¥–æ–∑–≤–æ–ª–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è: ${message}. –î–æ–∑–≤–æ–ª–µ–Ω—ñ: ${JSON.stringify(err.params?.allowedValues)}`;
                    case 'additionalProperties':
                        return `üö´ –ó–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ: ${err.params?.additionalProperty}`;
                    case 'minItems':
                        return `üìã –ú–∞—Å–∏–≤ –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π: ${message} (–º—ñ–Ω—ñ–º—É–º: ${err.params?.limit} –µ–ª–µ–º–µ–Ω—Ç—ñ–≤)`;
                    case 'maxItems':
                        return `üìã –ú–∞—Å–∏–≤ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∏–π: ${message} (–º–∞–∫—Å–∏–º—É–º: ${err.params?.limit} –µ–ª–µ–º–µ–Ω—Ç—ñ–≤)`;
                    case 'uniqueItems':
                        return `üîÑ –î—É–±–ª—ñ–∫–∞—Ç–∏ –≤ –º–∞—Å–∏–≤—ñ: ${message}`;
                    case 'const':
                        return `üéØ –ó–Ω–∞—á–µ–Ω–Ω—è –º–∞—î –¥–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏: ${JSON.stringify(err.params?.allowedValue)}`;
                    case 'multipleOf':
                        return `üî¢ –ß–∏—Å–ª–æ –º–∞—î –±—É—Ç–∏ –∫—Ä–∞—Ç–Ω–∏–º ${err.params?.multipleOf}`;
                    case 'if':
                        return `üîÄ –£–º–æ–≤–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è: ${message}`;
                    case 'not':
                        return `‚ùå –ó–∞–±–æ—Ä–æ–Ω–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è: ${message}`;
                    case 'oneOf':
                        return `1Ô∏è‚É£ –ú–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ —Ä—ñ–≤–Ω–æ –æ–¥–Ω—ñ–π —Å—Ö–µ–º—ñ: ${message}`;
                    case 'anyOf':
                        return `üîÄ –ú–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–Ω—ñ–π —Å—Ö–µ–º—ñ: ${message}`;
                    case 'allOf':
                        return `‚úÖ –ú–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –≤—Å—ñ–º —Å—Ö–µ–º–∞–º: ${message}`;
                    default:
                        return `‚ö†Ô∏è ${message} (–ø—Ä–∞–≤–∏–ª–æ: ${keyword})`;
                }
            }

            // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –ø–æ–º–∏–ª–∫–∏ –¥–ª—è –∫—Ä–∞—â–æ—ó –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—ó
            function getErrorType(keyword) {
                const typeMap = {
                    'required': 'SchemaRequiredError',
                    'type': 'SchemaTypeError',
                    'format': 'SchemaFormatError',
                    'minimum': 'SchemaRangeError',
                    'maximum': 'SchemaRangeError',
                    'minLength': 'SchemaLengthError',
                    'maxLength': 'SchemaLengthError',
                    'pattern': 'SchemaPatternError',
                    'enum': 'SchemaEnumError',
                    'additionalProperties': 'SchemaPropertiesError',
                    'minItems': 'SchemaArrayError',
                    'maxItems': 'SchemaArrayError',
                    'uniqueItems': 'SchemaArrayError',
                    'const': 'SchemaConstError',
                    'multipleOf': 'SchemaNumericError',
                    'if': 'SchemaConditionalError',
                    'not': 'SchemaNegationError',
                    'oneOf': 'SchemaCompositionError',
                    'anyOf': 'SchemaCompositionError',
                    'allOf': 'SchemaCompositionError'
                };
                return typeMap[keyword] || 'SchemaError';
            }

            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –æ—á—ñ–∫—É–≤–∞–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –ø–æ–º–∏–ª–∫–∏
            function getExpectedValue(err) {
                const keyword = err.keyword;
                const params = err.params || {};
                
                switch (keyword) {
                    case 'type':
                        return params.type || 'correct type';
                    case 'format':
                        return `${params.format} format`;
                    case 'minimum':
                        return `>= ${params.limit}`;
                    case 'maximum':
                        return `<= ${params.limit}`;
                    case 'minLength':
                        return `length >= ${params.limit}`;
                    case 'maxLength':
                        return `length <= ${params.limit}`;
                    case 'pattern':
                        return `pattern: ${params.pattern}`;
                    case 'enum':
                        return `one of: ${JSON.stringify(params.allowedValues)}`;
                    case 'const':
                        return JSON.stringify(params.allowedValue);
                    case 'minItems':
                        return `array length >= ${params.limit}`;
                    case 'maxItems':
                        return `array length <= ${params.limit}`;
                    case 'multipleOf':
                        return `multiple of ${params.multipleOf}`;
                    case 'required':
                        return `property "${params.missingProperty}" present`;
                    default:
                        return 'valid value';
                }
            }

            // --- REPORT GENERATION ---
            function renderReport(differences, sourceJson, targetJson) {
                let reportHtml = ``;
                
                // Check for successful schema validation
                const hasSuccessValidation = differences.some(d => d.type === 'SchemaValidationSuccess');
                const errorDifferences = differences.filter(d => d.type !== 'SchemaValidationSuccess');
                
                if (differences.length === 0 || hasSuccessValidation) {
                    if (currentMode === 'schema' && hasSuccessValidation) {
                        const successMsg = differences.find(d => d.type === 'SchemaValidationSuccess');
                        reportHtml = `<div class="schema-success">
                            <h2>‚úÖ ${successMsg ? successMsg.reason : 'JSON –≤–∞–ª—ñ–¥–Ω–∏–π –∑–∞ —Å—Ö–µ–º–æ—é'}</h2>
                            <p>${successMsg ? successMsg.oldValue : '–í—Å—ñ –ø—Ä–∞–≤–∏–ª–∞ —Å—Ö–µ–º–∏ –¥–æ—Ç—Ä–∏–º–∞–Ω–æ'}</p>
                        </div>`;
                    } else {
                        reportHtml = `<h2>‚úÖ ${currentMode === 'schema' ? 'JSON –≤–∞–ª—ñ–¥–Ω–∏–π –∑–∞ —Å—Ö–µ–º–æ—é' : '–í—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'}.</h2>`;
                    }
                } else {
                    // Add Analytics Dashboard for meaningful data
                    if (errorDifferences.length > 3) {
                        const analytics = createAnalyticsDashboard(errorDifferences, sourceJson, targetJson);
                        resultsContainer.appendChild(analytics);
                    }
                    const stats = errorDifferences.reduce((acc, diff) => {
                        if (diff.type.toLowerCase().includes('add')) acc.added++;
                        else if (diff.type.toLowerCase().includes('remov')) acc.removed++;
                        else acc.changed++;
                        return acc;
                    }, { added: 0, removed: 0, changed: 0 });
                    
                    reportHtml = `
                        <div class="collapsible-section collapsed">
                            <button class="collapsible-header">
                                <h2>–î–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç –ø—Ä–æ –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—ñ</h2>
                                <span class="collapse-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                </span>
                            </button>
                            <div class="collapsible-content">
                                <div>
                                    <div class="stats-bar">
                                        <span class="stat-item stat-item-total">
                                            <span class="icon-circle icon-circle-total">Œ£</span> 
                                            <strong>–í—Å—å–æ–≥–æ ${currentMode === 'schema' ? '–ø–æ–º–∏–ª–æ–∫ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó' : '–≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π'}: ${errorDifferences.length}</strong>
                                        </span>
                                        <div class="stats-divider"></div>
                                        <span class="stat-item"><span class="icon-circle icon-circle-added">+</span> –î–æ–¥–∞–Ω–æ: ${stats.added}</span>
                                        <span class="stat-item"><span class="icon-circle icon-circle-removed">-</span> –í–∏–¥–∞–ª–µ–Ω–æ: ${stats.removed}</span>
                                        <span class="stat-item"><span class="icon-circle icon-circle-changed">‚áÑ</span> –ó–º—ñ–Ω–µ–Ω–æ: ${stats.changed}</span>
                                    </div>
                                    <div class="diff-header">
                                        <div class="diff-title">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</div>
                                        <div class="diff-controls">
                                            <div class="view-toggle">
                                                <button id="tableViewBtn" class="active" data-view="table">üìä –¢–∞–±–ª–∏—Ü—è</button>
                                                <button id="groupedViewBtn" data-view="grouped">üìÅ –ì—Ä—É–ø–∏</button>
                                                <button id="treeViewBtn" data-view="tree">üå≥ –î–µ—Ä–µ–≤–æ</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="results-controls">
                                        <input type="search" id="searchInput" placeholder="üîç –ü–æ—à—É–∫ –∑–∞ —à–ª—è—Ö–æ–º, —Ç–∏–ø–æ–º –∞–±–æ –∑–Ω–∞—á–µ–Ω–Ω—è–º...">
                                        <div class="filter-group">
                                            <label><input type="checkbox" class="filter-cb" value="add" checked> –î–æ–¥–∞–Ω—ñ</label>
                                            <label><input type="checkbox" class="filter-cb" value="remov" checked> –í–∏–¥–∞–ª–µ–Ω—ñ</label>
                                            <label><input type="checkbox" class="filter-cb" value="chang" checked> –ó–º—ñ–Ω–µ–Ω—ñ</label>
                                            ${currentMode === 'schema' ? `<label><input type="checkbox" class="filter-cb" value="schema" checked> –ü–æ–º–∏–ª–∫–∏ —Å—Ö–µ–º–∏</label>` : ''}
                                        </div>
                                                                <select id="importanceFilter" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color);" title="–ö—Ä–∏—Ç–µ—Ä—ñ—ó –≤–∞–∂–ª–∏–≤–æ—Å—Ç—ñ:&#10;üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∞ - —Å—Ö–µ–º–∏, ID, –∫–ª—é—á—ñ&#10;üü° –í–∏—Å–æ–∫–∞ - —Ç–∏–ø–∏, —Å—Ç–∞—Ç—É—Å–∏, —Å—Ç–∞–Ω–∏&#10;üü¢ –°–µ—Ä–µ–¥–Ω—è - –∑–Ω–∞—á–µ–Ω–Ω—è, —ñ–º–µ–Ω–∞, –∑–∞–≥–æ–ª–æ–≤–∫–∏&#10;‚ö™ –ù–∏–∑—å–∫–∞ - –≤—Å–µ —ñ–Ω—à–µ">
                            <option value="">–í—Å—è –≤–∞–∂–ª–∏–≤—ñ—Å—Ç—å</option>
                            <option value="critical">üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∞</option>
                            <option value="high">üü° –í–∏—Å–æ–∫–∞</option>
                            <option value="medium">üü¢ –°–µ—Ä–µ–¥–Ω—è</option>
                            <option value="low">‚ö™ –ù–∏–∑—å–∫–∞</option>
                        </select>
                                    </div>
                                    <div class="results-layout">
                                        <div class="results-main">
                                            <div id="table-container"></div>
                                        </div>
                                        <div class="results-sidebar" id="minimap-sidebar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
                
                const sourceTitle = currentMode === 'schema' ? 'JSON Schema' : 'Source';
                const targetTitle = currentMode === 'schema' ? 'JSON –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó' : 'Target';

                // Use the new rendering function that handles syntax and diff highlighting
                const sourceHtmlContent = sourceJson ? jsonTraverseAndRender(sourceJson, differences, 'source') : '';
                const targetHtmlContent = targetJson ? jsonTraverseAndRender(targetJson, differences, 'target') : '';

                reportHtml += `
                    <div class="collapsible-section collapsed">
                        <button class="collapsible-header">
                            <h2>JSON —Ñ–∞–π–ª–∏</h2>
                            <span class="collapse-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </span>
                        </button>
                        <div class="collapsible-content">
                            <div class="json-view-controls" style="text-align: right; margin-bottom: 10px;">
                                <label><input type="radio" name="jsonViewMode" value="code" checked> –ö–æ–¥</label>
                                <label><input type="radio" name="jsonViewMode" value="tree"> –î–µ—Ä–µ–≤–æ</label>
                            </div>
                            <div class="json-view">
                                <div id="sourceJsonWrapper" style="${sourceJson ? '' : 'display: none;'}">
                                    <h3>${sourceTitle}</h3>
                                    <pre id="sourceJsonViewCode">${sourceHtmlContent}</pre>
                                    <div id="sourceJsonViewTree" class="json-tree-view" style="display: none;"></div>
                                </div>
                                <div id="targetJsonWrapper" style="grid-column: ${sourceJson ? 'auto' : 'span 2'};">
                                    <h3>${targetTitle}</h3>
                                    <pre id="targetJsonViewCode">${targetHtmlContent}</pre>
                                    <div id="targetJsonViewTree" class="json-tree-view" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                resultsContainer.innerHTML = reportHtml;
                resultsContainer.style.display = 'block';
                exportBtn.style.display = 'inline-block';
                copyResultsBtn.style.display = 'inline-block';
                
                // Add side-by-side view toggle if we have differences
                if (errorDifferences.length > 0) {
                    addSideBySideViewToggle(sourceJson, targetJson, errorDifferences);
                }
                
                // Store differences for AI analysis and show AI button
                window.lastDifferences = errorDifferences.length > 0 ? errorDifferences : differences;
                const aiAnalyzeBtn = document.getElementById('aiAnalyzeBtn');
                if (aiAnalyzeBtn) {
                    aiAnalyzeBtn.style.display = 'inline-block';
                }
                
                // Save to history
                saveCurrentComparisonToHistory();
                
                // Auto AI analysis if enabled
                if (aiSettings.autoAnalyze && aiSettings.apiKey && window.lastDifferences.length > 0) {
                    setTimeout(() => {
                        performAiAnalysis(window.lastDifferences);
                    }, 1000); // Small delay to let UI settle
                }

                renderInteractiveTable(errorDifferences.length > 0 ? errorDifferences : differences);
                synchronizeJsonViewHeights();
                setupCollapsibleSections();
                setupJsonViewToggle(sourceJson, targetJson, differences); // Setup tree view
                resultsContainer.scrollIntoView({ behavior: 'smooth' });
                initializeTooltips(); // Re-initialize tooltips for new dynamic content
            }

            function renderInteractiveTable(allDifferences) {
                const tableContainer = document.getElementById('table-container');
                const minimapSidebar = document.getElementById('minimap-sidebar');
                let searchTerm = '';
                let activeFilters = ['add', 'remov', 'chang'];
                if (currentMode === 'schema') {
                    activeFilters.push('schema');
                }
                let sortState = { column: null, direction: 'asc' };
                let importanceFilter = '';

                // Create and populate minimap for navigation
                if (minimapSidebar && allDifferences.length > 5) {
                    const minimap = createMinimap(allDifferences);
                    minimapSidebar.appendChild(minimap);
                }

                // Setup view mode switching
                setupViewModeControls(allDifferences);

                function applyFiltersAndSort() {
                    let filtered = allDifferences.filter(d => {
                        const typeMatch = activeFilters.some(f => d.type.toLowerCase().includes(f));
                        if (!typeMatch) return false;

                        const searchMatch = !searchTerm || Object.values(d).some(val => 
                            String(val).toLowerCase().includes(searchTerm)
                        );
                        if (!searchMatch) return false;

                        // Apply importance filter
                        if (importanceFilter) {
                            const diffImportance = getImportanceLevel(d);
                            if (diffImportance !== importanceFilter) return false;
                        }

                        return true;
                    });

                    if (sortState.column !== null) {
                        filtered.sort((a, b) => {
                            const valA = a[sortState.column];
                            const valB = b[sortState.column];
                            if (valA === undefined || valB === undefined || valA === null || valB === null) {
                                if (valA === undefined || valA === null) return sortState.direction === 'asc' ? 1 : -1;
                                if (valB === undefined || valB === null) return sortState.direction === 'asc' ? -1 : 1;
                            }
                            if (typeof valA === 'string' && typeof valB === 'string') {
                                return (sortState.direction === 'asc' ? 1 : -1) * valA.localeCompare(valB, 'uk', { numeric: true });
                            }
                            if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                            if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                            return 0;
                        });
                    }
                    
                    updateTableDOM(filtered);
                }

                async function updateTableDOM(differences) {
                    const LARGE_TABLE_THRESHOLD = 1000;
                    
                    // Show loading indicator for large tables
                    if (differences.length > LARGE_TABLE_THRESHOLD) {
                        tableContainer.innerHTML = '<div style="text-align: center; padding: 20px;">–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–µ–ª–∏–∫–æ—ó —Ç–∞–±–ª–∏—Ü—ñ...</div>';
                    }

                    const headers = [
                        { key: '', label: '', sortable: false },
                        { key: 'type', label: '–¢–∏–ø', sortable: true },
                        { key: 'path', label: '–®–ª—è—Ö', sortable: true },
                        { key: 'reason', label: '–ü—Ä–∏—á–∏–Ω–∞', sortable: true },
                        { key: 'oldValue', label: currentMode === 'schema' ? '–ü—Ä–∞–≤–∏–ª–æ —Å—Ö–µ–º–∏ / –°—Ç–∞—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è' : '–°—Ç–∞—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è', sortable: true },
                        { key: 'newValue', label: currentMode === 'schema' ? '–ó–Ω–∞—á–µ–Ω–Ω—è / –ù–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è' : '–ù–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è', sortable: true },
                    ];

                    const headerHtml = headers.map((h) => {
                        let classes = h.sortable ? 'sortable' : '';
                        if (h.key === sortState.column) {
                            classes += sortState.direction === 'asc' ? ' sort-asc' : ' sort-desc';
                        }
                        return `<th class="${classes}" data-key="${h.key}">${h.label}</th>`;
                    }).join('');

                    if (differences.length > LARGE_TABLE_THRESHOLD) {
                        // For large tables, use virtual scrolling or pagination
                        const MAX_VISIBLE_ROWS = 500;
                        const visibleDifferences = differences.slice(0, MAX_VISIBLE_ROWS);
                        
                        const rows = await processInChunks(visibleDifferences, (d) => {
                            const iconSymbol = { 
                                Added: '+', Removed: '-', 
                                ValueChanged: '‚áÑ', TypeChanged: 'T', 
                                LengthChanged: 'L', SchemaError: '!',
                                SchemaParseError: 'X'
                            }[d.type] || '?';
                            
                            let iconClass = 'icon-circle';
                            if (d.type.toLowerCase().includes('add')) iconClass += ' icon-circle-added';
                            else if (d.type.toLowerCase().includes('remov')) iconClass += ' icon-circle-removed';
                            else iconClass += ' icon-circle-changed';
                            
                            return `
                                <tr>
                                    <td><span class="${iconClass}">${iconSymbol}</span></td>
                                    <td data-sort-value="${d.type}">${d.type}</td>
                                    <td data-sort-value="${d.path}"><pre>${escapeHtml(d.path)}</pre></td>
                                    <td data-sort-value="${d.reason}">${escapeHtml(d.reason)}</td>
                                    <td><pre>${escapeHtml(d.oldValue || '')}</pre></td>
                                    <td><pre>${escapeHtml(d.newValue || '')}</pre></td>
                                </tr>`;
                        }, 50, 5);

                        const paginationInfo = differences.length > MAX_VISIBLE_ROWS 
                            ? `<p style="text-align: center; margin: 10px 0; color: var(--text-color);">–ü–æ–∫–∞–∑–∞–Ω–æ ${MAX_VISIBLE_ROWS} –∑ ${differences.length} –∑–∞–ø–∏—Å—ñ–≤. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ñ—ñ–ª—å—Ç—Ä–∏ –¥–ª—è –∑–≤—É–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤.</p>`
                            : '';

                        tableContainer.innerHTML = `
                            ${paginationInfo}
                            <table>
                                <thead><tr>${headerHtml}</tr></thead>
                                <tbody>${rows.join('')}</tbody>
                            </table>`;
                    } else {
                        // For smaller tables, render normally
                        const rows = differences.map(d => {
                            const iconSymbol = { 
                                Added: '+', Removed: '-', 
                                ValueChanged: '‚áÑ', TypeChanged: 'T', 
                                LengthChanged: 'L', SchemaError: '!',
                                SchemaParseError: 'X'
                            }[d.type] || '?';
                            
                            let iconClass = 'icon-circle';
                            if (d.type.toLowerCase().includes('add')) iconClass += ' icon-circle-added';
                            else if (d.type.toLowerCase().includes('remov')) iconClass += ' icon-circle-removed';
                            else iconClass += ' icon-circle-changed';
                            
                            const importance = getImportanceLevel(d);
                            const inlineDiff = d.oldValue && d.newValue && typeof d.oldValue === 'string' && typeof d.newValue === 'string' 
                                ? createInlineDiff(d.oldValue, d.newValue) 
                                : null;
                            
                            return `
                                <tr class="importance-${importance}">
                                    <td><span class="${iconClass}">${iconSymbol}</span></td>
                                    <td data-sort-value="${d.type}">${d.type}</td>
                                    <td data-sort-value="${d.path}"><pre>${escapeHtml(d.path)}</pre></td>
                                    <td data-sort-value="${d.reason}">${escapeHtml(d.reason)}</td>
                                    <td><pre>${inlineDiff && d.oldValue ? inlineDiff.split('</span><span class="char-added">')[0] + '</span>' : escapeHtml(d.oldValue || '')}</pre></td>
                                    <td><pre>${inlineDiff && d.newValue ? '<span class="char-added">' + inlineDiff.split('<span class="char-added">')[1] : escapeHtml(d.newValue || '')}</pre></td>
                                </tr>`;
                        }).join('');

                        tableContainer.innerHTML = `
                            <table>
                                <thead><tr>${headerHtml}</tr></thead>
                                <tbody>${rows}</tbody>
                            </table>`;
                    }
                }

                // Use debounced search for better performance
                const debouncedSearch = debounce((searchValue) => {
                    searchTerm = searchValue.toLowerCase();
                    applyFiltersAndSort();
                }, 300);

                document.getElementById('searchInput').addEventListener('input', (e) => {
                    debouncedSearch(e.target.value);
                });

                document.querySelectorAll('.filter-cb').forEach(cb => {
                    cb.addEventListener('change', () => {
                        activeFilters = Array.from(document.querySelectorAll('.filter-cb:checked')).map(c => c.value);
                        applyFiltersAndSort();
                    });
                });

                // Importance filter
                const importanceFilterEl = document.getElementById('importanceFilter');
                if (importanceFilterEl) {
                    importanceFilterEl.addEventListener('change', (e) => {
                        importanceFilter = e.target.value;
                        applyFiltersAndSort();
                    });
                }

                document.getElementById('table-container').addEventListener('click', (e) => { // Use table-container for event delegation
                    const header = e.target.closest('th.sortable');
                    if (header) {
                        const key = header.dataset.key;
                        if (sortState.column === key) {
                            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortState.column = key;
                            sortState.direction = 'asc';
                        }
                        applyFiltersAndSort();
                    }
                });

                // Store applyFiltersAndSort globally for view switching
                window.currentApplyFiltersAndSort = applyFiltersAndSort;
                
                applyFiltersAndSort();
            }
            
            // --- These functions are now defined globally to avoid duplication ---

            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', () => {
                    const sourceText = document.getElementById('sourceText');
                    const targetText = document.getElementById('targetText');
                    const schemaText = document.getElementById('schemaText');
                    const fileName1 = document.getElementById('fileName1');
                    const fileName2 = document.getElementById('fileName2');
                    const fileNameSchema = document.getElementById('fileNameSchema');
                    const sourceError = document.getElementById('sourceError');
                    const targetError = document.getElementById('targetError');
                    const schemaError = document.getElementById('schemaError');

                    if (sourceText) sourceText.value = '';
                    if (targetText) targetText.value = '';
                    if (schemaText) schemaText.value = '';
                    if (fileName1) fileName1.textContent = '';
                    if (fileName2) fileName2.textContent = '';
                    if (fileNameSchema) fileNameSchema.textContent = '';
                    if (sourceError) sourceError.style.display = 'none';
                    if (targetError) targetError.style.display = 'none';
                    if (schemaError) schemaError.style.display = 'none';
                    
                    if (dropZone1) dropZone1.classList.remove('invalid');
                    if (dropZone2) dropZone2.classList.remove('invalid');
                    if (dropZoneSchema) dropZoneSchema.classList.remove('invalid');
                    
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '';
                        resultsContainer.style.display = 'none';
                    }
                    if (exportBtn) exportBtn.style.display = 'none';
                    if (copyResultsBtn) copyResultsBtn.style.display = 'none';
                    
                    // Hide AI analysis section and button
                    const aiAnalyzeBtn = document.getElementById('aiAnalyzeBtn');
                    const aiAnalysisSection = document.getElementById('aiAnalysisSection');
                    if (aiAnalyzeBtn) aiAnalyzeBtn.style.display = 'none';
                    if (aiAnalysisSection) aiAnalysisSection.style.display = 'none';
                    window.lastDifferences = [];
                    
                    sourceFileContent = null;
                    targetFileContent = null;
                    schemaFileContent = null;
                    globalDifferences = [];
                    
                    // Clean up analytics charts
                    cleanupAnalyticsCharts();
                    
                    checkFilesReady();
                    showToast('–í—Å—ñ –ø–æ–ª—è –æ—á–∏—â–µ–Ω–æ!', 'info');
                });
            }

            if (copyResultsBtn) {
                copyResultsBtn.addEventListener('click', () => {
                    const table = resultsContainer?.querySelector('table');
                    if (!table) {
                        showToast('–ù–µ–º–∞—î –∑–≤—ñ—Ç—É –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è!', 'info');
                        return;
                    }

                    const headerCells = Array.from(table.querySelectorAll('thead th'));
                    const header = headerCells.map(th => {
                        let text = th.innerText.trim();
                        text = text.replace(/[\u2195\u25B2\u25BC]/g, '').trim(); 
                        return `"${text.replace(/"/g, '""')}"`;
                    }).join(',');

                    const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => 
                        Array.from(tr.querySelectorAll('td')).map(td => {
                            let cellText = td.querySelector('pre') ? td.querySelector('pre').innerText : td.innerText;
                            return `"${cellText.replace(/"/g, '""')}"`;
                        }).join(',')
                    );
                    
                    const csvContent = [header, ...rows].join('\n');
                    
                    navigator.clipboard.writeText(csvContent).then(() => {
                        showToast('–ó–≤—ñ—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –¥–æ –±—É—Ñ–µ—Ä–∞ –æ–±–º—ñ–Ω—É!', 'success');
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        showToast('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∑–≤–æ–ª–∏ —É –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.', 'error');
                    });
                });
            }

            // --- Width Toggle Logic ---
            if (widthToggleBtn) {
                widthToggleBtn.addEventListener('click', () => {
                    const mainContainer = document.querySelector('.container');
                    if (mainContainer) {
                        mainContainer.classList.toggle('full-width');
                        const isFullWidth = mainContainer.classList.contains('full-width');
                        if (widthEnterIcon) widthEnterIcon.style.display = isFullWidth ? 'none' : 'block';
                        if (widthExitIcon) widthExitIcon.style.display = isFullWidth ? 'block' : 'none';
                        synchronizeJsonViewHeights();
                    }
                });
            }

            // --- Export Logic ---
            if (document.getElementById('exportTxt')) {
                document.getElementById('exportTxt').addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    exportReport('txt'); 
                });
            }
            if (document.getElementById('exportJson')) {
                document.getElementById('exportJson').addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    exportReport('json'); 
                });
            }
            if (document.getElementById('exportCsv')) {
                document.getElementById('exportCsv').addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    exportReport('csv'); 
                });
            }
        });

        // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ AJV –ø—ñ—Å–ª—è –ø–æ–≤–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤
        window.addEventListener('load', function() {
            setTimeout(() => {
                console.log('Final AJV availability check after window load:', isAjvAvailable());
                if (!isAjvAvailable() && currentMode === 'schema') {
                    showToast(getSchemaValidationErrorMessage(), window.AjvEmergencyMode ? 'warning' : 'error', 7000);
                }
            }, 1000); // –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤—Å—ñ—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
        });

        // --- Gemini AI Integration ---
        
        // AI Settings storage
        let aiSettings = {
            apiKey: localStorage.getItem('gemini_api_key') || '',
            model: localStorage.getItem('gemini_model') || 'gemini-1.5-pro',
            autoAnalyze: localStorage.getItem('ai_auto_analyze') === 'true',
            analyzeSummary: localStorage.getItem('ai_analyze_summary') !== 'false',
            analyzeImpact: localStorage.getItem('ai_analyze_impact') !== 'false',
            analyzeRisks: localStorage.getItem('ai_analyze_risks') !== 'false',
            analyzeRecommendations: localStorage.getItem('ai_analyze_recommendations') !== 'false',
            analyzeCategories: localStorage.getItem('ai_analyze_categories') === 'true'
        };

        // Load AI settings into UI
        function loadAiSettings() {
            const apiKeyField = document.getElementById('geminiApiKey');
            const modelField = document.getElementById('geminiModel');
            const autoAnalyzeField = document.getElementById('aiAutoAnalyze');
            const summaryField = document.getElementById('aiAnalyzeSummary');
            const impactField = document.getElementById('aiAnalyzeImpact');
            const risksField = document.getElementById('aiAnalyzeRisks');
            const recommendationsField = document.getElementById('aiAnalyzeRecommendations');
            const categoriesField = document.getElementById('aiAnalyzeCategories');

            if (apiKeyField) apiKeyField.value = aiSettings.apiKey;
            if (modelField) modelField.value = aiSettings.model;
            if (autoAnalyzeField) autoAnalyzeField.checked = aiSettings.autoAnalyze;
            if (summaryField) summaryField.checked = aiSettings.analyzeSummary;
            if (impactField) impactField.checked = aiSettings.analyzeImpact;
            if (risksField) risksField.checked = aiSettings.analyzeRisks;
            if (recommendationsField) recommendationsField.checked = aiSettings.analyzeRecommendations;
            if (categoriesField) categoriesField.checked = aiSettings.analyzeCategories;
        }

        // Save AI settings
        function saveAiSettings() {
            const apiKeyField = document.getElementById('geminiApiKey');
            const modelField = document.getElementById('geminiModel');
            const autoAnalyzeField = document.getElementById('aiAutoAnalyze');
            const summaryField = document.getElementById('aiAnalyzeSummary');
            const impactField = document.getElementById('aiAnalyzeImpact');
            const risksField = document.getElementById('aiAnalyzeRisks');
            const recommendationsField = document.getElementById('aiAnalyzeRecommendations');
            const categoriesField = document.getElementById('aiAnalyzeCategories');

            aiSettings.apiKey = apiKeyField?.value || '';
            aiSettings.model = modelField?.value || 'gemini-1.5-pro';
            aiSettings.autoAnalyze = autoAnalyzeField?.checked || false;
            aiSettings.analyzeSummary = summaryField?.checked !== false;
            aiSettings.analyzeImpact = impactField?.checked !== false;
            aiSettings.analyzeRisks = risksField?.checked !== false;
            aiSettings.analyzeRecommendations = recommendationsField?.checked !== false;
            aiSettings.analyzeCategories = categoriesField?.checked || false;

            // Save to localStorage
            localStorage.setItem('gemini_api_key', aiSettings.apiKey);
            localStorage.setItem('gemini_model', aiSettings.model);
            localStorage.setItem('ai_auto_analyze', aiSettings.autoAnalyze.toString());
            localStorage.setItem('ai_analyze_summary', aiSettings.analyzeSummary.toString());
            localStorage.setItem('ai_analyze_impact', aiSettings.analyzeImpact.toString());
            localStorage.setItem('ai_analyze_risks', aiSettings.analyzeRisks.toString());
            localStorage.setItem('ai_analyze_recommendations', aiSettings.analyzeRecommendations.toString());
            localStorage.setItem('ai_analyze_categories', aiSettings.analyzeCategories.toString());
        }

        // Test Gemini API key
        async function testGeminiApiKey(apiKey) {
            if (!apiKey) {
                showToast('–í–≤–µ–¥—ñ—Ç—å API –∫–ª—é—á', 'error');
                return false;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (response.ok) {
                    showToast('‚úÖ API –∫–ª—é—á –ø—Ä–∞—Ü—é—î!', 'success');
                    return true;
                } else {
                    const error = await response.json();
                    showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞ API: ${error.error?.message || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'}`, 'error');
                    return false;
                }
            } catch (error) {
                showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${error.message}`, 'error');
                return false;
            }
        }

        // Call Gemini AI API
        async function callGeminiAI(prompt, differences) {
            if (!aiSettings.apiKey) {
                throw new Error('API –∫–ª—é—á –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ');
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${aiSettings.model}:generateContent?key=${aiSettings.apiKey}`;
            
            const requestBody = {
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    temperature: 0.4,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 2048,
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || '–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ AI';
            } catch (error) {
                console.error('Gemini AI API Error:', error);
                throw error;
            }
        }

        // Create prompt for AI analysis
        function createAnalysisPrompt(differences) {
            const diffCount = differences.length;
            const diffTypes = [...new Set(differences.map(d => d.type))];
            const criticalDiffs = differences.filter(d => getImportanceLevel(d) === 'critical');
            
            const analysisTypes = [];
            if (aiSettings.analyzeSummary) analysisTypes.push('–∑–∞–≥–∞–ª—å–Ω–∏–π –ø—ñ–¥—Å—É–º–æ–∫');
            if (aiSettings.analyzeImpact) analysisTypes.push('–∞–Ω–∞–ª—ñ–∑ –≤–ø–ª–∏–≤—É');
            if (aiSettings.analyzeRisks) analysisTypes.push('–≤–∏—è–≤–ª–µ–Ω–Ω—è —Ä–∏–∑–∏–∫—ñ–≤');
            if (aiSettings.analyzeRecommendations) analysisTypes.push('—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó');
            if (aiSettings.analyzeCategories) analysisTypes.push('–∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—è');

            let prompt = `–¢–∏ –µ–∫—Å–ø–µ—Ä—Ç –∑ –∞–Ω–∞–ª—ñ–∑—É JSON —Å—Ç—Ä—É–∫—Ç—É—Ä. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –Ω–∞—Å—Ç—É–ø–Ω—ñ –∑–º—ñ–Ω–∏ —É JSON —Ñ–∞–π–ª—ñ:

–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ú–Ü–ù:
- –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–º—ñ–Ω: ${diffCount}
- –¢–∏–ø–∏ –∑–º—ñ–Ω: ${diffTypes.join(', ')}
- –ö—Ä–∏—Ç–∏—á–Ω–∏—Ö –∑–º—ñ–Ω: ${criticalDiffs.length}

–î–ï–¢–ê–õ–Ü –ó–ú–Ü–ù:
${differences.slice(0, 20).map((diff, i) => `${i+1}. ${diff.type} –≤ "${diff.path}": ${diff.oldValue || '–≤—ñ–¥—Å—É—Ç–Ω—î'} ‚Üí ${diff.newValue || '–≤—ñ–¥—Å—É—Ç–Ω—î'} (–≤–∞–∂–ª–∏–≤—ñ—Å—Ç—å: ${getImportanceLevel(diff)})`).join('\n')}
${differences.length > 20 ? `\n... —Ç–∞ —â–µ ${differences.length - 20} –∑–º—ñ–Ω` : ''}

–ù–∞–¥–∞–π –∞–Ω–∞–ª—ñ–∑ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, –≤–∫–ª—é—á–∞—é—á–∏:
${analysisTypes.map(type => `- ${type}`).join('\n')}

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –∑ –µ–º–æ–¥–∑—ñ –¥–ª—è –∫—Ä–∞—â–æ—ó —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ.`;

            return prompt;
        }

        // Perform AI analysis
        async function performAiAnalysis(differences) {
            if (!differences || differences.length === 0) {
                showToast('–ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É', 'warning');
                return;
            }

            if (!aiSettings.apiKey) {
                showToast('–ù–∞–ª–∞—à—Ç—É–π—Ç–µ API –∫–ª—é—á –¥–ª—è AI –∞–Ω–∞–ª—ñ–∑—É', 'warning');
                return;
            }

            const aiLoader = document.getElementById('aiLoader');
            const aiSection = document.getElementById('aiAnalysisSection');
            const aiContent = document.getElementById('aiAnalysisContent');

            try {
                // Show loading
                if (aiLoader) aiLoader.style.display = 'block';
                if (aiSection) aiSection.style.display = 'block';
                if (aiContent) aiContent.innerHTML = '<p>ü§ñ AI –∞–Ω–∞–ª—ñ–∑—É—î –∑–º—ñ–Ω–∏...</p>';

                const prompt = createAnalysisPrompt(differences);
                const analysis = await callGeminiAI(prompt, differences);
                
                // Display results
                if (aiContent) {
                    aiContent.innerHTML = `
                        <div style="background: var(--main-color); padding: 15px; border-radius: 6px; border-left: 4px solid var(--accent-color);">
                            <div style="white-space: pre-wrap; line-height: 1.6;">${analysis}</div>
                        </div>
                        <div style="margin-top: 10px; text-align: right; font-size: 0.9em; color: var(--text-muted);">
                            –ê–Ω–∞–ª—ñ–∑ –≤–∏–∫–æ–Ω–∞–Ω–æ: ${new Date().toLocaleString('uk-UA')} | –ú–æ–¥–µ–ª—å: ${aiSettings.model}
                        </div>
                    `;
                }

                showToast('‚ú® AI –∞–Ω–∞–ª—ñ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'success');
            } catch (error) {
                console.error('AI Analysis Error:', error);
                if (aiContent) {
                    aiContent.innerHTML = `
                        <div style="background: var(--toast-error-bg); padding: 15px; border-radius: 6px; border-left: 4px solid var(--red); color: var(--red);">
                            ‚ùå –ü–æ–º–∏–ª–∫–∞ AI –∞–Ω–∞–ª—ñ–∑—É: ${error.message}
                        </div>
                    `;
                }
                showToast(`–ü–æ–º–∏–ª–∫–∞ AI –∞–Ω–∞–ª—ñ–∑—É: ${error.message}`, 'error');
            } finally {
                if (aiLoader) aiLoader.style.display = 'none';
            }
        }

                // Initialize AI functionality
        document.addEventListener('DOMContentLoaded', function() {
            loadAiSettings();

            // AI handlers for integrated settings
            const testApiKeyBtn = document.getElementById('testApiKey');
            const aiAnalyzeBtn = document.getElementById('aiAnalyzeBtn');

            if (testApiKeyBtn) {
                testApiKeyBtn.addEventListener('click', async () => {
                    const apiKey = document.getElementById('geminiApiKey')?.value;
                    await testGeminiApiKey(apiKey);
                });
            }

            if (aiAnalyzeBtn) {
                aiAnalyzeBtn.addEventListener('click', () => {
                    if (window.lastDifferences && window.lastDifferences.length > 0) {
                        performAiAnalysis(window.lastDifferences);
                    } else {
                        showToast('–°–ø–æ—á–∞—Ç–∫—É –ø–æ—Ä—ñ–≤–Ω—è–π—Ç–µ JSON —Ñ–∞–π–ª–∏', 'warning');
                    }
                });
            }

            // --- Drag & Drop Functionality ---
            initializeDragAndDrop();

            // --- JSON Formatter Functionality ---
            initializeJSONFormatter();

            // --- History Functionality ---
            initializeHistory();

            // --- Real-time JSON Editor ---
            initializeRealtimeJsonEditor();

            // --- Settings Templates ---
            initializeSettingsTemplates();

            // --- Batch Processing ---
            initializeBatchProcessing();

            // --- AI Schema Generation ---
            initializeAiSchemaGeneration();

            // --- Smart Ignore Rules ---
            initializeSmartIgnoreRules();
        });

        // Drag & Drop Implementation
        function initializeDragAndDrop() {
            const dropZones = [
                { zone: document.getElementById('dropZone1'), textarea: document.getElementById('sourceText'), fileName: document.getElementById('fileName1') },
                { zone: document.getElementById('dropZone2'), textarea: document.getElementById('targetText'), fileName: document.getElementById('fileName2') },
                { zone: document.getElementById('dropZoneSchema'), textarea: document.getElementById('schemaText'), fileName: document.getElementById('fileNameSchema') }
            ];

            dropZones.forEach(({ zone, textarea, fileName }) => {
                if (!zone || !textarea) return;

                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    zone.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                // Highlight drop zone when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    zone.addEventListener(eventName, () => highlightDropZone(zone), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    zone.addEventListener(eventName, () => unhighlightDropZone(zone), false);
                });

                // Handle dropped files
                zone.addEventListener('drop', (e) => handleDrop(e, textarea, fileName), false);
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlightDropZone(zone) {
            zone.classList.add('drag-over');
        }

        function unhighlightDropZone(zone) {
            zone.classList.remove('drag-over', 'drag-invalid');
        }

        function handleDrop(e, textarea, fileNameElement) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length === 0) {
                showToast('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª—ñ–≤ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è', 'warning');
                return;
            }

            if (files.length > 1) {
                showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å –ª–∏—à–µ –æ–¥–∏–Ω —Ñ–∞–π–ª', 'warning');
                return;
            }

            const file = files[0];
            
            // Validate file type
            if (!isValidJSONFile(file)) {
                const zone = e.currentTarget;
                zone.classList.add('drag-invalid');
                setTimeout(() => zone.classList.remove('drag-invalid'), 500);
                showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ JSON —Ñ–∞–π–ª (.json –∞–±–æ .txt)', 'error');
                return;
            }

            // Success animation
            const zone = e.currentTarget;
            zone.classList.add('drop-success');
            setTimeout(() => zone.classList.remove('drop-success'), 600);

            // Read file
            readJSONFile(file, textarea, fileNameElement);
        }

        function isValidJSONFile(file) {
            const validTypes = ['application/json', 'text/json', 'text/plain'];
            const validExtensions = ['.json', '.txt'];
            
            const hasValidType = validTypes.includes(file.type);
            const hasValidExtension = validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
            
            return hasValidType || hasValidExtension || file.type === '';
        }

        function readJSONFile(file, textarea, fileNameElement) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // Try to parse JSON to validate
                    JSON.parse(content);
                    
                    // If parsing successful, set content
                    textarea.value = content;
                    
                    // Update file name display
                    if (fileNameElement) {
                        fileNameElement.textContent = `üìÅ ${file.name} (${formatFileSize(file.size)})`;
                        fileNameElement.style.display = 'block';
                    }
                    
                    // Clear any existing errors
                    const errorElement = getErrorElementForTextarea(textarea);
                    if (errorElement) {
                        errorElement.textContent = '';
                        textarea.setAttribute('aria-invalid', 'false');
                    }
                    
                    // Trigger change event
                    textarea.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    showToast(`‚úÖ –§–∞–π–ª "${file.name}" —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ`, 'success');
                    
                } catch (error) {
                    console.error('JSON parsing error:', error);
                    showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ JSON —Ñ–∞–π–ª—ñ: ${error.message}`, 'error');
                    
                    // Still load content but show error
                    textarea.value = e.target.result;
                    
                    const errorElement = getErrorElementForTextarea(textarea);
                    if (errorElement) {
                        errorElement.textContent = `–ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON: ${error.message}`;
                        textarea.setAttribute('aria-invalid', 'true');
                    }
                }
            };
            
            reader.onerror = function() {
                showToast('‚ùå –ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É', 'error');
            };
            
            reader.readAsText(file);
        }

        function getErrorElementForTextarea(textarea) {
            const textareaId = textarea.id;
            const errorId = textareaId.replace('Text', 'Error');
            return document.getElementById(errorId);
        }

                 function formatFileSize(bytes) {
             if (bytes === 0) return '0 Bytes';
             const k = 1024;
             const sizes = ['Bytes', 'KB', 'MB', 'GB'];
             const i = Math.floor(Math.log(bytes) / Math.log(k));
             return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
         }

         // JSON Formatter Implementation
         function initializeJSONFormatter() {
             document.addEventListener('click', function(e) {
                 if (e.target.classList.contains('formatter-btn')) {
                     const targetId = e.target.getAttribute('data-target');
                     const textarea = document.getElementById(targetId);
                     
                     if (!textarea) return;
                     
                     if (e.target.classList.contains('beautify')) {
                         beautifyJSON(textarea);
                     } else if (e.target.classList.contains('minify')) {
                         minifyJSON(textarea);
                     } else if (e.target.classList.contains('validate')) {
                         validateJSON(textarea);
                     }
                 }
             });
         }

         function beautifyJSON(textarea) {
             const content = textarea.value.trim();
             
             if (!content) {
                 showToast('–ù–µ–º–∞—î JSON –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è', 'warning');
                 return;
             }

             try {
                 const jsonObject = JSON.parse(content);
                 const beautified = JSON.stringify(jsonObject, null, 2);
                 
                 textarea.value = beautified;
                 
                 // Clear any errors
                 const errorElement = getErrorElementForTextarea(textarea);
                 if (errorElement) {
                     errorElement.textContent = '';
                     textarea.setAttribute('aria-invalid', 'false');
                 }
                 
                 // Trigger change event
                 textarea.dispatchEvent(new Event('input', { bubbles: true }));
                 
                 showToast('‚ú® JSON –≤—ñ–¥—Ñ–æ—Ä–º–∞—Ç–æ–≤–∞–Ω–æ!', 'success');
                 
             } catch (error) {
                 showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞ JSON: ${error.message}`, 'error');
                 highlightJSONError(textarea, error);
             }
         }

         function minifyJSON(textarea) {
             const content = textarea.value.trim();
             
             if (!content) {
                 showToast('–ù–µ–º–∞—î JSON –¥–ª—è —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è', 'warning');
                 return;
             }

             try {
                 const jsonObject = JSON.parse(content);
                 const minified = JSON.stringify(jsonObject);
                 
                 textarea.value = minified;
                 
                 // Clear any errors
                 const errorElement = getErrorElementForTextarea(textarea);
                 if (errorElement) {
                     errorElement.textContent = '';
                     textarea.setAttribute('aria-invalid', 'false');
                 }
                 
                 // Trigger change event
                 textarea.dispatchEvent(new Event('input', { bubbles: true }));
                 
                 const originalLength = content.length;
                 const minifiedLength = minified.length;
                 const savedBytes = originalLength - minifiedLength;
                 const savedPercent = ((savedBytes / originalLength) * 100).toFixed(1);
                 
                 showToast(`üì¶ JSON —Å—Ç–∏—Å–Ω–µ–Ω–æ! –ó–µ–∫–æ–Ω–æ–º–ª–µ–Ω–æ ${savedBytes} —Å–∏–º–≤–æ–ª—ñ–≤ (${savedPercent}%)`, 'success');
                 
             } catch (error) {
                 showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞ JSON: ${error.message}`, 'error');
                 highlightJSONError(textarea, error);
             }
         }

         function validateJSON(textarea) {
             const content = textarea.value.trim();
             
             if (!content) {
                 showToast('–ù–µ–º–∞—î JSON –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏', 'warning');
                 return;
             }

             try {
                 const jsonObject = JSON.parse(content);
                 
                 // Clear any errors
                 const errorElement = getErrorElementForTextarea(textarea);
                 if (errorElement) {
                     errorElement.textContent = '';
                     textarea.setAttribute('aria-invalid', 'false');
                 }
                 
                 // Count properties for detailed info
                 const stats = getJSONStats(jsonObject);
                 
                 showToast(`‚úÖ –í–∞–ª—ñ–¥–Ω–∏–π JSON! ${stats}`, 'success');
                 
             } catch (error) {
                 const errorElement = getErrorElementForTextarea(textarea);
                 if (errorElement) {
                     errorElement.textContent = `–ü–æ–º–∏–ª–∫–∞ JSON: ${error.message}`;
                     textarea.setAttribute('aria-invalid', 'true');
                 }
                 
                 showToast(`‚ùå –ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON: ${error.message}`, 'error');
                 highlightJSONError(textarea, error);
             }
         }

         function highlightJSONError(textarea, error) {
             // Try to extract line number from error message
             const lineMatch = error.message.match(/line (\d+)|position (\d+)/i);
             if (lineMatch) {
                 const position = parseInt(lineMatch[1] || lineMatch[2]);
                 if (position && textarea.setSelectionRange) {
                     setTimeout(() => {
                         textarea.focus();
                         textarea.setSelectionRange(Math.max(0, position - 10), Math.min(textarea.value.length, position + 10));
                     }, 100);
                 }
             }
         }

         function getJSONStats(obj) {
             const type = Array.isArray(obj) ? 'Array' : typeof obj;
             
             if (Array.isArray(obj)) {
                 return `–ú–∞—Å–∏–≤ –∑ ${obj.length} –µ–ª–µ–º–µ–Ω—Ç—ñ–≤`;
             } else if (typeof obj === 'object' && obj !== null) {
                 const keys = Object.keys(obj);
                 return `–û–±'—î–∫—Ç –∑ ${keys.length} –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—è–º–∏`;
             } else {
                 return `–¢–∏–ø: ${type}`;
             }
         }

         // Enhanced JSON validation with detailed error reporting
         function validateJSONWithDetails(content) {
             try {
                 const obj = JSON.parse(content);
                 return {
                     valid: true,
                     data: obj,
                     stats: getJSONStats(obj),
                     size: content.length
                 };
             } catch (error) {
                 return {
                     valid: false,
                     error: error.message,
                     line: extractLineNumber(error.message),
                     column: extractColumnNumber(error.message)
                 };
             }
         }

         function extractLineNumber(errorMessage) {
             const match = errorMessage.match(/line (\d+)/i);
             return match ? parseInt(match[1]) : null;
         }

         function extractColumnNumber(errorMessage) {
             const match = errorMessage.match(/column (\d+)/i);
             return match ? parseInt(match[1]) : null;
         }

         // History Management Implementation
         const HISTORY_KEY = 'jsonComparatorHistory';
         const MAX_HISTORY_ITEMS = 20;

         function initializeHistory() {
             const historyBtn = document.getElementById('historyBtn');
             const historyModal = document.getElementById('historyModal');
             const closeHistoryModal = document.getElementById('closeHistoryModal');
             const clearHistoryBtn = document.getElementById('clearHistoryBtn');
             const exportHistoryBtn = document.getElementById('exportHistoryBtn');

             if (historyBtn) {
                 historyBtn.addEventListener('click', () => {
                     openHistoryModal();
                 });
             }

             if (closeHistoryModal) {
                 closeHistoryModal.addEventListener('click', () => {
                     historyModal.style.display = 'none';
                 });
             }

             if (clearHistoryBtn) {
                 clearHistoryBtn.addEventListener('click', () => {
                     clearHistory();
                 });
             }

             if (exportHistoryBtn) {
                 exportHistoryBtn.addEventListener('click', () => {
                     exportHistory();
                 });
             }

             // Close modal on outside click
             if (historyModal) {
                 historyModal.addEventListener('click', (event) => {
                     if (event.target === historyModal) {
                         historyModal.style.display = 'none';
                     }
                 });
             }
         }

         function saveToHistory(sourceData, targetData, schemaData, differences, mode) {
             try {
                 const history = getHistory();
                 
                 const historyItem = {
                     id: Date.now(),
                     timestamp: new Date().toISOString(),
                     mode: mode,
                     sourceData: sourceData ? sourceData.substring(0, 1000) + (sourceData.length > 1000 ? '...' : '') : '',
                     targetData: targetData ? targetData.substring(0, 1000) + (targetData.length > 1000 ? '...' : '') : '',
                     schemaData: schemaData ? schemaData.substring(0, 1000) + (schemaData.length > 1000 ? '...' : '') : '',
                     fullSourceData: sourceData || '',
                     fullTargetData: targetData || '',
                     fullSchemaData: schemaData || '',
                     differenceCount: differences.length,
                     summary: generateComparisonSummary(differences),
                     title: generateComparisonTitle(mode, differences.length)
                 };

                 // Add to beginning of array
                 history.unshift(historyItem);

                 // Limit history size
                 if (history.length > MAX_HISTORY_ITEMS) {
                     history.splice(MAX_HISTORY_ITEMS);
                 }

                 localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                 console.log('Comparison saved to history:', historyItem.title);
                 
             } catch (error) {
                 console.error('Failed to save to history:', error);
             }
         }

         function getHistory() {
             try {
                 const historyJson = localStorage.getItem(HISTORY_KEY);
                 return historyJson ? JSON.parse(historyJson) : [];
             } catch (error) {
                 console.error('Failed to load history:', error);
                 return [];
             }
         }

         function generateComparisonTitle(mode, diffCount) {
             const modeNames = {
                 'direct': '–ü—Ä—è–º–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è',
                 'keys': '–†–æ–∑—É–º–Ω–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è',
                 'schema': '–í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ö–µ–º–∏'
             };
             
             const modeName = modeNames[mode] || '–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è';
             return `${modeName} (${diffCount} ${diffCount === 1 ? '–∑–º—ñ–Ω–∞' : diffCount < 5 ? '–∑–º—ñ–Ω–∏' : '–∑–º—ñ–Ω'})`;
         }

         function generateComparisonSummary(differences) {
             if (differences.length === 0) {
                 return '–í—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
             }

             const types = {};
             differences.forEach(diff => {
                 types[diff.type] = (types[diff.type] || 0) + 1;
             });

             const summary = Object.entries(types)
                 .map(([type, count]) => `${type}: ${count}`)
                 .join(', ');

             return summary;
         }

         function openHistoryModal() {
             const historyModal = document.getElementById('historyModal');
             const historyList = document.getElementById('historyList');
             const historyEmpty = document.getElementById('historyEmpty');
             const historyStats = document.getElementById('historyStats');

             if (!historyModal) return;

             historyModal.style.display = 'flex';
             loadHistoryItems();
         }

         function loadHistoryItems() {
             const history = getHistory();
             const historyList = document.getElementById('historyList');
             const historyEmpty = document.getElementById('historyEmpty');
             const historyStats = document.getElementById('historyStats');

             if (history.length === 0) {
                 historyList.innerHTML = '';
                 historyEmpty.style.display = 'block';
                 historyStats.innerHTML = '–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä—ñ–≤–Ω—è–Ω—å –ø—É—Å—Ç–∞';
                 return;
             }

             historyEmpty.style.display = 'none';

             // Update stats
             const totalComparisons = history.length;
             const totalDifferences = history.reduce((sum, item) => sum + item.differenceCount, 0);
             const oldestDate = new Date(history[history.length - 1].timestamp).toLocaleDateString('uk-UA');
             
             historyStats.innerHTML = `
                 üìä ${totalComparisons} –ø–æ—Ä—ñ–≤–Ω—è–Ω—å ‚Ä¢ üîç ${totalDifferences} –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π ‚Ä¢ üìÖ –ù–∞–π—Å—Ç–∞—Ä—ñ—à–µ: ${oldestDate}
             `;

             // Render history items
             historyList.innerHTML = history.map(item => `
                 <div class="history-item" data-id="${item.id}">
                     <div class="history-info">
                         <div class="history-title">${item.title}</div>
                         <div class="history-meta">
                             <span>üìÖ ${new Date(item.timestamp).toLocaleString('uk-UA')}</span>
                             <span>üìã ${item.mode}</span>
                             <span>üìÑ ${item.summary}</span>
                         </div>
                     </div>
                     <div class="history-actions">
                         <button class="history-btn load" onclick="loadHistoryItem(${item.id})" title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
                         <button class="history-btn delete" onclick="deleteHistoryItem(${item.id})" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>
                     </div>
                 </div>
             `).join('');
         }

         function loadHistoryItem(id) {
             const history = getHistory();
             const item = history.find(h => h.id === id);
             
             if (!item) {
                 showToast('–Ü—Å—Ç–æ—Ä–∏—á–Ω–∏–π –∑–∞–ø–∏—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                 return;
             }

             // Load data into textareas
             const sourceText = document.getElementById('sourceText');
             const targetText = document.getElementById('targetText');
             const schemaText = document.getElementById('schemaText');

             if (sourceText) sourceText.value = item.fullSourceData;
             if (targetText) targetText.value = item.fullTargetData;
             if (schemaText && item.fullSchemaData) schemaText.value = item.fullSchemaData;

             // Set mode
             const modeRadio = document.querySelector(`input[name="compareMode"][value="${item.mode}"]`);
             if (modeRadio) {
                 modeRadio.checked = true;
                 // Trigger change event to update UI
                 modeRadio.dispatchEvent(new Event('change', { bubbles: true }));
             }

             // Close modal
             const historyModal = document.getElementById('historyModal');
             if (historyModal) historyModal.style.display = 'none';

             showToast(`‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ${item.title}`, 'success');

             // Auto-run comparison if data is valid
             setTimeout(() => {
                 if (sourceText.value && targetText.value) {
                     const compareBtn = document.getElementById('compareBtn');
                     if (compareBtn && !compareBtn.disabled) {
                         compareBtn.click();
                     }
                 }
             }, 500);
         }

         function deleteHistoryItem(id) {
             if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å –∑ —ñ—Å—Ç–æ—Ä—ñ—ó?')) return;

             const history = getHistory();
             const filteredHistory = history.filter(item => item.id !== id);
             
             localStorage.setItem(HISTORY_KEY, JSON.stringify(filteredHistory));
             loadHistoryItems();
             
             showToast('–ó–∞–ø–∏—Å –≤–∏–¥–∞–ª–µ–Ω–æ –∑ —ñ—Å—Ç–æ—Ä—ñ—ó', 'success');
         }

         function clearHistory() {
             if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ—Ä—ñ–≤–Ω—è–Ω—å? –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;

             localStorage.removeItem(HISTORY_KEY);
             loadHistoryItems();
             
             showToast('–Ü—Å—Ç–æ—Ä—ñ—é –æ—á–∏—â–µ–Ω–æ', 'success');
         }

         function exportHistory() {
             const history = getHistory();
             
             if (history.length === 0) {
                 showToast('–Ü—Å—Ç–æ—Ä—ñ—è –ø—É—Å—Ç–∞ - –Ω–µ–º–∞—î —â–æ –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏', 'warning');
                 return;
             }

             const exportData = {
                 exportDate: new Date().toISOString(),
                 version: '1.0',
                 totalItems: history.length,
                 history: history
             };

             const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `json-comparator-history-${new Date().toISOString().split('T')[0]}.json`;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
             URL.revokeObjectURL(url);

             showToast(`üìÅ –Ü—Å—Ç–æ—Ä—ñ—é –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ (${history.length} –∑–∞–ø–∏—Å—ñ–≤)`, 'success');
         }

                   // Hook into existing comparison function to save to history
          // This needs to be called after comparison completes
          function saveCurrentComparisonToHistory() {
              try {
                  const sourceText = document.getElementById('sourceText')?.value || '';
                  const targetText = document.getElementById('targetText')?.value || '';
                  const schemaText = document.getElementById('schemaText')?.value || '';
                  const currentMode = document.querySelector('input[name="compareMode"]:checked')?.value || 'direct';
                  
                  if (window.lastDifferences && (sourceText || targetText)) {
                      saveToHistory(sourceText, targetText, schemaText, window.lastDifferences, currentMode);
                  }
              } catch (error) {
                  console.error('Failed to save comparison to history:', error);
              }
          }

          // Side-by-Side Diff Viewer Implementation
          let diffViewMode = 'table'; // 'table' or 'side-by-side'

          function addSideBySideViewToggle(sourceJson, targetJson, differences) {
              const resultsContainer = document.getElementById('results');
              if (!resultsContainer) return;

              // Create view mode toggle
              const viewModeToggle = document.createElement('div');
              viewModeToggle.className = 'view-mode-toggle';
              viewModeToggle.innerHTML = `
                  <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                      <span style="font-weight: 600; color: var(--header-color);">–†–µ–∂–∏–º –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è:</span>
                                             <button class="view-mode-btn ${diffViewMode === 'table' ? 'active' : ''}" data-mode="table">
                           üìã –¢–∞–±–ª–∏—Ü—è
                       </button>
                       <button class="view-mode-btn ${diffViewMode === 'side-by-side' ? 'active' : ''}" data-mode="side-by-side">
                          üë• –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø–æ—Ä—è–¥
                      </button>
                      <div style="margin-left: auto; font-size: 0.9em; color: var(--text-muted);">
                          ${differences.length} –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π –∑–Ω–∞–π–¥–µ–Ω–æ
                      </div>
                  </div>
              `;

              // Create search container
              const searchContainer = createAdvancedSearchContainer(differences);
              
              // Insert search and toggle at the beginning of results
              resultsContainer.insertBefore(searchContainer, resultsContainer.firstChild);
              resultsContainer.insertBefore(viewModeToggle, searchContainer.nextSibling);

              // Add event listeners
              const toggleButtons = viewModeToggle.querySelectorAll('.view-mode-btn');
              toggleButtons.forEach(btn => {
                  btn.addEventListener('click', () => {
                      const mode = btn.getAttribute('data-mode');
                      switchViewMode(mode, sourceJson, targetJson, differences);
                  });
              });

              // Store data for mode switching
              window.currentComparisonData = {
                  sourceJson,
                  targetJson,
                  differences
              };
          }

                     function switchViewMode(mode, sourceJson, targetJson, differences) {
               diffViewMode = mode;
              
              // Update active button
              document.querySelectorAll('.view-mode-btn').forEach(btn => {
                  btn.classList.toggle('active', btn.getAttribute('data-mode') === mode);
              });

              const resultsContainer = document.getElementById('results');
              const existingContent = resultsContainer.querySelector(':not(.view-mode-toggle)');
              
              if (mode === 'side-by-side') {
                  // Hide existing content and show side-by-side view
                  if (existingContent) existingContent.style.display = 'none';
                  
                  let sideBySideContainer = resultsContainer.querySelector('.side-by-side-container');
                  if (!sideBySideContainer) {
                      sideBySideContainer = createSideBySideView(sourceJson, targetJson, differences);
                      resultsContainer.appendChild(sideBySideContainer);
                  } else {
                      sideBySideContainer.style.display = 'flex';
                  }
              } else {
                  // Show table view and hide side-by-side
                  if (existingContent) existingContent.style.display = 'block';
                  
                  const sideBySideContainer = resultsContainer.querySelector('.side-by-side-container');
                  if (sideBySideContainer) {
                      sideBySideContainer.style.display = 'none';
                  }
              }
          }

          function createSideBySideView(sourceJson, targetJson, differences) {
              const container = document.createElement('div');
              container.className = 'side-by-side-container';

              const sourceFormatted = JSON.stringify(sourceJson, null, 2);
              const targetFormatted = JSON.stringify(targetJson, null, 2);

              const sourceLines = sourceFormatted.split('\n');
              const targetLines = targetFormatted.split('\n');

              // Create diff mapping
              const diffMap = createDiffMapping(differences, sourceJson, targetJson);

              container.innerHTML = `
                  <div class="side-panel left">
                      <div class="side-panel-header">
                          üìÑ Source JSON
                          <span style="margin-left: auto; font-size: 0.8em; opacity: 0.7;">${sourceLines.length} —Ä—è–¥–∫—ñ–≤</span>
                      </div>
                      <div class="side-panel-content sync-scroll" id="leftPanel">
                          ${renderDiffLines(sourceLines, diffMap.source, 'source')}
                      </div>
                  </div>
                  <div class="side-panel right">
                      <div class="side-panel-header">
                          üìÑ Target JSON
                          <span style="margin-left: auto; font-size: 0.8em; opacity: 0.7;">${targetLines.length} —Ä—è–¥–∫—ñ–≤</span>
                      </div>
                      <div class="side-panel-content sync-scroll" id="rightPanel">
                          ${renderDiffLines(targetLines, diffMap.target, 'target')}
                      </div>
                  </div>
              `;

              // Add synchronized scrolling
              setTimeout(() => {
                  setupSynchronizedScrolling();
              }, 100);

              return container;
          }

          function createDiffMapping(differences, sourceJson, targetJson) {
              const mapping = {
                  source: new Map(),
                  target: new Map()
              };

              differences.forEach(diff => {
                  try {
                      const path = diff.path;
                      
                      // Simple path-based mapping for demonstration
                      // In a real implementation, you'd need more sophisticated line mapping
                      const pathSegments = path.split('.').filter(p => p !== '$');
                      
                      if (pathSegments.length > 0) {
                          const key = pathSegments[pathSegments.length - 1];
                          
                          if (diff.type.includes('Add')) {
                              mapping.target.set(key, 'added');
                          } else if (diff.type.includes('Remov')) {
                              mapping.source.set(key, 'removed');
                          } else {
                              mapping.source.set(key, 'modified');
                              mapping.target.set(key, 'modified');
                          }
                      }
                  } catch (error) {
                      console.warn('Error processing diff for mapping:', error);
                  }
              });

              return mapping;
          }

          function renderDiffLines(lines, diffMap, side) {
              return lines.map((line, index) => {
                  let diffClass = 'context';
                  let diffType = '';

                  // Check if this line contains any of the changed keys
                  for (const [key, type] of diffMap.entries()) {
                      if (line.includes(`"${key}"`)) {
                          diffClass = type;
                          diffType = type;
                          break;
                      }
                  }

                  const lineNumber = index + 1;
                  const escapedLine = escapeHtml(line);
                  
                  return `
                      <div class="diff-line ${diffClass}" data-line="${lineNumber}">
                          <span class="diff-line-number">${lineNumber}</span>
                          ${diffType ? `<span class="diff-highlight">${escapedLine}</span>` : escapedLine}
                      </div>
                  `;
              }).join('');
          }

          function escapeHtml(text) {
              const div = document.createElement('div');
              div.textContent = text;
              return div.innerHTML;
          }

          function setupSynchronizedScrolling() {
              const leftPanel = document.getElementById('leftPanel');
              const rightPanel = document.getElementById('rightPanel');

              if (!leftPanel || !rightPanel) return;

              let isScrolling = false;

              function syncScroll(source, target) {
                  if (isScrolling) return;
                  isScrolling = true;
                  
                  const percentage = source.scrollTop / (source.scrollHeight - source.clientHeight);
                  target.scrollTop = percentage * (target.scrollHeight - target.clientHeight);
                  
                  setTimeout(() => {
                      isScrolling = false;
                  }, 10);
              }

                             leftPanel.addEventListener('scroll', () => syncScroll(leftPanel, rightPanel));
               rightPanel.addEventListener('scroll', () => syncScroll(rightPanel, leftPanel));
           }

           // Advanced Search Implementation
           let searchState = {
               query: '',
               caseSensitive: false,
               searchInPaths: true,
               searchInValues: true,
               searchInTypes: true,
               regexMode: false
           };

           function createAdvancedSearchContainer(differences) {
               const container = document.createElement('div');
               container.className = 'search-container';
               container.id = 'advancedSearchContainer';
               
               container.innerHTML = `
                   <div class="search-box">
                       <input type="text" class="search-input" id="searchInput" 
                              placeholder="–ü–æ—à—É–∫ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö... (–ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è JSONPath —Ç–∞ —Ä–µ–≥—É–ª—è—Ä–Ω—ñ –≤–∏—Ä–∞–∑–∏)">
                       <span class="search-icon">üîç</span>
                   </div>
                   <div class="search-filters">
                       <div class="search-filter-group">
                           <input type="checkbox" id="searchPaths" checked>
                           <label for="searchPaths">–®–ª—è—Ö–∏</label>
                       </div>
                       <div class="search-filter-group">
                           <input type="checkbox" id="searchValues" checked>
                           <label for="searchValues">–ó–Ω–∞—á–µ–Ω–Ω—è</label>
                       </div>
                       <div class="search-filter-group">
                           <input type="checkbox" id="searchTypes" checked>
                           <label for="searchTypes">–¢–∏–ø–∏</label>
                       </div>
                       <div class="search-filter-group">
                           <input type="checkbox" id="caseSensitive">
                           <label for="caseSensitive">–†–µ–≥—ñ—Å—Ç—Ä</label>
                       </div>
                       <div class="search-filter-group">
                           <input type="checkbox" id="regexMode">
                           <label for="regexMode">Regex</label>
                       </div>
                       <button class="action-btn" id="clearSearch" style="padding: 6px 12px; font-size: 0.8em;">‚úñ –û—á–∏—Å—Ç–∏—Ç–∏</button>
                   </div>
                   <div class="search-stats" id="searchStats" style="display: none;">
                       üìä –ó–Ω–∞–π–¥–µ–Ω–æ: 0 –∑ ${differences.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                   </div>
               `;

               // Initialize search functionality
               setTimeout(() => {
                   initializeAdvancedSearch();
               }, 100);

               return container;
           }

           function initializeAdvancedSearch() {
               const searchInput = document.getElementById('searchInput');
               const searchPaths = document.getElementById('searchPaths');
               const searchValues = document.getElementById('searchValues');
               const searchTypes = document.getElementById('searchTypes');
               const caseSensitive = document.getElementById('caseSensitive');
               const regexMode = document.getElementById('regexMode');
               const clearSearch = document.getElementById('clearSearch');

               if (!searchInput) return;

               // Add event listeners
               searchInput.addEventListener('input', debounce(performSearch, 300));
               searchInput.addEventListener('keydown', (e) => {
                   if (e.key === 'Enter') {
                       e.preventDefault();
                       performSearch();
                   }
               });

               [searchPaths, searchValues, searchTypes, caseSensitive, regexMode].forEach(element => {
                   if (element) {
                       element.addEventListener('change', () => {
                           updateSearchState();
                           performSearch();
                       });
                   }
               });

               if (clearSearch) {
                   clearSearch.addEventListener('click', clearSearchResults);
               }

               // Initialize state
               updateSearchState();
           }

           function updateSearchState() {
               searchState.query = document.getElementById('searchInput')?.value || '';
               searchState.caseSensitive = document.getElementById('caseSensitive')?.checked || false;
               searchState.searchInPaths = document.getElementById('searchPaths')?.checked || true;
               searchState.searchInValues = document.getElementById('searchValues')?.checked || true;
               searchState.searchInTypes = document.getElementById('searchTypes')?.checked || true;
               searchState.regexMode = document.getElementById('regexMode')?.checked || false;
           }

           function performSearch() {
               updateSearchState();
               
               if (!searchState.query.trim()) {
                   clearSearchResults();
                   return;
               }

               try {
                   const results = searchInResults(searchState.query);
                   displaySearchResults(results);
               } catch (error) {
                   console.error('Search error:', error);
                   showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É: ${error.message}`, 'error');
               }
           }

           function searchInResults(query) {
               const resultsContainer = document.getElementById('results');
               if (!resultsContainer) return [];

               const searchResults = [];
               let totalElements = 0;

               // Search in table rows
               const tableRows = resultsContainer.querySelectorAll('tr[data-diff-index]');
               tableRows.forEach((row, index) => {
                   totalElements++;
                   const isMatch = checkRowMatch(row, query);
                   
                   if (isMatch) {
                       searchResults.push({
                           element: row,
                           type: 'table-row',
                           index: index,
                           content: getRowContent(row)
                       });
                       row.classList.add('search-match');
                       highlightMatches(row, query);
                   } else {
                       row.classList.remove('search-match');
                       removeHighlights(row);
                   }
               });

               // Search in side-by-side view
               const diffLines = resultsContainer.querySelectorAll('.diff-line');
               diffLines.forEach((line, index) => {
                   if (tableRows.length === 0) totalElements++; // Only count if not already counted table rows
                   
                   const isMatch = checkLineMatch(line, query);
                   
                   if (isMatch && tableRows.length === 0) {
                       searchResults.push({
                           element: line,
                           type: 'diff-line',
                           index: index,
                           content: line.textContent
                       });
                       line.classList.add('search-match');
                       highlightMatches(line, query);
                   } else if (!isMatch) {
                       line.classList.remove('search-match');
                       removeHighlights(line);
                   }
               });

               return {
                   matches: searchResults,
                   total: totalElements
               };
           }

           function checkRowMatch(row, query) {
               let searchText = '';
               
               if (searchState.searchInPaths) {
                   const pathCell = row.querySelector('td:nth-child(2)');
                   if (pathCell) searchText += pathCell.textContent + ' ';
               }
               
               if (searchState.searchInValues) {
                   const oldValueCell = row.querySelector('td:nth-child(4)');
                   const newValueCell = row.querySelector('td:nth-child(5)');
                   if (oldValueCell) searchText += oldValueCell.textContent + ' ';
                   if (newValueCell) searchText += newValueCell.textContent + ' ';
               }
               
               if (searchState.searchInTypes) {
                   const typeCell = row.querySelector('td:nth-child(1)');
                   if (typeCell) searchText += typeCell.textContent + ' ';
               }

               return performTextMatch(searchText, query);
           }

           function checkLineMatch(line, query) {
               const searchText = line.textContent;
               return performTextMatch(searchText, query);
           }

           function performTextMatch(text, query) {
               if (!text || !query) return false;

               if (searchState.regexMode) {
                   try {
                       const flags = searchState.caseSensitive ? 'g' : 'gi';
                       const regex = new RegExp(query, flags);
                       return regex.test(text);
                   } catch (error) {
                       return false;
                   }
               } else {
                   const searchText = searchState.caseSensitive ? text : text.toLowerCase();
                   const searchQuery = searchState.caseSensitive ? query : query.toLowerCase();
                   return searchText.includes(searchQuery);
               }
           }

           function highlightMatches(element, query) {
               if (!query || searchState.regexMode) return; // Skip highlighting for regex searches
               
               const walker = document.createTreeWalker(
                   element,
                   NodeFilter.SHOW_TEXT,
                   null,
                   false
               );

               const textNodes = [];
               let node;
               while (node = walker.nextNode()) {
                   textNodes.push(node);
               }

               textNodes.forEach(textNode => {
                   const text = textNode.textContent;
                   const searchText = searchState.caseSensitive ? text : text.toLowerCase();
                   const searchQuery = searchState.caseSensitive ? query : query.toLowerCase();
                   
                   if (searchText.includes(searchQuery)) {
                       const parent = textNode.parentNode;
                       const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), searchState.caseSensitive ? 'g' : 'gi');
                       const highlightedText = text.replace(regex, '<span class="search-highlight">$&</span>');
                       
                       if (highlightedText !== text) {
                           const span = document.createElement('span');
                           span.innerHTML = highlightedText;
                           parent.replaceChild(span, textNode);
                       }
                   }
               });
           }

           function removeHighlights(element) {
               const highlights = element.querySelectorAll('.search-highlight');
               highlights.forEach(highlight => {
                   const parent = highlight.parentNode;
                   parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
                   parent.normalize(); // Merge adjacent text nodes
               });
           }

           function displaySearchResults(results) {
               const searchStats = document.getElementById('searchStats');
               const matchCount = results.matches.length;
               const totalCount = results.total;

               if (searchStats) {
                   searchStats.style.display = 'block';
                   searchStats.innerHTML = `üìä –ó–Ω–∞–π–¥–µ–Ω–æ: ${matchCount} –∑ ${totalCount} —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤`;
                   
                   if (matchCount === 0) {
                       searchStats.innerHTML += ' - —Å–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –∑–∞–ø–∏—Ç';
                       searchStats.style.borderLeftColor = 'var(--red)';
                   } else {
                       searchStats.style.borderLeftColor = 'var(--accent-color)';
                   }
               }

               // Show/hide non-matching elements
               const allElements = document.querySelectorAll('[data-diff-index], .diff-line');
               allElements.forEach(element => {
                   const isMatch = results.matches.some(match => match.element === element);
                   if (matchCount > 0) {
                       element.style.display = isMatch ? '' : 'none';
                   } else {
                       element.style.display = '';
                   }
               });

               // Scroll to first match
               if (results.matches.length > 0) {
                   setTimeout(() => {
                       results.matches[0].element.scrollIntoView({ 
                           behavior: 'smooth', 
                           block: 'center' 
                       });
                   }, 100);
               }
           }

           function clearSearchResults() {
               const searchInput = document.getElementById('searchInput');
               const searchStats = document.getElementById('searchStats');
               
               if (searchInput) searchInput.value = '';
               if (searchStats) searchStats.style.display = 'none';

               // Remove all highlights and show all elements
               const allElements = document.querySelectorAll('[data-diff-index], .diff-line');
               allElements.forEach(element => {
                   element.style.display = '';
                   element.classList.remove('search-match');
                   removeHighlights(element);
               });

               searchState.query = '';
           }

           function getRowContent(row) {
               const cells = row.querySelectorAll('td');
               return Array.from(cells).map(cell => cell.textContent).join(' ');
           }

           function debounce(func, wait) {
               let timeout;
               return function executedFunction(...args) {
                   const later = () => {
                       clearTimeout(timeout);
                       func(...args);
                   };
                   clearTimeout(timeout);
                   timeout = setTimeout(later, wait);
                               };
            }

            // Real-time JSON Editor Implementation
            function initializeRealtimeJsonEditor() {
                const textareas = ['sourceText', 'targetText', 'schemaText'];
                
                textareas.forEach(textareaId => {
                    const textarea = document.getElementById(textareaId);
                    if (textarea) {
                        enhanceTextareaWithRealtimeFeatures(textarea);
                    }
                });
            }

            function enhanceTextareaWithRealtimeFeatures(textarea) {
                const container = textarea.parentElement;
                
                // Wrap textarea in editor container
                const editorContainer = document.createElement('div');
                editorContainer.className = 'json-editor-container';
                
                // Move textarea inside container
                container.insertBefore(editorContainer, textarea);
                editorContainer.appendChild(textarea);
                
                // Add validation status element
                const validationStatus = document.createElement('div');
                validationStatus.className = 'json-validation-status empty';
                validationStatus.innerHTML = 'üìù –ì–æ—Ç–æ–≤–∏–π –¥–æ –≤–≤–µ–¥–µ–Ω–Ω—è';
                editorContainer.appendChild(validationStatus);
                
                // Add character count
                const charCount = document.createElement('div');
                charCount.className = 'json-char-count';
                charCount.textContent = '0 —Å–∏–º–≤–æ–ª—ñ–≤';
                editorContainer.appendChild(charCount);
                
                // Add auto-save indicator
                const autoSaveIndicator = document.createElement('div');
                autoSaveIndicator.className = 'auto-save-indicator';
                autoSaveIndicator.textContent = 'üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–æ';
                editorContainer.appendChild(autoSaveIndicator);
                
                // Set up real-time validation
                let validationTimeout;
                let autoSaveTimeout;
                
                textarea.addEventListener('input', function() {
                    const content = textarea.value;
                    
                    // Update character count
                    updateCharacterCount(charCount, content);
                    
                    // Clear previous validation timeout
                    clearTimeout(validationTimeout);
                    
                    // Debounced validation
                    validationTimeout = setTimeout(() => {
                        validateJsonRealtime(content, validationStatus);
                    }, 300);
                    
                    // Auto-save functionality
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        autoSaveContent(textarea.id, content, autoSaveIndicator);
                    }, 1000);
                });
                
                // Load saved content on page load
                loadAutoSavedContent(textarea);
                
                // Initial validation
                const initialContent = textarea.value;
                if (initialContent) {
                    updateCharacterCount(charCount, initialContent);
                    validateJsonRealtime(initialContent, validationStatus);
                }
            }

            function updateCharacterCount(charCountElement, content) {
                const charCount = content.length;
                const lineCount = content.split('\n').length;
                charCountElement.textContent = `${charCount} —Å–∏–º–≤–æ–ª—ñ–≤, ${lineCount} —Ä—è–¥–∫—ñ–≤`;
                
                // Color coding based on length
                if (charCount > 10000) {
                    charCountElement.style.color = 'var(--red)';
                } else if (charCount > 5000) {
                    charCountElement.style.color = 'var(--orange)';
                } else {
                    charCountElement.style.color = 'var(--text-muted)';
                }
            }

            function validateJsonRealtime(content, statusElement) {
                if (!content.trim()) {
                    statusElement.className = 'json-validation-status empty';
                    statusElement.innerHTML = 'üìù –ì–æ—Ç–æ–≤–∏–π –¥–æ –≤–≤–µ–¥–µ–Ω–Ω—è';
                    return;
                }

                try {
                    const parsed = JSON.parse(content);
                    const objectInfo = getJsonObjectInfo(parsed);
                    
                    statusElement.className = 'json-validation-status valid';
                    statusElement.innerHTML = `‚úÖ –í–∞–ª—ñ–¥–Ω–∏–π JSON - ${objectInfo}`;
                    
                } catch (error) {
                    statusElement.className = 'json-validation-status invalid';
                    
                    const errorInfo = getDetailedJsonError(error, content);
                    statusElement.innerHTML = `‚ùå ${errorInfo}`;
                }
            }

            function getJsonObjectInfo(obj) {
                if (Array.isArray(obj)) {
                    return `–ú–∞—Å–∏–≤ –∑ ${obj.length} –µ–ª–µ–º–µ–Ω—Ç—ñ–≤`;
                } else if (typeof obj === 'object' && obj !== null) {
                    const keys = Object.keys(obj);
                    return `–û–±'—î–∫—Ç –∑ ${keys.length} –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—è–º–∏`;
                } else {
                    return `–ü—Ä–∏–º—ñ—Ç–∏–≤: ${typeof obj}`;
                }
            }

            function getDetailedJsonError(error, content) {
                let errorMessage = error.message;
                
                // Try to extract line and column information
                const lineMatch = errorMessage.match(/line (\d+)/i);
                const columnMatch = errorMessage.match(/column (\d+)/i);
                const positionMatch = errorMessage.match(/position (\d+)/i);
                
                if (positionMatch) {
                    const position = parseInt(positionMatch[1]);
                    const lines = content.substring(0, position).split('\n');
                    const line = lines.length;
                    const column = lines[lines.length - 1].length + 1;
                    
                    return `–ü–æ–º–∏–ª–∫–∞ –≤ —Ä—è–¥–∫—É ${line}, –ø–æ–∑–∏—Ü—ñ—è ${column}: ${errorMessage}`;
                } else if (lineMatch && columnMatch) {
                    return `–ü–æ–º–∏–ª–∫–∞ –≤ —Ä—è–¥–∫—É ${lineMatch[1]}, –ø–æ–∑–∏—Ü—ñ—è ${columnMatch[1]}: ${errorMessage}`;
                } else {
                    // Common error types
                    if (errorMessage.includes('Unexpected token')) {
                        return `–ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∏–π —Å–∏–º–≤–æ–ª: ${errorMessage}`;
                    } else if (errorMessage.includes('Unexpected end')) {
                        return `–ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–π JSON: –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥—É–∂–∫–∏ —Ç–∞ –∫–æ–º–∏`;
                    } else {
                        return `–°–∏–Ω—Ç–∞–∫—Å–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: ${errorMessage}`;
                    }
                }
            }

            function autoSaveContent(textareaId, content, indicator) {
                try {
                    const key = `json_editor_autosave_${textareaId}`;
                    const saveData = {
                        content: content,
                        timestamp: Date.now(),
                        textareaId: textareaId
                    };
                    
                    localStorage.setItem(key, JSON.stringify(saveData));
                    
                    // Show save indicator
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 1500);
                    
                } catch (error) {
                    console.warn('Auto-save failed:', error);
                }
            }

            function loadAutoSavedContent(textarea) {
                try {
                    const key = `json_editor_autosave_${textarea.id}`;
                    const savedData = localStorage.getItem(key);
                    
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        
                        // Only load if content is empty and save is recent (within 24 hours)
                        const isRecent = Date.now() - data.timestamp < 24 * 60 * 60 * 1000;
                        
                        if (!textarea.value.trim() && isRecent && data.content) {
                            textarea.value = data.content;
                            
                            // Show notification
                            showToast(`üìÅ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∞–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–ª—è ${getTextareaDisplayName(textarea.id)}`, 'info');
                            
                            // Trigger input event to update validation
                            textarea.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }
                } catch (error) {
                    console.warn('Auto-load failed:', error);
                }
            }

            function getTextareaDisplayName(textareaId) {
                const names = {
                    'sourceText': 'Source JSON',
                    'targetText': 'Target JSON',
                    'schemaText': 'JSON Schema'
                };
                return names[textareaId] || textareaId;
            }

            // Enhanced JSON formatting with better error handling
            function formatJsonWithErrorRecovery(content) {
                try {
                    const parsed = JSON.parse(content);
                    return JSON.stringify(parsed, null, 2);
                } catch (error) {
                    // Try to fix common issues and reparse
                    let fixedContent = content;
                    
                    // Remove trailing commas
                    fixedContent = fixedContent.replace(/,(\s*[}\]])/g, '$1');
                    
                    // Add missing quotes to keys
                    fixedContent = fixedContent.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g, '$1"$2":');
                    
                    try {
                        const parsed = JSON.parse(fixedContent);
                        return JSON.stringify(parsed, null, 2);
                    } catch (secondError) {
                        throw error; // Return original error
                    }
                }
            }

            // Add keyboard shortcuts for JSON editor
            document.addEventListener('keydown', function(e) {
                const activeElement = document.activeElement;
                
                if (activeElement && (activeElement.id === 'sourceText' || activeElement.id === 'targetText' || activeElement.id === 'schemaText')) {
                    // Ctrl/Cmd + Shift + F for format
                    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'F') {
                        e.preventDefault();
                        beautifyJSON(activeElement);
                    }
                    
                    // Ctrl/Cmd + Shift + M for minify
                    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'M') {
                        e.preventDefault();
                        minifyJSON(activeElement);
                    }
                    
                    // Ctrl/Cmd + Shift + V for validate
                    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'V') {
                        e.preventDefault();
                        validateJSON(activeElement);
                    }
                }
            });

            // Clear auto-saved content when explicitly cleared
            function clearAutoSavedContent(textareaId) {
                const key = `json_editor_autosave_${textareaId}`;
                localStorage.removeItem(key);
            }

                         // Modify existing clear function to also clear auto-saved content
             const originalClearAll = clearAllBtn?.onclick;
             if (clearAllBtn) {
                 clearAllBtn.addEventListener('click', () => {
                     ['sourceText', 'targetText', 'schemaText'].forEach(id => {
                         clearAutoSavedContent(id);
                     });
                 });
             }

             // Analytics Charts Cleanup
             function cleanupAnalyticsCharts() {
                 if (typeof analyticsCharts === 'object' && analyticsCharts) {
                     Object.keys(analyticsCharts).forEach(chartKey => {
                         if (analyticsCharts[chartKey] && typeof analyticsCharts[chartKey].destroy === 'function') {
                             try {
                                 analyticsCharts[chartKey].destroy();
                                 console.log(`Chart ${chartKey} destroyed successfully`);
                             } catch (error) {
                                 console.warn(`Failed to destroy chart ${chartKey}:`, error);
                             }
                         }
                         delete analyticsCharts[chartKey];
                     });
                 }
             }

             // Enhanced chart creation with better error handling
             function createChartSafely(canvasId, chartConfig, chartKey) {
                 if (typeof Chart === 'undefined') {
                     console.warn('Chart.js is not loaded');
                     return null;
                 }

                 const canvas = document.getElementById(canvasId);
                 if (!canvas) {
                     console.warn(`Canvas with id ${canvasId} not found`);
                     return null;
                 }

                 try {
                     // Cleanup existing chart if it exists
                     if (analyticsCharts[chartKey]) {
                         analyticsCharts[chartKey].destroy();
                     }

                     const chart = new Chart(canvas, chartConfig);
                     analyticsCharts[chartKey] = chart;
                     return chart;
                 } catch (error) {
                     console.error(`Failed to create chart ${chartKey}:`, error);
                     return null;
                 }
             }

             // Chart resize handler
             function setupChartResizeHandlers() {
                 window.addEventListener('resize', debounce(() => {
                     Object.values(analyticsCharts).forEach(chart => {
                         if (chart && typeof chart.resize === 'function') {
                             chart.resize();
                         }
                     });
                 }, 250));
             }

             // Initialize chart functionality
             if (typeof Chart !== 'undefined') {
                 setupChartResizeHandlers();
                 console.log('üìä Chart.js integration initialized');
             } else {
                 console.warn('‚ö†Ô∏è Chart.js not available - charts will be disabled');
             }

             // AJV Diagnostics functionality
             initializeAjvDiagnostics();

             function initializeAjvDiagnostics() {
                 const ajvDiagnosticsBtn = document.getElementById('ajvDiagnosticsBtn');
                 
                 if (ajvDiagnosticsBtn) {
                     ajvDiagnosticsBtn.addEventListener('click', showAjvDiagnostics);
                 }

                 // Show diagnostics button if there are AJV issues
                 setInterval(() => {
                     const hasIssues = window.AjvLoadError || window.AjvEmergencyMode || !isAjvAvailable();
                     if (ajvDiagnosticsBtn) {
                         ajvDiagnosticsBtn.style.display = hasIssues ? 'inline-block' : 'none';
                     }
                 }, 2000);
             }

             function showAjvDiagnostics() {
                 const modal = document.createElement('div');
                 modal.className = 'modal-overlay';
                 modal.innerHTML = `
                     <div class="modal-content">
                         <div class="modal-header">
                             <h2>üîß AJV –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>
                             <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                         </div>
                         <div class="modal-body">
                             <div style="margin-bottom: 20px;">
                                 <h3>üîç –°—Ç–∞–Ω —Å–∏—Å—Ç–µ–º–∏</h3>
                                 <div class="diagnostics-info">
                                     <div class="diagnostic-item">
                                         <span class="diagnostic-label">AJV Core:</span>
                                         <span class="diagnostic-status ${typeof Ajv !== 'undefined' ? 'success' : 'error'}">
                                             ${typeof Ajv !== 'undefined' ? '‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ' : '‚ùå –ù–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ'}
                                         </span>
                                     </div>
                                     <div class="diagnostic-item">
                                         <span class="diagnostic-label">Emergency Mode:</span>
                                         <span class="diagnostic-status ${window.AjvEmergencyMode ? 'warning' : 'success'}">
                                             ${window.AjvEmergencyMode ? '‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω–∏–π' : '‚úÖ –ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π'}
                                         </span>
                                     </div>
                                     <div class="diagnostic-item">
                                         <span class="diagnostic-label">Load Errors:</span>
                                         <span class="diagnostic-status ${window.AjvLoadError ? 'error' : 'success'}">
                                             ${window.AjvLoadError ? '‚ùå –Ñ –ø–æ–º–∏–ª–∫–∏' : '‚úÖ –ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫'}
                                         </span>
                                     </div>
                                     <div class="diagnostic-item">
                                         <span class="diagnostic-label">AJV Formats:</span>
                                         <span class="diagnostic-status ${typeof addFormats !== 'undefined' ? 'success' : 'warning'}">
                                             ${typeof addFormats !== 'undefined' ? '‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ' : '‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ'}
                                         </span>
                                     </div>
                                     <div class="diagnostic-item">
                                         <span class="diagnostic-label">AJV Keywords:</span>
                                         <span class="diagnostic-status ${typeof addKeywords !== 'undefined' ? 'success' : 'warning'}">
                                             ${typeof addKeywords !== 'undefined' ? '‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ' : '‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ'}
                                         </span>
                                     </div>
                                     <div class="diagnostic-item">
                                         <span class="diagnostic-label">–°–ø—Ä–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:</span>
                                         <span class="diagnostic-status">${ajvLoadAttempts}/${maxAjvAttempts}</span>
                                     </div>
                                 </div>
                             </div>
                             
                             <div style="margin-bottom: 20px;">
                                 <h3>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h3>
                                 <div class="recommendations">
                                     ${getAjvRecommendations()}
                                 </div>
                             </div>
                             
                             <div style="margin-bottom: 20px;">
                                 <h3>üîß –î—ñ—ó</h3>
                                 <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                     <button onclick="retryAjvLoad(); this.closest('.modal-overlay').remove();" class="action-btn">
                                         üîÑ –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ AJV
                                     </button>
                                     <button onclick="testNetworkAccess()" class="action-btn">
                                         üåê –¢–µ—Å—Ç –º–µ—Ä–µ–∂—ñ
                                     </button>
                                     <button onclick="showAjvDebugInfo()" class="action-btn">
                                         üêõ Debug —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
                                     </button>
                                     <button onclick="downloadAjvManually()" class="action-btn">
                                         üì• –†—É—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                                     </button>
                                 </div>
                             </div>
                         </div>
                     </div>
                 `;

                 // Add styles for diagnostics
                 const style = document.createElement('style');
                 style.textContent = `
                     .diagnostics-info { background: var(--bg-color); padding: 15px; border-radius: 6px; }
                     .diagnostic-item { display: flex; justify-content: space-between; margin: 8px 0; }
                     .diagnostic-label { font-weight: 600; }
                     .diagnostic-status.success { color: var(--green); }
                     .diagnostic-status.warning { color: #ffc107; }
                     .diagnostic-status.error { color: var(--red); }
                     .recommendations { background: var(--main-color); padding: 12px; border-radius: 6px; border-left: 4px solid var(--accent-color); }
                 `;
                 document.head.appendChild(style);
                 
                 document.body.appendChild(modal);
                 modal.style.display = 'flex';
             }

             function getAjvRecommendations() {
                 const recommendations = [];
                 
                 if (window.AjvLoadError) {
                     recommendations.push('üîí –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –Ω–µ –±–ª–æ–∫—É—î –≤–∞—à –∞–Ω—Ç–∏–≤—ñ—Ä—É—Å/–±—Ä–∞–Ω–¥–º–∞—É–µ—Ä CDN —Å–∞–π—Ç–∏');
                     recommendations.push('üè¢ –Ø–∫—â–æ –≤–∏ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ñ–π –º–µ—Ä–µ–∂—ñ, –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ IT-–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                     recommendations.push('üåê –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑\'—î–¥–Ω–∞–Ω–Ω—è —Ç–∞ –¥–æ—Å—Ç—É–ø –¥–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤');
                 }
                 
                 if (window.AjvEmergencyMode) {
                     recommendations.push('‚ö†Ô∏è –ü–æ—Ç–æ—á–Ω–∏–π —Ä–µ–∂–∏–º –ø—ñ–¥—Ç—Ä–∏–º—É—î –ª–∏—à–µ –±–∞–∑–æ–≤—É –≤–∞–ª—ñ–¥–∞—Ü—ñ—é');
                     recommendations.push('üîÑ –°–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É');
                 }
                 
                 if (typeof addFormats === 'undefined') {
                     recommendations.push('üìß –†–æ–∑—à–∏—Ä–µ–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏ (email, URL) –º–æ–∂—É—Ç—å –±—É—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ');
                 }
                 
                 if (recommendations.length === 0) {
                     recommendations.push('‚úÖ –í—Å–µ –ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ!');
                 }
                 
                 return recommendations.map(rec => `<div style="margin: 6px 0;">‚Ä¢ ${rec}</div>`).join('');
             }

             function testNetworkAccess() {
                 showToast('üåê –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ CDN...', 'info');
                 
                 const testUrls = [
                     'https://cdnjs.cloudflare.com/ajax/libs/ajv/8.17.1/ajv.min.js',
                     'https://unpkg.com/ajv@8.17.1/package.json',
                     'https://cdn.jsdelivr.net/npm/ajv@8.17.1/package.json'
                 ];
                 
                 const results = [];
                 let completed = 0;
                 
                 testUrls.forEach((url, index) => {
                     fetch(url, { method: 'HEAD', mode: 'no-cors' })
                         .then(() => {
                             results[index] = '‚úÖ';
                         })
                         .catch(() => {
                             results[index] = '‚ùå';
                         })
                         .finally(() => {
                             completed++;
                             if (completed === testUrls.length) {
                                 const message = `CDN —Ç–µ—Å—Ç: ${results.join(' ')} ${results.filter(r => r === '‚úÖ').length}/${testUrls.length} –¥–æ—Å—Ç—É–ø–Ω—ñ`;
                                 showToast(message, results.includes('‚úÖ') ? 'success' : 'error');
                             }
                         });
                 });
             }

             function showAjvDebugInfo() {
                 const debugInfo = {
                     userAgent: navigator.userAgent,
                     cookiesEnabled: navigator.cookieEnabled,
                     onLine: navigator.onLine,
                     ajvType: typeof Ajv,
                     ajvVersion: window.Ajv?.version || 'N/A',
                     emergencyMode: window.AjvEmergencyMode,
                     loadError: window.AjvLoadError,
                     loadAttempts: ajvLoadAttempts,
                     extensionsLoaded: window.AjvExtensionsLoaded,
                     currentTime: new Date().toISOString()
                 };
                 
                 console.table(debugInfo);
                 navigator.clipboard.writeText(JSON.stringify(debugInfo, null, 2))
                     .then(() => showToast('üêõ Debug —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É', 'success'))
                     .catch(() => showToast('–í—ñ–¥–∫—Ä–∏–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É debug —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó', 'info'));
             }

             function downloadAjvManually() {
                 const links = [
                     { name: 'AJV Core', url: 'https://unpkg.com/ajv@8.17.1/dist/ajv.bundle.js' },
                     { name: 'AJV Formats', url: 'https://unpkg.com/ajv-formats@2.1.1/dist/ajv-formats.min.js' },
                     { name: 'AJV Keywords', url: 'https://unpkg.com/ajv-keywords@5.1.0/dist/ajv-keywords.min.js' }
                 ];
                 
                 showToast('üì• –°–ø–∏—Å–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É', 'info');
                 
                 const downloadText = '–†—É—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AJV –±—ñ–±–ª—ñ–æ—Ç–µ–∫:\n\n' + 
                     links.map(link => `${link.name}: ${link.url}`).join('\n');
                 
                 navigator.clipboard.writeText(downloadText)
                     .catch(() => {
                         // Fallback - show as alert
                         alert(downloadText);
                     });
             }

             // Settings Templates Implementation
             const TEMPLATES_KEY = 'jsonComparatorTemplates';
             let settingsTemplates = {};

             // Predefined templates
             const predefinedTemplates = {
                 'default': {
                     name: 'üè† –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º',
                     description: '–ë–∞–∑–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è',
                     settings: {
                         ignorePaths: [],
                         arrayCompareMode: 'key',
                         caseSensitive: true,
                         aiAutoAnalyze: false,
                         aiAnalyzeSummary: true,
                         aiAnalyzeImpact: true,
                         aiAnalyzeRisks: true,
                         aiAnalyzeRecommendations: true,
                         aiAnalyzeCategories: false
                     }
                 },
                 'api-comparison': {
                     name: 'üîå API –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è',
                     description: '–û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è API –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π',
                     settings: {
                         ignorePaths: ['$.timestamp', '$.requestId', '$.version', '$.serverTime'],
                         arrayCompareMode: 'key',
                         caseSensitive: false,
                         aiAutoAnalyze: true,
                         aiAnalyzeSummary: true,
                         aiAnalyzeImpact: true,
                         aiAnalyzeRisks: true,
                         aiAnalyzeRecommendations: true,
                         aiAnalyzeCategories: true
                     }
                 },
                 'config-files': {
                     name: '‚öôÔ∏è –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ —Ñ–∞–π–ª–∏',
                     description: '–î–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤',
                     settings: {
                         ignorePaths: ['$.lastModified', '$.created', '$.metadata.timestamp'],
                         arrayCompareMode: 'index',
                         caseSensitive: true,
                         aiAutoAnalyze: false,
                         aiAnalyzeSummary: true,
                         aiAnalyzeImpact: true,
                         aiAnalyzeRisks: true,
                         aiAnalyzeRecommendations: true,
                         aiAnalyzeCategories: false
                     }
                 },
                 'strict-validation': {
                     name: 'üîí –°—Ç—Ä–æ–≥–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è',
                     description: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å—Ç—Ä–æ–≥—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è',
                     settings: {
                         ignorePaths: [],
                         arrayCompareMode: 'index',
                         caseSensitive: true,
                         aiAutoAnalyze: true,
                         aiAnalyzeSummary: true,
                         aiAnalyzeImpact: true,
                         aiAnalyzeRisks: true,
                         aiAnalyzeRecommendations: true,
                         aiAnalyzeCategories: true
                     }
                 },
                 'loose-comparison': {
                     name: 'üîì –ú\'—è–∫–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è',
                     description: '–ó–Ω–µ—Ö—Ç—É—î –¥—Ä—ñ–±–Ω–∏–º–∏ –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç—è–º–∏',
                     settings: {
                         ignorePaths: ['$.id', '$.timestamp', '$.created', '$.updated', '$.version', '$.lastModified'],
                         arrayCompareMode: 'key',
                         caseSensitive: false,
                         aiAutoAnalyze: false,
                         aiAnalyzeSummary: true,
                         aiAnalyzeImpact: false,
                         aiAnalyzeRisks: false,
                         aiAnalyzeRecommendations: true,
                         aiAnalyzeCategories: false
                     }
                 }
             };

             function initializeSettingsTemplates() {
                 loadSavedTemplates();
                 setupTemplateEventListeners();
                 populateTemplatesDropdown();
             }

             function loadSavedTemplates() {
                 try {
                     const saved = localStorage.getItem(TEMPLATES_KEY);
                     settingsTemplates = saved ? JSON.parse(saved) : {};
                 } catch (error) {
                     console.error('Failed to load templates:', error);
                     settingsTemplates = {};
                 }
             }

             function setupTemplateEventListeners() {
                 const loadTemplateBtn = document.getElementById('loadTemplate');
                 const saveTemplateBtn = document.getElementById('saveTemplate');
                 const deleteTemplateBtn = document.getElementById('deleteTemplate');
                 const templatesSelect = document.getElementById('settingsTemplates');

                 if (loadTemplateBtn) {
                     loadTemplateBtn.addEventListener('click', loadSelectedTemplate);
                 }

                 if (saveTemplateBtn) {
                     saveTemplateBtn.addEventListener('click', saveCurrentTemplate);
                 }

                 if (deleteTemplateBtn) {
                     deleteTemplateBtn.addEventListener('click', deleteSelectedTemplate);
                 }

                 if (templatesSelect) {
                     templatesSelect.addEventListener('change', updateTemplateButtons);
                 }
             }

             function populateTemplatesDropdown() {
                 const select = document.getElementById('settingsTemplates');
                 if (!select) return;

                 // Clear existing custom options
                 const options = Array.from(select.options);
                 options.forEach((option, index) => {
                     if (index > 5) { // Keep first 6 predefined options
                         option.remove();
                     }
                 });

                 // Add custom templates
                 Object.keys(settingsTemplates).forEach(templateId => {
                     const template = settingsTemplates[templateId];
                     const option = document.createElement('option');
                     option.value = `custom:${templateId}`;
                     option.textContent = `üë§ ${template.name}`;
                     select.appendChild(option);
                 });
             }

             function getCurrentSettings() {
                 const ignorePathsField = document.getElementById('ignorePaths');
                 const arrayCompareMode = document.querySelector('input[name="arrayCompareMode"]:checked')?.value || 'key';
                 const caseSensitive = document.getElementById('caseSensitive')?.checked || true;

                 // AI settings
                 const aiAutoAnalyze = document.getElementById('aiAutoAnalyze')?.checked || false;
                 const aiAnalyzeSummary = document.getElementById('aiAnalyzeSummary')?.checked !== false;
                 const aiAnalyzeImpact = document.getElementById('aiAnalyzeImpact')?.checked !== false;
                 const aiAnalyzeRisks = document.getElementById('aiAnalyzeRisks')?.checked !== false;
                 const aiAnalyzeRecommendations = document.getElementById('aiAnalyzeRecommendations')?.checked !== false;
                 const aiAnalyzeCategories = document.getElementById('aiAnalyzeCategories')?.checked || false;

                 return {
                     ignorePaths: ignorePathsField ? ignorePathsField.value.split('\n').filter(path => path.trim()) : [],
                     arrayCompareMode,
                     caseSensitive,
                     aiAutoAnalyze,
                     aiAnalyzeSummary,
                     aiAnalyzeImpact,
                     aiAnalyzeRisks,
                     aiAnalyzeRecommendations,
                     aiAnalyzeCategories
                 };
             }

             function applySettings(settings) {
                 const ignorePathsField = document.getElementById('ignorePaths');
                 const caseSensitiveField = document.getElementById('caseSensitive');

                 if (ignorePathsField) {
                     ignorePathsField.value = settings.ignorePaths.join('\n');
                 }

                 // Array compare mode
                 const arrayModeRadio = document.querySelector(`input[name="arrayCompareMode"][value="${settings.arrayCompareMode}"]`);
                 if (arrayModeRadio) {
                     arrayModeRadio.checked = true;
                 }

                 if (caseSensitiveField) {
                     caseSensitiveField.checked = settings.caseSensitive;
                 }

                 // Apply AI settings
                 const aiFields = {
                     'aiAutoAnalyze': settings.aiAutoAnalyze,
                     'aiAnalyzeSummary': settings.aiAnalyzeSummary,
                     'aiAnalyzeImpact': settings.aiAnalyzeImpact,
                     'aiAnalyzeRisks': settings.aiAnalyzeRisks,
                     'aiAnalyzeRecommendations': settings.aiAnalyzeRecommendations,
                     'aiAnalyzeCategories': settings.aiAnalyzeCategories
                 };

                 Object.entries(aiFields).forEach(([fieldId, value]) => {
                     const field = document.getElementById(fieldId);
                     if (field) {
                         field.checked = value;
                     }
                 });
             }

             function loadSelectedTemplate() {
                 const select = document.getElementById('settingsTemplates');
                 const selectedValue = select?.value;

                 if (!selectedValue) {
                     showToast('–û–±–µ—Ä—ñ—Ç—å —à–∞–±–ª–æ–Ω –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è', 'warning');
                     return;
                 }

                 let template;
                 if (selectedValue.startsWith('custom:')) {
                     const templateId = selectedValue.replace('custom:', '');
                     template = settingsTemplates[templateId];
                 } else {
                     template = predefinedTemplates[selectedValue];
                 }

                 if (template) {
                     applySettings(template.settings);
                     showToast(`‚úÖ –®–∞–±–ª–æ–Ω "${template.name}" –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ`, 'success');
                 } else {
                     showToast('–®–∞–±–ª–æ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                 }
             }

             function saveCurrentTemplate() {
                 const nameField = document.getElementById('newTemplateName');
                 const templateName = nameField?.value?.trim();

                 if (!templateName) {
                     showToast('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —à–∞–±–ª–æ–Ω—É', 'warning');
                     return;
                 }

                 const currentSettings = getCurrentSettings();
                 const templateId = Date.now().toString();

                 settingsTemplates[templateId] = {
                     name: templateName,
                     description: `–°—Ç–≤–æ—Ä–µ–Ω–æ ${new Date().toLocaleDateString('uk-UA')}`,
                     settings: currentSettings,
                     created: new Date().toISOString()
                 };

                 try {
                     localStorage.setItem(TEMPLATES_KEY, JSON.stringify(settingsTemplates));
                     populateTemplatesDropdown();
                     
                     // Clear name field and select new template
                     nameField.value = '';
                     const select = document.getElementById('settingsTemplates');
                     if (select) {
                         select.value = `custom:${templateId}`;
                     }
                     
                     showToast(`üíæ –®–∞–±–ª–æ–Ω "${templateName}" –∑–±–µ—Ä–µ–∂–µ–Ω–æ`, 'success');
                 } catch (error) {
                     console.error('Failed to save template:', error);
                     showToast('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É', 'error');
                 }
             }

             function deleteSelectedTemplate() {
                 const select = document.getElementById('settingsTemplates');
                 const selectedValue = select?.value;

                 if (!selectedValue || !selectedValue.startsWith('custom:')) {
                     showToast('–û–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π —à–∞–±–ª–æ–Ω –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è', 'warning');
                     return;
                 }

                 const templateId = selectedValue.replace('custom:', '');
                 const template = settingsTemplates[templateId];

                 if (!template) {
                     showToast('–®–∞–±–ª–æ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                     return;
                 }

                 if (confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —à–∞–±–ª–æ–Ω "${template.name}"?`)) {
                     delete settingsTemplates[templateId];
                     
                     try {
                         localStorage.setItem(TEMPLATES_KEY, JSON.stringify(settingsTemplates));
                         populateTemplatesDropdown();
                         
                         // Reset selection
                         select.value = '';
                         
                         showToast(`üóëÔ∏è –®–∞–±–ª–æ–Ω "${template.name}" –≤–∏–¥–∞–ª–µ–Ω–æ`, 'success');
                     } catch (error) {
                         console.error('Failed to delete template:', error);
                         showToast('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—É', 'error');
                     }
                 }
             }

             function updateTemplateButtons() {
                 const select = document.getElementById('settingsTemplates');
                 const deleteBtn = document.getElementById('deleteTemplate');
                 const selectedValue = select?.value;

                 // Enable delete button only for custom templates
                 if (deleteBtn) {
                     deleteBtn.disabled = !selectedValue || !selectedValue.startsWith('custom:');
                     deleteBtn.style.opacity = deleteBtn.disabled ? '0.5' : '1';
                 }
             }

             // Export/Import templates functionality
             function exportTemplates() {
                 const exportData = {
                     version: '1.0',
                     exportDate: new Date().toISOString(),
                     templates: settingsTemplates
                 };

                 const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `json-comparator-templates-${new Date().toISOString().split('T')[0]}.json`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);

                 showToast(`üìÅ –®–∞–±–ª–æ–Ω–∏ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ (${Object.keys(settingsTemplates).length} —à—Ç.)`, 'success');
             }

             // Initial template buttons state
             setTimeout(() => {
                 updateTemplateButtons();
             }, 100);

             // Batch Processing Implementation
             let batchFiles = [];
             let batchResults = [];

             function initializeBatchProcessing() {
                 const batchBtn = document.getElementById('batchProcessingBtn');
                 if (batchBtn) {
                     batchBtn.addEventListener('click', openBatchProcessingModal);
                 }
             }

             function openBatchProcessingModal() {
                 const modal = document.createElement('div');
                 modal.className = 'modal-overlay batch-processing-modal';
                 modal.innerHTML = `
                     <div class="modal-content">
                         <div class="modal-header">
                             <h2>üìÅ Batch Processing - –ú–∞—Å–æ–≤–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤</h2>
                             <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                         </div>
                         <div class="modal-body">
                             <div class="batch-upload-zone" id="batchUploadZone">
                                 <div style="font-size: 3em; margin-bottom: 10px;">üìÅ</div>
                                 <h3>–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª–∏ —Å—é–¥–∏ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É</h3>
                                 <p style="color: var(--text-muted); margin: 10px 0;">
                                     –ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è JSON —Ñ–∞–π–ª–∏. –ú–æ–∂–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–æ 20 —Ñ–∞–π–ª—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ.
                                 </p>
                                 <input type="file" id="batchFileInput" multiple accept=".json,.txt" style="display: none;">
                                 <button onclick="document.getElementById('batchFileInput').click()" class="action-btn">
                                     üìé –û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª–∏
                                 </button>
                             </div>
                             
                             <div class="batch-file-list" id="batchFileList" style="display: none;">
                                 <!-- Files will be listed here -->
                             </div>
                             
                             <div class="batch-progress" id="batchProgress">
                                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                     <span id="batchProgressText">–ì–æ—Ç–æ–≤–∏–π –¥–æ –æ–±—Ä–æ–±–∫–∏</span>
                                     <span id="batchProgressPercent">0%</span>
                                 </div>
                                 <div class="batch-progress-bar">
                                     <div class="batch-progress-fill" id="batchProgressFill"></div>
                                 </div>
                             </div>
                             
                             <div class="batch-results" id="batchResults" style="display: none;">
                                 <!-- Results will be shown here -->
                             </div>
                         </div>
                         <div class="modal-footer">
                             <button id="clearBatchFiles" class="action-btn" style="background: var(--red);">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
                             <button id="startBatchProcessing" class="action-btn" disabled>üöÄ –ü–æ—á–∞—Ç–∏ –æ–±—Ä–æ–±–∫—É</button>
                             <button id="exportBatchResults" class="action-btn" style="display: none;">üíæ –ï–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</button>
                         </div>
                     </div>
                 `;

                 document.body.appendChild(modal);
                 modal.style.display = 'flex';

                 // Initialize batch processing functionality
                 setupBatchEventListeners();
             }

             function setupBatchEventListeners() {
                 const uploadZone = document.getElementById('batchUploadZone');
                 const fileInput = document.getElementById('batchFileInput');
                 const clearBtn = document.getElementById('clearBatchFiles');
                 const startBtn = document.getElementById('startBatchProcessing');
                 const exportBtn = document.getElementById('exportBatchResults');

                 // File upload events
                 uploadZone.addEventListener('click', () => fileInput.click());
                 fileInput.addEventListener('change', handleBatchFileSelection);

                 // Drag and drop
                 uploadZone.addEventListener('dragover', (e) => {
                     e.preventDefault();
                     uploadZone.classList.add('drag-over');
                 });
                 uploadZone.addEventListener('dragleave', () => {
                     uploadZone.classList.remove('drag-over');
                 });
                 uploadZone.addEventListener('drop', (e) => {
                     e.preventDefault();
                     uploadZone.classList.remove('drag-over');
                     handleBatchFileDrop(e);
                 });

                 // Control buttons
                 clearBtn.addEventListener('click', clearBatchFiles);
                 startBtn.addEventListener('click', startBatchProcessing);
                 exportBtn.addEventListener('click', exportBatchResults);
             }

             function handleBatchFileSelection(event) {
                 const files = Array.from(event.target.files);
                 addFilesToBatch(files);
             }

             function handleBatchFileDrop(event) {
                 const files = Array.from(event.dataTransfer.files);
                 addFilesToBatch(files);
             }

             function addFilesToBatch(files) {
                 const jsonFiles = files.filter(file => 
                     file.type === 'application/json' || 
                     file.name.toLowerCase().endsWith('.json') ||
                     file.name.toLowerCase().endsWith('.txt')
                 );

                 if (jsonFiles.length === 0) {
                     showToast('‚ùå –û–±–µ—Ä—ñ—Ç—å JSON —Ñ–∞–π–ª–∏', 'error');
                     return;
                 }

                 if (batchFiles.length + jsonFiles.length > 20) {
                     showToast('‚ùå –ú–∞–∫—Å–∏–º—É–º 20 —Ñ–∞–π–ª—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ', 'error');
                     return;
                 }

                 jsonFiles.forEach(file => {
                     const fileId = Date.now() + Math.random();
                     const batchFile = {
                         id: fileId,
                         file: file,
                         name: file.name,
                         size: file.size,
                         content: null,
                         valid: null,
                         error: null
                     };

                     batchFiles.push(batchFile);
                     readBatchFile(batchFile);
                 });

                 updateBatchFileList();
                 showToast(`‚úÖ –î–æ–¥–∞–Ω–æ ${jsonFiles.length} —Ñ–∞–π–ª—ñ–≤`, 'success');
             }

             function readBatchFile(batchFile) {
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     try {
                         const content = e.target.result;
                         JSON.parse(content); // Validate JSON
                         batchFile.content = content;
                         batchFile.valid = true;
                     } catch (error) {
                         batchFile.valid = false;
                         batchFile.error = error.message;
                     }
                     updateBatchFileList();
                 };
                 reader.onerror = () => {
                     batchFile.valid = false;
                     batchFile.error = '–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É';
                     updateBatchFileList();
                 };
                 reader.readAsText(batchFile.file);
             }

             function updateBatchFileList() {
                 const fileList = document.getElementById('batchFileList');
                 const startBtn = document.getElementById('startBatchProcessing');

                 if (batchFiles.length === 0) {
                     fileList.style.display = 'none';
                     startBtn.disabled = true;
                     return;
                 }

                 fileList.style.display = 'block';
                 fileList.innerHTML = batchFiles.map(file => `
                     <div class="batch-file-item">
                         <div class="batch-file-info">
                             <div class="batch-file-name">
                                 ${file.valid === true ? '‚úÖ' : file.valid === false ? '‚ùå' : '‚è≥'} ${file.name}
                             </div>
                             <div class="batch-file-meta">
                                 ${formatFileSize(file.size)} ‚Ä¢ ${file.valid === true ? '–í–∞–ª—ñ–¥–Ω–∏–π JSON' : file.valid === false ? file.error : '–û–±—Ä–æ–±–ª—è—î—Ç—å—Å—è...'}
                             </div>
                         </div>
                         <div class="batch-file-actions">
                             <button onclick="removeBatchFile('${file.id}')" class="formatter-btn delete" style="padding: 4px 8px;">üóëÔ∏è</button>
                         </div>
                     </div>
                 `).join('');

                 // Enable start button if at least 2 valid files
                 const validFiles = batchFiles.filter(f => f.valid === true);
                 startBtn.disabled = validFiles.length < 2;
             }

             function removeBatchFile(fileId) {
                 batchFiles = batchFiles.filter(f => f.id != fileId);
                 updateBatchFileList();
             }

             function clearBatchFiles() {
                 batchFiles = [];
                 batchResults = [];
                 updateBatchFileList();
                 
                 const results = document.getElementById('batchResults');
                 const exportBtn = document.getElementById('exportBatchResults');
                 const progress = document.getElementById('batchProgress');
                 
                 results.style.display = 'none';
                 exportBtn.style.display = 'none';
                 progress.style.display = 'none';
                 
                 showToast('üóëÔ∏è –§–∞–π–ª–∏ –æ—á–∏—â–µ–Ω–æ', 'info');
             }

             async function startBatchProcessing() {
                 const validFiles = batchFiles.filter(f => f.valid === true);
                 if (validFiles.length < 2) {
                     showToast('‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–æ –º—ñ–Ω—ñ–º—É–º 2 –≤–∞–ª—ñ–¥–Ω–∏—Ö —Ñ–∞–π–ª–∏', 'error');
                     return;
                 }

                 const progress = document.getElementById('batchProgress');
                 const progressText = document.getElementById('batchProgressText');
                 const progressPercent = document.getElementById('batchProgressPercent');
                 const progressFill = document.getElementById('batchProgressFill');
                 const results = document.getElementById('batchResults');
                 const exportBtn = document.getElementById('exportBatchResults');

                 progress.style.display = 'block';
                 batchResults = [];

                 // Compare each file with every other file
                 const comparisons = [];
                 for (let i = 0; i < validFiles.length; i++) {
                     for (let j = i + 1; j < validFiles.length; j++) {
                         comparisons.push({
                             sourceFile: validFiles[i],
                             targetFile: validFiles[j]
                         });
                     }
                 }

                 const totalComparisons = comparisons.length;
                 let completed = 0;

                 showToast(`üöÄ –ü–æ—á–∏–Ω–∞—î–º–æ ${totalComparisons} –ø–æ—Ä—ñ–≤–Ω—è–Ω—å...`, 'info');

                 for (const comparison of comparisons) {
                     progressText.textContent = `–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è: ${comparison.sourceFile.name} ‚Üî ${comparison.targetFile.name}`;
                     
                     try {
                         const sourceJson = JSON.parse(comparison.sourceFile.content);
                         const targetJson = JSON.parse(comparison.targetFile.content);
                         
                         const differences = findDifferences(sourceJson, targetJson);
                         
                         batchResults.push({
                             id: Date.now() + Math.random(),
                             sourceFile: comparison.sourceFile.name,
                             targetFile: comparison.targetFile.name,
                             differences: differences,
                             summary: generateBatchSummary(differences),
                             timestamp: new Date().toISOString()
                         });
                         
                     } catch (error) {
                         batchResults.push({
                             id: Date.now() + Math.random(),
                             sourceFile: comparison.sourceFile.name,
                             targetFile: comparison.targetFile.name,
                             error: error.message,
                             timestamp: new Date().toISOString()
                         });
                     }

                     completed++;
                     const percentage = Math.round((completed / totalComparisons) * 100);
                     progressPercent.textContent = `${percentage}%`;
                     progressFill.style.width = `${percentage}%`;

                     // Small delay to show progress
                     await new Promise(resolve => setTimeout(resolve, 100));
                 }

                 progressText.textContent = '–û–±—Ä–æ–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                 displayBatchResults();
                 results.style.display = 'block';
                 exportBtn.style.display = 'inline-block';
                 
                 showToast(`‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ ${totalComparisons} –ø–æ—Ä—ñ–≤–Ω—è–Ω—å`, 'success');
             }

             function generateBatchSummary(differences) {
                 if (!differences || differences.length === 0) {
                     return '–í—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                 }

                 const types = {};
                 differences.forEach(diff => {
                     types[diff.type] = (types[diff.type] || 0) + 1;
                 });

                 const summary = Object.entries(types)
                     .map(([type, count]) => `${type}: ${count}`)
                     .join(', ');

                 return `${differences.length} –∑–º—ñ–Ω (${summary})`;
             }

             function displayBatchResults() {
                 const resultsContainer = document.getElementById('batchResults');
                 
                 // Calculate summary statistics
                 const totalComparisons = batchResults.length;
                 const totalDifferences = batchResults.reduce((sum, result) => 
                     sum + (result.differences ? result.differences.length : 0), 0);
                 const errorCount = batchResults.filter(result => result.error).length;
                 const identicalCount = batchResults.filter(result => 
                     result.differences && result.differences.length === 0).length;

                 resultsContainer.innerHTML = `
                     <div class="batch-summary">
                         <h3 style="margin-bottom: 16px; color: var(--header-color);">üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                         <div class="batch-summary-grid">
                             <div class="batch-summary-item">
                                 <div class="batch-summary-value">${totalComparisons}</div>
                                 <div class="batch-summary-label">–ü–æ—Ä—ñ–≤–Ω—è–Ω—å</div>
                             </div>
                             <div class="batch-summary-item">
                                 <div class="batch-summary-value">${totalDifferences}</div>
                                 <div class="batch-summary-label">–í—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π</div>
                             </div>
                             <div class="batch-summary-item">
                                 <div class="batch-summary-value">${identicalCount}</div>
                                 <div class="batch-summary-label">–Ü–¥–µ–Ω—Ç–∏—á–Ω–∏—Ö</div>
                             </div>
                             <div class="batch-summary-item">
                                 <div class="batch-summary-value">${errorCount}</div>
                                 <div class="batch-summary-label">–ü–æ–º–∏–ª–æ–∫</div>
                             </div>
                         </div>
                     </div>
                     
                     <h3 style="margin-bottom: 16px; color: var(--header-color);">üìã –î–µ—Ç–∞–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏</h3>
                     ${batchResults.map(result => `
                         <div class="batch-result-item">
                             <div class="batch-result-header" onclick="toggleBatchResult('${result.id}')">
                                 <span>
                                     ${result.error ? '‚ùå' : result.differences && result.differences.length === 0 ? '‚úÖ' : 'üîç'} 
                                     ${result.sourceFile} ‚Üî ${result.targetFile}
                                 </span>
                                 <span>${result.error ? '–ü–æ–º–∏–ª–∫–∞' : result.summary}</span>
                             </div>
                             <div class="batch-result-content" id="result-${result.id}">
                                 ${result.error ? 
                                     `<div style="color: var(--red);">–ü–æ–º–∏–ª–∫–∞: ${result.error}</div>` :
                                     renderBatchResultDetails(result)
                                 }
                             </div>
                         </div>
                     `).join('')}
                 `;
             }

             function renderBatchResultDetails(result) {
                 if (!result.differences || result.differences.length === 0) {
                     return '<div style="color: var(--green); text-align: center; padding: 20px;">‚úÖ –§–∞–π–ª–∏ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ</div>';
                 }

                 const importanceGroups = {
                     critical: result.differences.filter(d => getImportanceLevel(d) === 'critical'),
                     high: result.differences.filter(d => getImportanceLevel(d) === 'high'),
                     medium: result.differences.filter(d => getImportanceLevel(d) === 'medium'),
                     low: result.differences.filter(d => getImportanceLevel(d) === 'low')
                 };

                 return `
                     <div style="margin-bottom: 16px;">
                         <strong>–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ –≤–∞–∂–ª–∏–≤—ñ—Å—Ç—é:</strong><br>
                         üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ñ: ${importanceGroups.critical.length} ‚Ä¢ 
                         üü° –í–∏—Å–æ–∫—ñ: ${importanceGroups.high.length} ‚Ä¢ 
                         üü¢ –°–µ—Ä–µ–¥–Ω—ñ: ${importanceGroups.medium.length} ‚Ä¢ 
                         ‚ö™ –ù–∏–∑—å–∫—ñ: ${importanceGroups.low.length}
                     </div>
                     <div style="max-height: 200px; overflow-y: auto;">
                         ${result.differences.slice(0, 10).map(diff => `
                             <div style="margin: 8px 0; padding: 8px; background: var(--bg-color); border-radius: 4px;">
                                 <strong>${diff.type}</strong> –≤ <code>${diff.path}</code><br>
                                 <span style="color: var(--text-muted); font-size: 0.9em;">
                                     ${diff.oldValue || 'N/A'} ‚Üí ${diff.newValue || 'N/A'}
                                 </span>
                             </div>
                         `).join('')}
                         ${result.differences.length > 10 ? 
                             `<div style="text-align: center; color: var(--text-muted); margin-top: 10px;">
                                 ... —Ç–∞ —â–µ ${result.differences.length - 10} –≤—ñ–¥–º—ñ–Ω–Ω–æ—Å—Ç–µ–π
                             </div>` : ''}
                     </div>
                 `;
             }

             function toggleBatchResult(resultId) {
                 const content = document.getElementById(`result-${resultId}`);
                 content.classList.toggle('expanded');
             }

             function exportBatchResults() {
                 if (batchResults.length === 0) {
                     showToast('‚ùå –ù–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É', 'error');
                     return;
                 }

                 const exportData = {
                     timestamp: new Date().toISOString(),
                     totalComparisons: batchResults.length,
                     results: batchResults.map(result => ({
                         sourceFile: result.sourceFile,
                         targetFile: result.targetFile,
                         summary: result.summary,
                         differenceCount: result.differences ? result.differences.length : 0,
                         differences: result.differences || [],
                         error: result.error,
                         timestamp: result.timestamp
                     }))
                 };

                 const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `batch-comparison-${new Date().toISOString().split('T')[0]}.json`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);

                 showToast(`üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ (${batchResults.length} –ø–æ—Ä—ñ–≤–Ω—è–Ω—å)`, 'success');
             }

             // AI Schema Generation Implementation
             function initializeAiSchemaGeneration() {
                 const schemaBtn = document.getElementById('aiSchemaGenerationBtn');
                 if (schemaBtn) {
                     schemaBtn.addEventListener('click', openAiSchemaGenerationModal);
                 }
             }

             function openAiSchemaGenerationModal() {
                 // Check if AI is available
                 if (!aiSettings.apiKey) {
                     showToast('‚ö†Ô∏è –ù–∞–ª–∞—à—Ç—É–π—Ç–µ Gemini AI API –∫–ª—é—á –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å—Ö–µ–º', 'warning');
                     return;
                 }

                 const modal = document.createElement('div');
                 modal.className = 'modal-overlay schema-generation-modal';
                 modal.innerHTML = `
                     <div class="modal-content">
                         <div class="modal-header">
                             <h2>üß† AI Schema Generation - –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è JSON Schema</h2>
                             <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                         </div>
                         <div class="modal-body">
                             <div class="schema-input-section">
                                 <h3 style="margin-bottom: 12px;">üìÑ –í—Ö—ñ–¥–Ω–∏–π JSON</h3>
                                 <p style="color: var(--text-muted); margin-bottom: 16px;">
                                     –í—Å—Ç–∞–≤—Ç–µ –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å JSON, –¥–ª—è —è–∫–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Å—Ö–µ–º—É
                                 </p>
                                 <textarea id="schemaJsonInput" class="schema-json-input" 
                                           placeholder="–í–≤–µ–¥—ñ—Ç—å –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ JSON..."></textarea>
                                 <div style="margin-top: 10px; display: flex; gap: 10px;">
                                     <button onclick="loadFromSource()" class="action-btn">üì• –ó Source</button>
                                     <button onclick="loadFromTarget()" class="action-btn">üì• –ó Target</button>
                                     <button onclick="validateSchemaInput()" class="action-btn">‚úÖ –í–∞–ª—ñ–¥—É–≤–∞—Ç–∏</button>
                                     <button onclick="beautifySchemaInput()" class="action-btn">‚ú® –§–æ—Ä–º–∞—Ç—É–≤–∞—Ç–∏</button>
                                 </div>
                             </div>

                             <div class="schema-options">
                                 <div class="schema-option-group">
                                     <div class="schema-option-title">
                                         üéØ –¢–∏–ø —Å—Ö–µ–º–∏
                                     </div>
                                     <div class="schema-checkbox-list">
                                         <div class="schema-checkbox-item">
                                             <input type="radio" id="schemaDraft7" name="schemaDraft" value="draft-07" checked>
                                             <label for="schemaDraft7">JSON Schema Draft 07</label>
                                         </div>
                                         <div class="schema-checkbox-item">
                                             <input type="radio" id="schemaDraft2019" name="schemaDraft" value="draft/2019-09">
                                             <label for="schemaDraft2019">JSON Schema Draft 2019-09</label>
                                         </div>
                                         <div class="schema-checkbox-item">
                                             <input type="radio" id="schemaDraft2020" name="schemaDraft" value="draft/2020-12">
                                             <label for="schemaDraft2020">JSON Schema Draft 2020-12</label>
                                         </div>
                                     </div>
                                 </div>

                                 <div class="schema-option-group">
                                     <div class="schema-option-title">
                                         üîß –û–ø—Ü—ñ—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
                                     </div>
                                     <div class="schema-checkbox-list">
                                         <div class="schema-checkbox-item">
                                             <input type="checkbox" id="schemaRequired" checked>
                                             <label for="schemaRequired">–û–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è</label>
                                         </div>
                                         <div class="schema-checkbox-item">
                                             <input type="checkbox" id="schemaDescriptions" checked>
                                             <label for="schemaDescriptions">–û–ø–∏—Å–∏ –ø–æ–ª—ñ–≤</label>
                                         </div>
                                         <div class="schema-checkbox-item">
                                             <input type="checkbox" id="schemaExamples" checked>
                                             <label for="schemaExamples">–ü—Ä–∏–∫–ª–∞–¥–∏ –∑–Ω–∞—á–µ–Ω—å</label>
                                         </div>
                                         <div class="schema-checkbox-item">
                                             <input type="checkbox" id="schemaFormats">
                                             <label for="schemaFormats">–§–æ—Ä–º–∞—Ç–∏ (email, date)</label>
                                         </div>
                                     </div>
                                 </div>

                                 <div class="schema-option-group">
                                     <div class="schema-option-title">
                                         üìè –û–±–º–µ–∂–µ–Ω–Ω—è
                                     </div>
                                     <div class="schema-checkbox-list">
                                         <div class="schema-checkbox-item">
                                             <input type="checkbox" id="schemaStringLimits">
                                             <label for="schemaStringLimits">–î–æ–≤–∂–∏–Ω–∞ —Ä—è–¥–∫—ñ–≤</label>
                                         </div>
                                         <div class="schema-checkbox-item">
                                             <input type="checkbox" id="schemaNumberLimits">
                                             <label for="schemaNumberLimits">–î—ñ–∞–ø–∞–∑–æ–Ω–∏ —á–∏—Å–µ–ª</label>
                                         </div>
                                         <div class="schema-checkbox-item">
                                             <input type="checkbox" id="schemaArrayLimits">
                                             <label for="schemaArrayLimits">–†–æ–∑–º—ñ—Ä–∏ –º–∞—Å–∏–≤—ñ–≤</label>
                                         </div>
                                         <div class="schema-checkbox-item">
                                             <input type="checkbox" id="schemaAdditionalProps">
                                             <label for="schemaAdditionalProps">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ</label>
                                         </div>
                                     </div>
                                 </div>
                             </div>

                             <div class="schema-generation-progress" id="schemaProgress">
                                 <div class="schema-loading-spinner"></div>
                                 <div id="schemaProgressText">–ì–µ–Ω–µ—Ä—É–≤–∞–Ω–Ω—è —Å—Ö–µ–º–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é AI...</div>
                             </div>

                             <div class="schema-output" id="schemaOutput" style="display: none;">
                                 <div class="schema-output-header">
                                     <span>üìã –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∞ JSON Schema</span>
                                     <div>
                                         <span class="schema-quality-indicator excellent" id="schemaQuality">
                                             ‚ú® –í—ñ–¥–º—ñ–Ω–Ω–∞ —è–∫—ñ—Å—Ç—å
                                         </span>
                                         <button onclick="copySchemaToClipboard()" class="formatter-btn beautify" style="margin-left: 10px;">
                                             üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏
                                         </button>
                                         <button onclick="saveSchemaToFile()" class="formatter-btn beautify">
                                             üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
                                         </button>
                                         <button onclick="useGeneratedSchema()" class="formatter-btn beautify">
                                             üéØ –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏
                                         </button>
                                     </div>
                                 </div>
                                 <div class="schema-output-content" id="schemaOutputContent">
                                     <!-- Generated schema will appear here -->
                                 </div>
                             </div>
                         </div>
                         <div class="modal-footer">
                             <button onclick="clearSchemaInput()" class="action-btn" style="background: var(--red);">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
                             <button onclick="generateSchema()" id="generateSchemaBtn" class="action-btn" disabled>üß† –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Å—Ö–µ–º—É</button>
                         </div>
                     </div>
                 `;

                 document.body.appendChild(modal);
                 modal.style.display = 'flex';

                 // Setup event listeners
                 setupSchemaGenerationListeners();
             }

             function setupSchemaGenerationListeners() {
                 const input = document.getElementById('schemaJsonInput');
                 const generateBtn = document.getElementById('generateSchemaBtn');

                 input.addEventListener('input', () => {
                     const hasContent = input.value.trim().length > 0;
                     generateBtn.disabled = !hasContent;
                 });
             }

             function loadFromSource() {
                 const sourceText = document.getElementById('sourceText');
                 const input = document.getElementById('schemaJsonInput');
                 if (sourceText && sourceText.value) {
                     input.value = sourceText.value;
                     document.getElementById('generateSchemaBtn').disabled = false;
                     showToast('üì• JSON –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ Source –ø–æ–ª—è', 'success');
                 } else {
                     showToast('‚ùå Source –ø–æ–ª–µ –ø—É—Å—Ç–µ', 'warning');
                 }
             }

             function loadFromTarget() {
                 const targetText = document.getElementById('targetText');
                 const input = document.getElementById('schemaJsonInput');
                 if (targetText && targetText.value) {
                     input.value = targetText.value;
                     document.getElementById('generateSchemaBtn').disabled = false;
                     showToast('üì• JSON –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ Target –ø–æ–ª—è', 'success');
                 } else {
                     showToast('‚ùå Target –ø–æ–ª–µ –ø—É—Å—Ç–µ', 'warning');
                 }
             }

             function validateSchemaInput() {
                 const input = document.getElementById('schemaJsonInput');
                 try {
                     JSON.parse(input.value);
                     showToast('‚úÖ JSON –≤–∞–ª—ñ–¥–Ω–∏–π', 'success');
                 } catch (error) {
                     showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞ JSON: ${error.message}`, 'error');
                 }
             }

             function beautifySchemaInput() {
                 const input = document.getElementById('schemaJsonInput');
                 try {
                     const parsed = JSON.parse(input.value);
                     input.value = JSON.stringify(parsed, null, 2);
                     showToast('‚ú® JSON –≤—ñ–¥—Ñ–æ—Ä–º–∞—Ç–æ–≤–∞–Ω–æ', 'success');
                 } catch (error) {
                     showToast(`‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞—Ç–∏: ${error.message}`, 'error');
                 }
             }

             function clearSchemaInput() {
                 document.getElementById('schemaJsonInput').value = '';
                 document.getElementById('generateSchemaBtn').disabled = true;
                 document.getElementById('schemaOutput').style.display = 'none';
                 showToast('üóëÔ∏è –ü–æ–ª–µ –æ—á–∏—â–µ–Ω–æ', 'info');
             }

             async function generateSchema() {
                 const input = document.getElementById('schemaJsonInput');
                 const progress = document.getElementById('schemaProgress');
                 const output = document.getElementById('schemaOutput');

                 try {
                     const jsonData = JSON.parse(input.value);
                 } catch (error) {
                     showToast(`‚ùå –ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON: ${error.message}`, 'error');
                     return;
                 }

                 progress.style.display = 'block';
                 output.style.display = 'none';

                 try {
                     const schemaOptions = getSchemaOptions();
                     const prompt = createSchemaGenerationPrompt(input.value, schemaOptions);
                     
                     const result = await callGeminiAI(prompt, []);
                     
                     if (result.success) {
                         displayGeneratedSchema(result.analysis, schemaOptions);
                         showToast('üß† –°—Ö–µ–º—É —É—Å–ø—ñ—à–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ', 'success');
                     } else {
                         throw new Error(result.error || '–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å—Ö–µ–º–∏');
                     }
                 } catch (error) {
                     console.error('Schema generation error:', error);
                     showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó: ${error.message}`, 'error');
                 } finally {
                     progress.style.display = 'none';
                 }
             }

             function getSchemaOptions() {
                 return {
                     draft: document.querySelector('input[name="schemaDraft"]:checked')?.value || 'draft-07',
                     required: document.getElementById('schemaRequired')?.checked || false,
                     descriptions: document.getElementById('schemaDescriptions')?.checked || false,
                     examples: document.getElementById('schemaExamples')?.checked || false,
                     formats: document.getElementById('schemaFormats')?.checked || false,
                     stringLimits: document.getElementById('schemaStringLimits')?.checked || false,
                     numberLimits: document.getElementById('schemaNumberLimits')?.checked || false,
                     arrayLimits: document.getElementById('schemaArrayLimits')?.checked || false,
                     additionalProps: document.getElementById('schemaAdditionalProps')?.checked || false
                 };
             }

             function createSchemaGenerationPrompt(jsonData, options) {
                 const formatOptions = [];
                 if (options.required) formatOptions.push('–æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è (required)');
                 if (options.descriptions) formatOptions.push('–¥–µ—Ç–∞–ª—å–Ω—ñ –æ–ø–∏—Å–∏ –ø–æ–ª—ñ–≤');
                 if (options.examples) formatOptions.push('–ø—Ä–∏–∫–ª–∞–¥–∏ –∑–Ω–∞—á–µ–Ω—å');
                 if (options.formats) formatOptions.push('—Ñ–æ—Ä–º–∞—Ç–∏ (email, date, uri)');
                 if (options.stringLimits) formatOptions.push('–æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ–≤–∂–∏–Ω–∏ —Ä—è–¥–∫—ñ–≤');
                 if (options.numberLimits) formatOptions.push('–¥—ñ–∞–ø–∞–∑–æ–Ω–∏ —á–∏—Å–µ–ª');
                 if (options.arrayLimits) formatOptions.push('–æ–±–º–µ–∂–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—ñ–≤ –º–∞—Å–∏–≤—ñ–≤');
                 if (options.additionalProps) formatOptions.push('–¥–æ–∑–≤—ñ–ª –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π');

                 return `–¢–∏ –µ–∫—Å–ø–µ—Ä—Ç –∑ JSON Schema. –°—Ç–≤–æ—Ä–∏ –ø–æ–≤–Ω—É —Ç–∞ –¥–µ—Ç–∞–ª—å–Ω—É JSON Schema –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ JSON:

JSON –î–ê–ù–Ü:
${jsonData}

–í–ò–ú–û–ì–ò:
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π JSON Schema ${options.draft}
- –í–∫–ª—é—á–∏: ${formatOptions.join(', ')}
- –°—Ö–µ–º–∞ –º–∞—î –±—É—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ—é —Ç–∞ –∫–æ—Ä–∏—Å–Ω–æ—é
- –î–æ–¥–∞–π –≤–∞–ª—ñ–¥–∞—Ü—ñ—é —Ç–∞–º, –¥–µ —Ü–µ –¥–æ—Ä–µ—á–Ω–æ
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –æ–ø–∏—Å–∏ –¥–ª—è –∑—Ä–æ–∑—É–º—ñ–ª–æ—Å—Ç—ñ

–§–û–†–ú–ê–¢ –í–Ü–î–ü–û–í–Ü–î–Ü:
–ù–∞–¥–∞–π –ª–∏—à–µ –≤–∞–ª—ñ–¥–Ω–∏–π JSON Schema –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø–æ—è—Å–Ω–µ–Ω—å. –°—Ö–µ–º–∞ –ø–æ–≤–∏–Ω–Ω–∞ –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑ { —Ç–∞ –∑–∞–∫—ñ–Ω—á—É–≤–∞—Ç–∏—Å—è }

–ü–†–ò–ö–õ–ê–î –°–¢–†–£–ö–¢–£–†–ò:
{
  "$schema": "https://json-schema.org/${options.draft}/schema#",
  "type": "object",
  "title": "–ù–∞–∑–≤–∞ —Å—Ö–µ–º–∏",
  "description": "–û–ø–∏—Å —Å—Ö–µ–º–∏",
  "properties": {
    // –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ —Ç—É—Ç
  },
  "required": [/* –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è */],
  "additionalProperties": ${options.additionalProps}
}`;
             }

             function displayGeneratedSchema(schemaText, options) {
                 const output = document.getElementById('schemaOutput');
                 const content = document.getElementById('schemaOutputContent');
                 const quality = document.getElementById('schemaQuality');

                 try {
                     // Try to parse and beautify the schema
                     const schema = JSON.parse(schemaText);
                     const beautifiedSchema = JSON.stringify(schema, null, 2);
                     
                     content.textContent = beautifiedSchema;
                     
                     // Assess quality
                     const qualityScore = assessSchemaQuality(schema);
                     updateQualityIndicator(quality, qualityScore);
                     
                     output.style.display = 'block';
                     
                     // Store for later use
                     window.generatedSchema = schema;
                     
                 } catch (error) {
                     // If it's not valid JSON, display as-is
                     content.textContent = schemaText;
                     quality.textContent = '‚ö†Ô∏è –ü–æ—Ç—Ä–µ–±—É—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏';
                     quality.className = 'schema-quality-indicator good';
                     output.style.display = 'block';
                 }
             }

             function assessSchemaQuality(schema) {
                 let score = 0;
                 const checks = [
                     { condition: schema.$schema, points: 1, name: '$schema' },
                     { condition: schema.type, points: 1, name: 'type' },
                     { condition: schema.title, points: 1, name: 'title' },
                     { condition: schema.description, points: 1, name: 'description' },
                     { condition: schema.properties, points: 2, name: 'properties' },
                     { condition: schema.required && Array.isArray(schema.required), points: 1, name: 'required' },
                     { condition: typeof schema.additionalProperties !== 'undefined', points: 1, name: 'additionalProperties' }
                 ];

                 checks.forEach(check => {
                     if (check.condition) score += check.points;
                 });

                 return {
                     score: score,
                     maxScore: checks.reduce((sum, check) => sum + check.points, 0),
                     percentage: Math.round((score / checks.reduce((sum, check) => sum + check.points, 0)) * 100)
                 };
             }

             function updateQualityIndicator(element, quality) {
                 if (quality.percentage >= 85) {
                     element.className = 'schema-quality-indicator excellent';
                     element.innerHTML = `‚ú® –í—ñ–¥–º—ñ–Ω–Ω–∞ —è–∫—ñ—Å—Ç—å (${quality.percentage}%)`;
                 } else if (quality.percentage >= 70) {
                     element.className = 'schema-quality-indicator good';
                     element.innerHTML = `üëç –•–æ—Ä–æ—à–∞ —è–∫—ñ—Å—Ç—å (${quality.percentage}%)`;
                 } else {
                     element.className = 'schema-quality-indicator basic';
                     element.innerHTML = `‚ö†Ô∏è –ë–∞–∑–æ–≤–∞ —è–∫—ñ—Å—Ç—å (${quality.percentage}%)`;
                 }
             }

             function copySchemaToClipboard() {
                 const content = document.getElementById('schemaOutputContent');
                 navigator.clipboard.writeText(content.textContent)
                     .then(() => showToast('üìã –°—Ö–µ–º—É —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É', 'success'))
                     .catch(() => showToast('‚ùå –ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è', 'error'));
             }

             function saveSchemaToFile() {
                 const content = document.getElementById('schemaOutputContent');
                 const blob = new Blob([content.textContent], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `generated-schema-${new Date().toISOString().split('T')[0]}.json`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);
                 showToast('üíæ –°—Ö–µ–º—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É —Ñ–∞–π–ª', 'success');
             }

             function useGeneratedSchema() {
                 const content = document.getElementById('schemaOutputContent');
                 const schemaField = document.getElementById('schemaText');
                 
                 if (schemaField) {
                     schemaField.value = content.textContent;
                     showToast('üéØ –°—Ö–µ–º—É –¥–æ–¥–∞–Ω–æ –≤ –ø–æ–ª–µ Schema', 'success');
                     
                     // Close modal and switch to schema mode if needed
                     document.querySelector('.schema-generation-modal').remove();
                     
                     const schemaMode = document.querySelector('input[name="compareMode"][value="schema"]');
                     if (schemaMode) {
                         schemaMode.checked = true;
                         schemaMode.dispatchEvent(new Event('change', { bubbles: true }));
                     }
                 } else {
                                           showToast('‚ùå –ü–æ–ª–µ —Å—Ö–µ–º–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                  }
              }

              // Smart Ignore Rules Implementation
              let smartIgnoreRules = [];
              let predefinedIgnoreRules = {
                  temporal: [
                      { pattern: '*.timestamp', description: '–ß–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏' },
                      { pattern: '*.createdAt', description: '–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è' },
                      { pattern: '*.updatedAt', description: '–î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è' },
                      { pattern: '*.lastModified', description: '–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è' },
                      { pattern: '*.date', description: '–î–∞—Ç–∏' },
                      { pattern: '*.time', description: '–ß–∞—Å' }
                  ],
                  identifiers: [
                      { pattern: '*.id', description: '–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏' },
                      { pattern: '*.uuid', description: 'UUID' },
                      { pattern: '*.guid', description: 'GUID' },
                      { pattern: '*.hash', description: '–•–µ—à—ñ' },
                      { pattern: '*.token', description: '–¢–æ–∫–µ–Ω–∏' }
                  ],
                  metadata: [
                      { pattern: '*.version', description: '–í–µ—Ä—Å—ñ—ó' },
                      { pattern: '*.revision', description: '–†–µ–≤—ñ–∑—ñ—ó' },
                      { pattern: '*.etag', description: 'ETags' },
                      { pattern: '*.checksum', description: '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ñ —Å—É–º–∏' },
                      { pattern: '*.metadata.*', description: '–ú–µ—Ç–∞–¥–∞–Ω—ñ' }
                  ],
                  system: [
                      { pattern: '*.debug*', description: 'Debug —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è' },
                      { pattern: '*.trace*', description: 'Trace –¥–∞–Ω—ñ' },
                      { pattern: '*.log*', description: '–õ–æ–≥–∏' },
                      { pattern: '*.internal*', description: '–í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø–æ–ª—è' }
                  ],
                  security: [
                      { pattern: '*.password', description: '–ü–∞—Ä–æ–ª—ñ' },
                      { pattern: '*.secret', description: '–°–µ–∫—Ä–µ—Ç–∏' },
                      { pattern: '*.key', description: '–ö–ª—é—á—ñ' },
                      { pattern: '*.credentials*', description: '–û–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ' }
                  ]
              };

              function initializeSmartIgnoreRules() {
                  const smartIgnoreBtn = document.getElementById('smartIgnoreBtn');
                  if (smartIgnoreBtn) {
                      smartIgnoreBtn.addEventListener('click', openSmartIgnoreModal);
                  }
              }

              function openSmartIgnoreModal() {
                  const modal = document.createElement('div');
                  modal.className = 'modal-overlay smart-ignore-modal';
                  modal.innerHTML = `
                      <div class="modal-content">
                          <div class="modal-header">
                              <h2>üß© Smart Ignore Rules - –†–æ–∑—É–º–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è</h2>
                              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                          </div>
                          <div class="modal-body">
                              <div class="current-ignore-rules">
                                  <h3 style="margin-bottom: 12px;">üìã –ü–æ—Ç–æ—á–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è</h3>
                                  <div id="currentIgnoreRules">
                                      ${getCurrentIgnoreRulesHtml()}
                                  </div>
                                  <div style="margin-top: 12px;">
                                      <input type="text" id="customIgnoreRule" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–ª–∞—Å–Ω–µ –ø—Ä–∞–≤–∏–ª–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: *.timestamp)" 
                                             style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-right: 8px;">
                                      <button onclick="addCustomIgnoreRule()" class="action-btn">‚ûï –î–æ–¥–∞—Ç–∏</button>
                                  </div>
                              </div>

                              <div class="ignore-rules-container">
                                  <div class="ignore-rules-panel">
                                      <div class="ignore-rules-header">
                                          üè∑Ô∏è –ì–æ—Ç–æ–≤—ñ —à–∞–±–ª–æ–Ω–∏ –ø—Ä–∞–≤–∏–ª
                                      </div>
                                      <div class="ignore-rules-content">
                                          ${renderPredefinedRules()}
                                      </div>
                                  </div>
                                  
                                  <div class="ignore-rules-panel">
                                      <div class="ignore-rules-header">
                                          üß† AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
                                          <button onclick="generateAIIgnoreSuggestions()" class="ignore-rule-btn add" style="margin-left: auto;">
                                              üîç –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏
                                          </button>
                                      </div>
                                      <div class="ignore-rules-content" id="aiSuggestions">
                                          <div style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                                              –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏" –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π
                                          </div>
                                      </div>
                                  </div>
                              </div>

                              <div style="background: var(--bg-color); border-radius: 6px; padding: 16px; margin-top: 20px;">
                                  <h3 style="margin-bottom: 12px;">üìñ –î–æ–≤—ñ–¥–∫–∞ –ø–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É</h3>
                                  <div style="font-family: monospace; font-size: 0.9em; line-height: 1.6;">
                                      <div><strong>*.field</strong> - —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ –ø–æ–ª–µ "field" –Ω–∞ –≤—Å—ñ—Ö —Ä—ñ–≤–Ω—è—Ö</div>
                                      <div><strong>root.field</strong> - —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ –ø–æ–ª–µ "field" —Ç—ñ–ª—å–∫–∏ –Ω–∞ –∫–æ—Ä–µ–Ω–µ–≤–æ–º—É —Ä—ñ–≤–Ω—ñ</div>
                                      <div><strong>*.nested.*</strong> - —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ –≤—Å—ñ –ø–æ–ª—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ "nested"</div>
                                      <div><strong>array[*].field</strong> - —ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ –ø–æ–ª–µ "field" –≤ –µ–ª–µ–º–µ–Ω—Ç–∞—Ö –º–∞—Å–∏–≤—É</div>
                                      <div><strong>/regex/</strong> - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–∏–π –≤–∏—Ä–∞–∑</div>
                                  </div>
                              </div>
                          </div>
                          <div class="modal-footer">
                              <button onclick="clearAllIgnoreRules()" class="action-btn" style="background: var(--red);">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
                              <button onclick="exportIgnoreRules()" class="action-btn">üíæ –ï–∫—Å–ø–æ—Ä—Ç</button>
                              <button onclick="importIgnoreRules()" class="action-btn">üì• –Ü–º–ø–æ—Ä—Ç</button>
                              <button onclick="applyIgnoreRules()" class="action-btn">‚úÖ –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
                          </div>
                      </div>
                  `;

                  document.body.appendChild(modal);
                  modal.style.display = 'flex';

                  // Setup event listeners
                  setupSmartIgnoreListeners();
              }

              function setupSmartIgnoreListeners() {
                  const customInput = document.getElementById('customIgnoreRule');
                  customInput.addEventListener('keypress', (e) => {
                      if (e.key === 'Enter') {
                          addCustomIgnoreRule();
                      }
                  });
              }

              function getCurrentIgnoreRulesHtml() {
                  const currentRules = getIgnoreFieldsArray();
                  if (currentRules.length === 0) {
                      return '<div style="text-align: center; color: var(--text-muted); padding: 20px;">–ü—Ä–∞–≤–∏–ª —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</div>';
                  }

                  return currentRules.map(rule => `
                      <div class="current-rule-item">
                          <span class="ignore-rule-pattern">${rule}</span>
                          <button onclick="removeIgnoreRule('${rule}')" class="ignore-rule-btn remove">‚úñ</button>
                      </div>
                  `).join('');
              }

              function renderPredefinedRules() {
                  return Object.entries(predefinedIgnoreRules).map(([category, rules]) => `
                      <div class="ignore-category">
                          <div class="ignore-category-title">
                              ${getCategoryIcon(category)} ${getCategoryName(category)}
                          </div>
                          ${rules.map(rule => `
                              <div class="ignore-rule-item">
                                  <div class="ignore-rule-info">
                                      <div class="ignore-rule-pattern">${rule.pattern}</div>
                                      <div class="ignore-rule-description">${rule.description}</div>
                                  </div>
                                  <div class="ignore-rule-actions">
                                      <button onclick="addIgnoreRule('${rule.pattern}')" class="ignore-rule-btn add">‚ûï</button>
                                  </div>
                              </div>
                          `).join('')}
                      </div>
                  `).join('');
              }

              function getCategoryIcon(category) {
                  const icons = {
                      temporal: '‚è∞',
                      identifiers: 'üÜî',
                      metadata: 'üìã',
                      system: '‚öôÔ∏è',
                      security: 'üîí'
                  };
                  return icons[category] || 'üìÅ';
              }

              function getCategoryName(category) {
                  const names = {
                      temporal: '–ß–∞—Å–æ–≤—ñ –ø–æ–ª—è',
                      identifiers: '–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏',
                      metadata: '–ú–µ—Ç–∞–¥–∞–Ω—ñ',
                      system: '–°–∏—Å—Ç–µ–º–Ω—ñ –ø–æ–ª—è',
                      security: '–ë–µ–∑–ø–µ–∫–∞'
                  };
                  return names[category] || category;
              }

              function addIgnoreRule(pattern) {
                  const currentRules = getIgnoreFieldsArray();
                  if (!currentRules.includes(pattern)) {
                      currentRules.push(pattern);
                      updateIgnoreFieldsFromArray(currentRules);
                      updateCurrentIgnoreRulesDisplay();
                      showToast(`‚ûï –î–æ–¥–∞–Ω–æ –ø—Ä–∞–≤–∏–ª–æ: ${pattern}`, 'success');
                  } else {
                      showToast(`‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–æ –≤–∂–µ —ñ—Å–Ω—É—î: ${pattern}`, 'warning');
                  }
              }

              function removeIgnoreRule(pattern) {
                  const currentRules = getIgnoreFieldsArray();
                  const updatedRules = currentRules.filter(rule => rule !== pattern);
                  updateIgnoreFieldsFromArray(updatedRules);
                  updateCurrentIgnoreRulesDisplay();
                  showToast(`üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ: ${pattern}`, 'info');
              }

              function addCustomIgnoreRule() {
                  const input = document.getElementById('customIgnoreRule');
                  const pattern = input.value.trim();
                  
                  if (!pattern) {
                      showToast('‚ùå –í–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª–æ —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è', 'error');
                      return;
                  }

                  if (!isValidIgnorePattern(pattern)) {
                      showToast('‚ùå –ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∞–≤–∏–ª–∞', 'error');
                      return;
                  }

                  addIgnoreRule(pattern);
                  input.value = '';
              }

              function isValidIgnorePattern(pattern) {
                  // Basic validation for ignore patterns
                  const validPatterns = [
                      /^\*\.\w+$/,           // *.field
                      /^\w+\.\w+$/,          // root.field  
                      /^\*\.\w+\.\*$/,       // *.nested.*
                      /^\w+\[\*\]\.\w+$/,    // array[*].field
                      /^\/.*\/$/             // /regex/
                  ];

                  return validPatterns.some(regex => regex.test(pattern)) || pattern.includes('*') || pattern.includes('.');
              }

              function updateCurrentIgnoreRulesDisplay() {
                  const container = document.getElementById('currentIgnoreRules');
                  if (container) {
                      container.innerHTML = getCurrentIgnoreRulesHtml();
                  }
              }

              async function generateAIIgnoreSuggestions() {
                  const suggestionsContainer = document.getElementById('aiSuggestions');
                  
                  // Check if AI is available
                  if (!aiSettings.apiKey) {
                      suggestionsContainer.innerHTML = `
                          <div style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                              ‚ö†Ô∏è –ù–∞–ª–∞—à—Ç—É–π—Ç–µ Gemini AI API –∫–ª—é—á –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π
                          </div>
                      `;
                      return;
                  }

                  // Show loading
                  suggestionsContainer.innerHTML = `
                      <div style="text-align: center; padding: 40px 20px;">
                          <div class="schema-loading-spinner" style="margin: 0 auto 15px;"></div>
                          <div>–ê–Ω–∞–ª—ñ–∑—É—é JSON –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π...</div>
                      </div>
                  `;

                  try {
                      const sourceText = document.getElementById('sourceText')?.value || '';
                      const targetText = document.getElementById('targetText')?.value || '';
                      
                      if (!sourceText && !targetText) {
                          throw new Error('–ù–µ–º–∞—î JSON –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É');
                      }

                      const prompt = createIgnoreSuggestionsPrompt(sourceText, targetText);
                      const result = await callGeminiAI(prompt, []);

                      if (result.success) {
                          displayAISuggestions(result.analysis);
                      } else {
                          throw new Error(result.error || '–ü–æ–º–∏–ª–∫–∞ AI –∞–Ω–∞–ª—ñ–∑—É');
                      }
                  } catch (error) {
                      console.error('AI suggestions error:', error);
                      suggestionsContainer.innerHTML = `
                          <div style="text-align: center; color: var(--red); padding: 40px 20px;">
                              ‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}
                          </div>
                      `;
                  }
              }

              function createIgnoreSuggestionsPrompt(sourceText, targetText) {
                  return `–¢–∏ –µ–∫—Å–ø–µ—Ä—Ç –∑ –∞–Ω–∞–ª—ñ–∑—É JSON —Å—Ç—Ä—É–∫—Ç—É—Ä. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –Ω–∞—Å—Ç—É–ø–Ω—ñ JSON —Ñ–∞–π–ª–∏ —Ç–∞ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π —Ä–æ–∑—É–º–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è.

SOURCE JSON:
${sourceText}

TARGET JSON:
${targetText}

–ó–ê–í–î–ê–ù–ù–Ø:
–ó–∞–ø—Ä–æ–ø–æ–Ω—É–π 5-10 –Ω–∞–π–∫–æ—Ä–∏—Å–Ω—ñ—à–∏—Ö –ø—Ä–∞–≤–∏–ª —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –¥–ª—è —Ü–∏—Ö JSON —Ñ–∞–π–ª—ñ–≤. –í—Ä–∞—Ö–æ–≤—É–π:
- –ß–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏ (timestamp, createdAt, updatedAt)
- –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ (id, uuid, hash)
- –ú–µ—Ç–∞–¥–∞–Ω—ñ (version, etag, metadata)
- –ü–æ–ª—è —â–æ —á–∞—Å—Ç–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è
- –¢–µ—Ö–Ω—ñ—á–Ω—ñ –ø–æ–ª—è

–§–û–†–ú–ê–¢ –í–Ü–î–ü–û–í–Ü–î–Ü (—Ç—ñ–ª—å–∫–∏ JSON):
{
  "suggestions": [
    {
      "pattern": "*.timestamp",
      "description": "–Ü–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ —á–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏",
      "confidence": "high",
      "reason": "–ß–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏ –∑–∞–≤–∂–¥–∏ —Ä—ñ–∑–Ω—ñ –ø—Ä–∏ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—ñ"
    }
  ]
}

Confidence –º–æ–∂–µ –±—É—Ç–∏: "high", "medium", "low"
–ù–∞–¥–∞–π —Ç—ñ–ª—å–∫–∏ JSON –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø–æ—è—Å–Ω–µ–Ω—å.`;
              }

              function displayAISuggestions(aiResponse) {
                  const container = document.getElementById('aiSuggestions');
                  
                  try {
                      const suggestions = JSON.parse(aiResponse);
                      
                      if (!suggestions.suggestions || !Array.isArray(suggestions.suggestions)) {
                          throw new Error('–ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ AI');
                      }

                      if (suggestions.suggestions.length === 0) {
                          container.innerHTML = `
                              <div style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                                  ‚ú® AI –Ω–µ –∑–Ω–∞–π—à–æ–≤ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –¥–ª—è —Ü–∏—Ö JSON —Ñ–∞–π–ª—ñ–≤
                              </div>
                          `;
                          return;
                      }

                      container.innerHTML = `
                          <div class="ai-suggestions">
                              <h4 style="margin-bottom: 12px; color: var(--header-color);">üß† AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h4>
                              ${suggestions.suggestions.map(suggestion => `
                                  <div class="ai-suggestion-item">
                                      <div style="flex: 1;">
                                          <div class="ignore-rule-pattern">${suggestion.pattern}</div>
                                          <div class="ignore-rule-description">${suggestion.description}</div>
                                          <div style="font-size: 0.8em; color: var(--text-muted); margin-top: 4px;">
                                              üí° ${suggestion.reason}
                                          </div>
                                      </div>
                                      <div style="display: flex; align-items: center; gap: 8px;">
                                          <span class="confidence-indicator confidence-${suggestion.confidence}">
                                              ${getConfidenceIcon(suggestion.confidence)} ${suggestion.confidence}
                                          </span>
                                          <button onclick="addIgnoreRule('${suggestion.pattern}')" class="ignore-rule-btn add">‚ûï</button>
                                      </div>
                                  </div>
                              `).join('')}
                          </div>
                      `;
                  } catch (error) {
                      console.error('Error parsing AI suggestions:', error);
                      container.innerHTML = `
                          <div style="text-align: center; color: var(--red); padding: 40px 20px;">
                              ‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ AI –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                          </div>
                      `;
                  }
              }

              function getConfidenceIcon(confidence) {
                  const icons = {
                      high: 'üéØ',
                      medium: 'üëç',
                      low: 'üí≠'
                  };
                  return icons[confidence] || 'üí≠';
              }

              function clearAllIgnoreRules() {
                  if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –ø—Ä–∞–≤–∏–ª–∞ —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è?')) {
                      updateIgnoreFieldsFromArray([]);
                      updateCurrentIgnoreRulesDisplay();
                      showToast('üóëÔ∏è –í—Å—ñ –ø—Ä–∞–≤–∏–ª–∞ —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ', 'info');
                  }
              }

              function exportIgnoreRules() {
                  const rules = getIgnoreFieldsArray();
                  const exportData = {
                      timestamp: new Date().toISOString(),
                      rules: rules,
                      count: rules.length
                  };

                  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `ignore-rules-${new Date().toISOString().split('T')[0]}.json`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);

                  showToast(`üíæ –ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${rules.length} –ø—Ä–∞–≤–∏–ª`, 'success');
              }

              function importIgnoreRules() {
                  const input = document.createElement('input');
                  input.type = 'file';
                  input.accept = '.json';
                  input.onchange = (e) => {
                      const file = e.target.files[0];
                      if (file) {
                          const reader = new FileReader();
                          reader.onload = (e) => {
                              try {
                                  const importData = JSON.parse(e.target.result);
                                  if (importData.rules && Array.isArray(importData.rules)) {
                                      updateIgnoreFieldsFromArray(importData.rules);
                                      updateCurrentIgnoreRulesDisplay();
                                      showToast(`üì• –Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${importData.rules.length} –ø—Ä–∞–≤–∏–ª`, 'success');
                                  } else {
                                      throw new Error('–ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É');
                                  }
                              } catch (error) {
                                  showToast(`‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ${error.message}`, 'error');
                              }
                          };
                          reader.readAsText(file);
                      }
                  };
                  input.click();
              }

              function applyIgnoreRules() {
                  const rules = getIgnoreFieldsArray();
                  document.querySelector('.smart-ignore-modal').remove();
                  showToast(`‚úÖ –ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ ${rules.length} –ø—Ä–∞–≤–∏–ª —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è`, 'success');
                  
                  // Trigger comparison refresh if in comparison mode
                  if (document.querySelector('input[name="compareMode"]:checked')?.value === 'compare') {
                      setTimeout(() => {
                          const compareBtn = document.querySelector('[onclick="compareJSON()"]');
                          if (compareBtn) {
                              compareBtn.click();
                          }
                      }, 500);
                  }
              }
    </script>
</body>
</html>
